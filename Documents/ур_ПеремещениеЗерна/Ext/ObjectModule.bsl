////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

Перем мВалютаРегламентированногоУчета Экспорт;
Перем мИспользоватьОборотнуюНоменклатуру Экспорт;
Перем мРазделятьПоСтавкамНДС Экспорт;
Перем мУчетВПродажныхЦенах Экспорт;
// переменные для управления реквизитами налогового учета
Перем мУчетнаяПолитикаПоНалоговомуУчету Экспорт;
Перем мУчетнаяПолитикаПоБухгалтерскомуУчету Экспорт;

Перем мОтображатьСтруктурныеПодразделения Экспорт;

#Если Клиент Тогда

// Функция формирует табличный документ с печатной формой накладной,
// разработанной методистами
//
// Возвращаемое значение:
//  Табличный документ - печатная форма накладной
//
Функция ПечатьПеремещениеТоваров()

	ДопКолонка = Константы.ДополнительнаяКолонкаПечатныхФормДокументов.Получить();
	Если ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Артикул Тогда
		ВыводитьКоды    = Истина;
		Колонка         = "Артикул";
		ТекстКодАртикул = "Артикул";
	ИначеЕсли ДопКолонка = Перечисления.ДополнительнаяКолонкаПечатныхФормДокументов.Код Тогда
		ВыводитьКоды    = Истина;
		Колонка         = "Код";
		ТекстКодАртикул = "Код";
	Иначе
		ВыводитьКоды    = Ложь;
		Колонка         = "";
		ТекстКодАртикул = "Код";
	КонецЕсли;

	Если ВыводитьКоды Тогда
		ОбластьШапки  = "ШапкаСКодом";
		ОбластьСтроки = "СтрокаСКодом";
	Иначе
		ОбластьШапки  = "ШапкаТаблицы";
		ОбластьСтроки = "Строка";
	КонецЕсли;

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТекущийДокумент", ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПеремещениеТоваров.Номер,
	|	ПеремещениеТоваров.Дата,
	|	ПеремещениеТоваров.Организация,
	|	ВЫБОР
	|		КОГДА ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|			ТОГДА ПеремещениеТоваров.Организация.Наименование
	|		ИНАЧЕ ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель
	|	КОНЕЦ КАК ПредставлениеСЕОтправитель,
	|	ВЫБОР
	|		КОГДА ПеремещениеТоваров.СтруктурноеПодразделениеПолучатель = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|			ТОГДА ПеремещениеТоваров.Организация.Наименование
	|		ИНАЧЕ ПеремещениеТоваров.СтруктурноеПодразделениеПолучатель
	|	КОНЕЦ КАК ПредставлениеСЕПолучатель,
	|	ПеремещениеТоваров.СкладОтправитель КАК Отправитель,
	|	ПеремещениеТоваров.СкладОтправитель.Представление КАК ПредставлениеОтправителя,
	|	ПеремещениеТоваров.СкладПолучатель КАК Получатель,
	|	ПеремещениеТоваров.СкладПолучатель.Представление КАК ПредставлениеПолучателя,
	|	ОтветственныеЛицаСкладОтправитель.ФизическоеЛицо КАК МОЛОтправителя,
	|	ОтветственныеЛицаСкладПолучатель.ФизическоеЛицо КАК МОЛПолучателя,
	|	ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель
	|ИЗ
	|	Документ.ур_ПеремещениеЗерна КАК ПеремещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛица.СрезПоследних(&Дата, ) КАК ОтветственныеЛицаСкладОтправитель
	|		ПО ПеремещениеТоваров.СкладОтправитель = ОтветственныеЛицаСкладОтправитель.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛица.СрезПоследних(&Дата, ) КАК ОтветственныеЛицаСкладПолучатель
	|		ПО ПеремещениеТоваров.СкладПолучатель = ОтветственныеЛицаСкладПолучатель.СтруктурнаяЕдиница
	|ГДЕ
	|	ПеремещениеТоваров.Ссылка = &ТекущийДокумент";
	
	Шапка = Запрос.Выполнить().Выбрать();
	Шапка.Следующий();
	
	
	ЗапросПоТоварам = Новый Запрос;
	ЗапросПоТоварам.УстановитьПараметр("ТекущийДокумент", ЭтотОбъект.Ссылка);
	ЗапросПоТоварам.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПеремещениеТоваров.Номенклатура,
	|	ПеремещениеТоваров.ЗерноваяРасписка,
	|	ВЫРАЗИТЬ(ПеремещениеТоваров.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК Товар,
	|	ПеремещениеТоваров.Номенклатура." + ТекстКодАртикул + " КАК КодАртикул,
	|	ПеремещениеТоваров.Количество КАК Количество,
	|	ПеремещениеТоваров.ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(ДвиженияТиповой.Сумма, 0) / ДвиженияТиповой.КоличествоКт * ПеремещениеТоваров.Количество * ПеремещениеТоваров.Коэффициент КАК Сумма,
	|	ПеремещениеТоваров.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПеремещениеТоваров.Номенклатура КАК Номенклатура,
	|		ПеремещениеТоваров.ЗерноваяРасписка КАК ЗерноваяРасписка,
	|		ПеремещениеТоваров.Ссылка КАК Ссылка,
	|		ПеремещениеТоваров.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СУММА(ПеремещениеТоваров.Количество) КАК Количество,
	|		МИНИМУМ(ПеремещениеТоваров.НомерСтроки) КАК НомерСтроки,
	|		ПеремещениеТоваров.Коэффициент КАК Коэффициент,
	|		ПеремещениеТоваров.СчетУчетаБУ КАК СчетУчета
	|	ИЗ
	|		Документ.ур_ПеремещениеЗерна.Товары КАК ПеремещениеТоваров
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ПеремещениеТоваров.Номенклатура,
	|		ПеремещениеТоваров.ЗерноваяРасписка,
	|		ПеремещениеТоваров.Ссылка,
	|		ПеремещениеТоваров.ЕдиницаИзмерения,
	|		ПеремещениеТоваров.Коэффициент,
	|		ПеремещениеТоваров.СчетУчетаБУ) КАК ПеремещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ТиповойДвиженияССубконто.СчетКт КАК СчетКт,
	|			ТиповойДвиженияССубконто.СубконтоКт1 КАК СубконтоКт1,
	|			СУММА(ТиповойДвиженияССубконто.Сумма) КАК Сумма,
	|			СУММА(ТиповойДвиженияССубконто.КоличествоКт) КАК КоличествоКт
	|		ИЗ
	|			РегистрБухгалтерии.Типовой.ДвиженияССубконто(, , Регистратор = &ТекущийДокумент) КАК ТиповойДвиженияССубконто
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ТиповойДвиженияССубконто.СчетКт,
	|			ТиповойДвиженияССубконто.СубконтоКт1) КАК ДвиженияТиповой
	|		ПО ПеремещениеТоваров.Номенклатура = ДвиженияТиповой.СубконтоКт1
	|			И ПеремещениеТоваров.СчетУчета = ДвиженияТиповой.СчетКт
	|ГДЕ
	|	ПеремещениеТоваров.Ссылка = &ТекущийДокумент
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	ВыборкаСтрокТовары = ЗапросПоТоварам.Выполнить().Выбрать();

	СтруктурнаяЕдиницаОрганизация = ОбщегоНазначения.ПолучитьСтруктурнуюЕдиницу(Шапка.Организация, Шапка.СтруктурноеПодразделениеОтправитель);
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ПеремещениеТоваров_Накладная";
	Макет       = ПолучитьМакет("Накладная");

	// Выводим шапку накладной
	ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
	ОбластьМакета.Параметры.Заполнить(Шапка);
	
	ОбластьМакета.Параметры.ТекстЗаголовка = РаботаСДиалогами.СформироватьЗаголовокДокумента(ЭтотОбъект, "Накладная на перемещение", глСписокПрефиксовУзлов);
	ТабДокумент.Вывести(ОбластьМакета);

	// Вывести табличную часть
	ОбластьМакета = Макет.ПолучитьОбласть(ОбластьШапки);
	Если ВыводитьКоды Тогда
		ОбластьМакета.Параметры.Колонка = Колонка;
	КонецЕсли;
	ТабДокумент.Вывести(ОбластьМакета);

	ОбластьСтроки = Макет.ПолучитьОбласть(ОбластьСтроки);
	
	Пока ВыборкаСтрокТовары.Следующий() Цикл

		Если НЕ ЗначениеЗаполнено(ВыборкаСтрокТовары.Номенклатура) Тогда
			Сообщить("В одной из строк не заполнено значение номенклатуры - строка при печати пропущена.", СтатусСообщения.Важное);
			Продолжить;
		КонецЕсли;
		
        ОбластьСтроки.Параметры.Заполнить(ВыборкаСтрокТовары);
		ОбластьСтроки.Параметры.Товар = СокрЛП(ВыборкаСтрокТовары.Товар);
		ОбластьСтроки.Параметры.ПредЗерновойРасписки = УправлениеРесурсами.ПолучитьПредставлениеЗерновойРасписки(ВыборкаСтрокТовары.ЗерноваяРасписка);
		
		Если ВыводитьКоды Тогда
			ОбластьСтроки.Параметры.КодАртикул = ВыборкаСтрокТовары.КодАртикул;
		КонецЕсли;    
		
		ТабДокумент.Вывести(ОбластьСтроки);
		
	КонецЦикла;

	// Вывести подвал
	ОбластьПодвала = Макет.ПолучитьОбласть("Подвал");
	ТабДокумент.Вывести(ОбластьПодвала);

	// Вывести подписи
	ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
	ОбластьМакета.Параметры.ПредставлениеМОЛОтправителя = ОбщегоНазначения.ФамилияИнициалыФизЛица(Шапка.МОЛОтправителя);
	ОбластьМакета.Параметры.ПредставлениеМОЛПолучателя  = ОбщегоНазначения.ФамилияИнициалыФизЛица(Шапка.МОЛПолучателя);
	ТабДокумент.Вывести(ОбластьМакета);

	Возврат ТабДокумент;

КонецФункции // ПечатьПеремещениеТоваров()

// Функция формирует табличный документ с печатной формой "З-6(накладная на внутреннее перемещение материалов)".
//
// Возвращаемое значение:
//  Табличный документ - печатная форма накладной
//
Функция ПечатьЗ6()

	СтруктурнаяЕдиницаОрганизация = ОбщегоНазначения.ПолучитьСтруктурнуюЕдиницу(Организация, СтруктурноеПодразделениеОтправитель);

	// сформируем запрос по данным шапки 
	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТекДокумент", ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Дата", ЭтотОбъект.Дата);
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПеремещениеТоваров.Организация,
	|	ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель КАК СтруктурноеПодразделение,
	|	ПеремещениеТоваров.Номер,
	|	ПеремещениеТоваров.Дата,";
	Если СтруктурноеПодразделениеОтправитель <> Справочники.ПодразделенияОрганизаций.ПустаяСсылка() ИЛИ СтруктурноеПодразделениеПолучатель <> Справочники.ПодразделенияОрганизаций.ПустаяСсылка() ИЛИ  мОтображатьСтруктурныеПодразделения Тогда 
		Запрос.Текст = Запрос.Текст + " (ВЫБОР КОГДА ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель <> ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
										| ТОГДА ПеремещениеТоваров.СтруктурноеПодразделениеОтправитель.Наименование + ""/"" + ПеремещениеТоваров.СкладОтправитель.Наименование
										| ИНАЧЕ ПеремещениеТоваров.Организация.Наименование + ""/"" + ПеремещениеТоваров.СкладОтправитель.Наименование
										| КОНЕЦ) КАК Отправитель,";
	Иначе
		Запрос.Текст = Запрос.Текст + " ПеремещениеТоваров.СкладОтправитель КАК Отправитель, ";
	КонецЕсли;
	
	Если СтруктурноеПодразделениеПолучатель <> Справочники.ПодразделенияОрганизаций.ПустаяСсылка() ИЛИ СтруктурноеПодразделениеОтправитель <> Справочники.ПодразделенияОрганизаций.ПустаяСсылка() ИЛИ мОтображатьСтруктурныеПодразделения Тогда
		Запрос.Текст = Запрос.Текст + " (ВЫБОР КОГДА ПеремещениеТоваров.СтруктурноеПодразделениеПолучатель <> ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
										| ТОГДА ПеремещениеТоваров.СтруктурноеПодразделениеПолучатель.Наименование + ""/"" + ПеремещениеТоваров.СкладПолучатель.Наименование
										| ИНАЧЕ ПеремещениеТоваров.Организация.Наименование + ""/"" + ПеремещениеТоваров.СкладПолучатель.Наименование
										| КОНЕЦ) КАК Получатель,"; 
	Иначе
		Запрос.Текст = Запрос.Текст + " ПеремещениеТоваров.СкладПолучатель КАК Получатель, ";
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "	ОтветственныеЛицаСрезПоследнихОтправитель.ФизическоеЛицо КАК МОЛОтправитель,
	|	ОтветственныеЛицаСрезПоследнихПолучатель.ФизическоеЛицо КАК МОЛПолучатель
	|ИЗ
	|	Документ.ур_ПеремещениеЗерна КАК ПеремещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛица.СрезПоследних(&Дата, ) КАК ОтветственныеЛицаСрезПоследнихОтправитель
	|		ПО ПеремещениеТоваров.СкладОтправитель = ОтветственныеЛицаСрезПоследнихОтправитель.СтруктурнаяЕдиница
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛица.СрезПоследних(&Дата, ) КАК ОтветственныеЛицаСрезПоследнихПолучатель
	|		ПО ПеремещениеТоваров.СкладПолучатель = ОтветственныеЛицаСрезПоследнихПолучатель.СтруктурнаяЕдиница
	|ГДЕ
	|	ПеремещениеТоваров.Ссылка = &ТекДокумент";
	
	Док = Запрос.Выполнить().Выбрать();
	Док.Следующий();
		
	ЗапросПоТоварам = Новый Запрос;
	ЗапросПоТоварам.УстановитьПараметр("ТекущийДокумент", ЭтотОбъект.Ссылка);
	ЗапросПоТоварам.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПеремещениеТоваров.Номенклатура,
	|	ВЫРАЗИТЬ(ПеремещениеТоваров.Номенклатура.НаименованиеПолное КАК СТРОКА(1000)) КАК ТоварНаименование,
	|	ПеремещениеТоваров.Номенклатура.Код КАК ТоварКод,
	|	ПеремещениеТоваров.Количество КАК Количество,
	|	ПеремещениеТоваров.ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(ДвиженияТиповой.Сумма, 0) / ДвиженияТиповой.КоличествоКт * ПеремещениеТоваров.Количество * ПеремещениеТоваров.Коэффициент КАК Сумма,
	|	ПеремещениеТоваров.НомерСтроки КАК НомерПП
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПеремещениеТоваров.Номенклатура КАК Номенклатура,
	|		ПеремещениеТоваров.Ссылка КАК Ссылка,
	|		ПеремещениеТоваров.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СУММА(ПеремещениеТоваров.Количество) КАК Количество,
	|		МИНИМУМ(ПеремещениеТоваров.НомерСтроки) КАК НомерСтроки,
	|		ПеремещениеТоваров.Коэффициент КАК Коэффициент,
	|		ПеремещениеТоваров.СчетУчетаБУ КАК СчетУчета
	|	ИЗ
	|		Документ.ур_ПеремещениеЗерна.Товары КАК ПеремещениеТоваров
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ПеремещениеТоваров.Номенклатура,
	|		ПеремещениеТоваров.Ссылка,
	|		ПеремещениеТоваров.ЕдиницаИзмерения,
	|		ПеремещениеТоваров.Коэффициент,
	|		ПеремещениеТоваров.СчетУчетаБУ) КАК ПеремещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ТиповойДвиженияССубконто.СчетКт КАК СчетКт,
	|			ТиповойДвиженияССубконто.СубконтоКт1 КАК СубконтоКт1,
	|			СУММА(ТиповойДвиженияССубконто.Сумма) КАК Сумма,
	|			СУММА(ТиповойДвиженияССубконто.КоличествоКт) КАК КоличествоКт
	|		ИЗ
	|			РегистрБухгалтерии.Типовой.ДвиженияССубконто(, , Регистратор = &ТекущийДокумент) КАК ТиповойДвиженияССубконто
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ТиповойДвиженияССубконто.СчетКт,
	|			ТиповойДвиженияССубконто.СубконтоКт1) КАК ДвиженияТиповой
	|		ПО ПеремещениеТоваров.Номенклатура = ДвиженияТиповой.СубконтоКт1
	|			И ПеремещениеТоваров.СчетУчета = ДвиженияТиповой.СчетКт
	|ГДЕ
	|	ПеремещениеТоваров.Ссылка = &ТекущийДокумент
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|ИТОГИ
	|   СУММА(Сумма), КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Номенклатура)
	|ПО
	|	Общие
	|";
	
	ВыборкаТоварыОбщие = ЗапросПоТоварам.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	ЕстьТовары = ВыборкаТоварыОбщие.Следующий();
	
	ВыборкаТовары = ВыборкаТоварыОбщие.Выбрать();
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ПеремещениеТоваров_З6";
	Макет       = ПолучитьМакет("З6");
	
	// получим области макета
	Шапка 						 = Макет.ПолучитьОбласть("Шапка");
	ЗаголовокТаблицы2			 = Макет.ПолучитьОбласть("ЗаголовокТаблицы2");
	ЗаголовокТаблицыДляПереноса  = Макет.ПолучитьОбласть("ЗаголовокТаблицыДляПереноса");
	СтрокаТаблицы2				 = Макет.ПолучитьОбласть("СтрокаТаблицы2");
	Подвал						 = Макет.ПолучитьОбласть("Подвал");
	
	// Вывод шапки
	СведенияОбОрганизации = ОбщегоНазначения.СведенияОЮрФизЛице(СтруктурнаяЕдиницаОрганизация, Док.Дата);
	Шапка.Параметры.ПредставлениеОрганизации = ОбщегоНазначения.ОписаниеОрганизации(СведенияОбОрганизации, "ПолноеНаименование,");
	Шапка.Параметры.ОрганизацияПоОКПО 		 = СведенияОбОрганизации.КодПоОКПО;
	Шапка.Параметры.ОрганизацияРНН 			 = СведенияОбОрганизации.РНН;
	
	Шапка.Параметры.НомерДокумента = ОбщегоНазначения.ПолучитьНомерНаПечать(ЭтотОбъект, глСписокПрефиксовУзлов);
	Шапка.Параметры.Заполнить(Док);
		
	ТабДокумент.Вывести(Шапка);
	
	// вывод таблицы
	
	//заголовок
	Валюта = Константы.ВалютаРегламентированногоУчета.Получить();
	ЗаголовокТаблицы2.Параметры.Валюта = Валюта;
	ТабДокумент.Вывести(ЗаголовокТаблицы2);
	ТабДокумент.Вывести(ЗаголовокТаблицыДляПереноса);
	
	//вывцожим строки таблицы
	Пока ВыборкаТовары.Следующий() Цикл
		
		Если Не УниверсальныеМеханизмы.ПроверитьВыводДляТабличногоДокумента(ТабДокумент, СтрокаТаблицы2) Тогда
			
			// Выведем разрыв страницы
			ТабДокумент.ВывестиГоризонтальныйРазделительСтраниц();
			// Выведем переносимую часть заголовка таблицы	
			ТабДокумент.Вывести(ЗаголовокТаблицыДляПереноса);
			
		КонецЕсли;
		
		СуммаТовара = ?(ВыборкаТовары.Сумма = Null, 0, ВыборкаТовары.Сумма);
		
		СтрокаТаблицы2.Параметры.Заполнить(ВыборкаТовары);
		СтрокаТаблицы2.Параметры.Количество = Формат(ВыборкаТовары.Количество, "ЧДЦ=3");
		СтрокаТаблицы2.Параметры.Сумма = Формат(СуммаТовара, "ЧДЦ=2");
		СтрокаТаблицы2.Параметры.Цена = Формат(?(ЗначениеЗаполнено(ВыборкаТовары.Количество), СуммаТовара/ВыборкаТовары.Количество, 0), "ЧДЦ=2");
		
		ТабДокумент.Вывести(СтрокаТаблицы2);
		
	КонецЦикла;	
	
	// вывод подвала
	Если ЕстьТовары Тогда
		Подвал.Параметры.КоличествоНаименований = ЧислоПрописью(ВыборкаТоварыОбщие.Номенклатура, ,",,,,,,,,0"); ;
		Подвал.Параметры.СуммаПрописью 			= ОбщегоНазначения.СформироватьСуммуПрописью(?(ЗначениеЗаполнено(ВыборкаТоварыОбщие.Сумма),ВыборкаТоварыОбщие.Сумма,0), Валюта);
	Иначе
		Подвал.Параметры.КоличествоНаименований = "_______";
		Подвал.Параметры.СуммаПрописью 			= "_________________тенге____тиын";
	КонецЕсли;
	
	//МОЛ
	ДанныеОтправителя = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(Док.Организация, Док.МОЛОтправитель,Док.Дата);
	ДанныеПолучателя  = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(Док.Организация, Док.МОЛПолучатель,Док.Дата);
	
	Подвал.Параметры.ДолжностьОтпустил = ДанныеОтправителя.Должность;
	Подвал.Параметры.ФИООтпустил 	   = ДанныеОтправителя.Представление;
	
	Подвал.Параметры.ДолжностьПолучил = ДанныеПолучателя.Должность;
	Подвал.Параметры.ФИОПолучил 	  = ДанныеПолучателя.Представление;
	
	ТабДокумент.Вывести(Подвал);	
	
	Возврат ТабДокумент;
	
КонецФункции // ПечатьЗ6()


////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОКУМЕНТА

// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходмое количество копий.
//
//  Название макета печати передается в качестве параметра,
// по переданному названию находим имя макета в соответствии.
//
// Параметры:
//  НазваниеМакета - строка, название макета.
//
Процедура Печать(ИмяМакета, КоличествоЭкземпляров = 1, НаПринтер = Ложь) Экспорт

	Если ЭтоНовый() Тогда
		Предупреждение("Документ можно распечатать только после его записи");
		Возврат;
	ИначеЕсли Не УправлениеПользователями.РазрешитьПечатьНепроведенныхДокументов(Проведен) Тогда
		Предупреждение("Недостаточно полномочий для печати непроведенного документа!");
		Возврат;
	КонецЕсли;
	
	Если Не РаботаСДиалогами.ПроверитьМодифицированность(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	// Получить экземпляр документа на печать
	Если ИмяМакета = "Ведомость" Тогда

		ТабДокумент = ПечатьПеремещениеТоваров();
		
	ИначеЕсли ИмяМакета = "З6" Тогда
		
		ТабДокумент = ПечатьЗ6();
		
	КонецЕсли;

	УниверсальныеМеханизмы.НапечататьДокумент(ТабДокумент, КоличествоЭкземпляров, НаПринтер, РаботаСДиалогами.СформироватьЗаголовокДокумента(ЭтотОбъект, ЭтотОбъект.Метаданные().Представление()));

КонецПроцедуры // Печать

// Заполняет табличную часть остатками на складе
//
Процедура ЗаполнитьТабличнуюЧастьПоостаткам() Экспорт

	Если НЕ ЗначениеЗаполнено(СкладОтправитель) Тогда
		Сообщить("Не заполнен склад для получения остатков!");
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Организация) Тогда
		Сообщить("Не заполнена организация для получения остатков!");
	КонецЕсли;
	
	Если Товары.Количество()>0 Тогда
		Режим = РежимДиалогаВопрос.ДаНет;
		Ответ = Вопрос("Перед заполнением табличная часть будет очищена.
						|Продолжить?", Режим, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
		    Товары.Очистить();
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если мОтображатьСтруктурныеПодразделения Тогда
		УсловиеСтруктурноеПодразделение = " И СтруктурноеПодразделение = &СтруктурноеПодразделение";	
	Иначе 
		УсловиеСтруктурноеПодразделение = "";
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
    |	ТиповойОстатки.Счет,
  	|	ТиповойОстатки.Субконто1 КАК Номенклатура,
  	|	СУММА(ТиповойОстатки.КоличествоОстаток) КАК Количество
  	|ИЗ
  	|	РегистрБухгалтерии.Типовой.Остатки(
  	|		&Дата,
  	|		,
  	|		&ВидыСубконто,
  	|		Организация = &Организация " + УсловиеСтруктурноеПодразделение + "
  	|			И Субконто2 = &Склад) КАК ТиповойОстатки
  	|
  	|СГРУППИРОВАТЬ ПО
  	|	ТиповойОстатки.Субконто1,
	|	ТиповойОстатки.Счет");
	
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоТиповые.Номенклатура);
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконтоТиповые.Склады);
	Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Склад",		 СкладОтправитель);
	Запрос.УстановитьПараметр("Дата",		 ?(ЭтоНовый(),Дата(1,1,1),Дата));
	
	Если мОтображатьСтруктурныеПодразделения Тогда
		Запрос.УстановитьПараметр("СтруктурноеПодразделение", СтруктурноеПодразделениеОтправитель);
	КонецЕсли;

	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Товары.Добавить();
		НоваяСтрока.Количество 	 	 = Выборка.Количество;
		НоваяСтрока.Номенклатура	 = Выборка.Номенклатура;
		НоваяСтрока.СчетУчетаБУ  	 = Выборка.Счет;
		НоваяСтрока.НовыйСчетУчетаБУ = Выборка.Счет;
		НоваяСтрока.Коэффициент  	 = 1;
		НоваяСтрока.ЕдиницаИзмерения = Выборка.Номенклатура.БазоваяЕдиницаИзмерения;
		
		УправлениеПроизводством.ЗаполнитьСчетНалоговогоУчетаВСтрокеТабличногоПоля(НоваяСтрока, "СчетУчетаБУ","СчетУчетаНУ" , Дата);	
		НоваяСтрока.НовыйСчетУчетаНУ = 	НоваяСтрока.СчетУчетаНУ;
			
	КонецЦикла;

КонецПроцедуры // ЗаполнитьТабличнуюЧастьПоостаткам()

#КонецЕсли

Процедура ЗаполнитьПоДокументуОснования(Основание) Экспорт
	
	ЗаполнениеДокументов.ЗаполнитьШапкуДокументаПоОснованию(ЭтотОбъект, Основание);
	
	Если ТипЗнч(Основание) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
		ДокументОснование = Основание;
		СкладОтправитель = Основание.Склад;
		Для Каждого СтрокаТовары Из Основание.Товары Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.ЕдиницаИзмерения = СтрокаТовары.ЕдиницаИзмерения;
			НоваяСтрока.Количество 	 	 = СтрокаТовары.Количество;
			НоваяСтрока.Коэффициент 	 = СтрокаТовары.Коэффициент;
			НоваяСтрока.Номенклатура 	 = СтрокаТовары.Номенклатура;
			НоваяСтрока.СчетУчетаБУ 	 = СтрокаТовары.СчетУчетаБУ;
			НоваяСтрока.НовыйСчетУчетаБУ = СтрокаТовары.СчетУчетаБУ;
			НоваяСтрока.СчетУчетаНУ 	 = СтрокаТовары.СчетУчетаНУ;
			НоваяСтрока.НовыйСчетУчетаНУ = СтрокаТовары.СчетУчетаНУ;
		КонецЦикла;
	ИначеЕсли ТипЗнч(Основание) = Тип("ДокументСсылка.ОтчетПроизводстваЗаСмену") Тогда	
		ДокументОснование = Основание;
		СкладОтправитель = Основание.Склад;
		Для Каждого СтрокаПродукция Из Основание.Продукция Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.ЕдиницаИзмерения = СтрокаПродукция.ЕдиницаИзмерения;
			НоваяСтрока.Количество 		 = СтрокаПродукция.Количество;
			НоваяСтрока.Коэффициент 	 = СтрокаПродукция.Коэффициент;
			НоваяСтрока.Номенклатура 	 = СтрокаПродукция.Номенклатура;
			НоваяСтрока.СчетУчетаБУ 	 = СтрокаПродукция.СчетБУ;
			НоваяСтрока.НовыйСчетУчетаБУ = СтрокаПродукция.СчетБУ;
			НоваяСтрока.СчетУчетаНУ 	 = СтрокаПродукция.СчетНУ;
			НоваяСтрока.НовыйСчетУчетаНУ = СтрокаПродукция.СчетНУ;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры


// Заполняет счета БУ в строке табличной части.
//
Процедура ЗаполнитьСчетаБУ(СтрокаТЧ, ИмяТабЧасти, СчетаУчета, СчетаУчетаНовые, ЗаполнятьБУ, ЗаполнятьНУ)

	Если ЗаполнятьБУ = Истина Тогда
		
		СтрокаТЧ.СчетУчетаБУ      = СчетаУчета.СчетУчетаБУ;
		СтрокаТЧ.НовыйСчетУчетаБУ = СчетаУчетаНовые.СчетУчетаБУ;

	ИначеЕсли ЗаполнятьБУ = Ложь Тогда

		СтрокаТЧ.СчетУчетаБУ      = ПланыСчетов.Типовой.ПустаяСсылка();
		СтрокаТЧ.НовыйСчетУчетаБУ = ПланыСчетов.Типовой.ПустаяСсылка();

	КонецЕсли;
	
	Если ЗаполнятьНУ = Истина Тогда
		
		СтрокаТЧ.СчетУчетаНУ      = СчетаУчета.СчетУчетаНУ;
		СтрокаТЧ.НовыйСчетУчетаНУ = СчетаУчетаНовые.СчетУчетаНУ;

	ИначеЕсли ЗаполнятьНУ = Ложь Тогда

		СтрокаТЧ.СчетУчетаНУ      = ПланыСчетов.Налоговый.ПустаяСсылка();
		СтрокаТЧ.НовыйСчетУчетаНУ = ПланыСчетов.Налоговый.ПустаяСсылка();

	КонецЕсли; 
	
КонецПроцедуры // ЗаполнитьСчетаБУ()

// Возвращает доступные варианты печати документа
//
// Вовращаемое значение:
//  Струткура, каждая строка которой соответствует одному из вариантов печати
//  
Функция ПолучитьСтруктуруПечатныхФорм() Экспорт
	
	Возврат Новый Структура("Ведомость, З6","Перемещение товаров", "З-6 (накладная на перемещение)");

КонецФункции // ПолучитьСтруктуруПечатныхФорм()

// Заполняет счета БУ и НУ в строке табличной части.
//
Процедура ЗаполнитьСчетаУчетаВСтрокеТабЧастиРегл(СтрокаТЧ, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ) Экспорт

	СчетаУчета 		= ПроцедурыБухгалтерскогоУчета.ПолучитьСчетаУчетаНоменклатуры(Организация, СтрокаТЧ.Номенклатура);
	СчетаУчетаНовые = ПроцедурыБухгалтерскогоУчета.ПолучитьСчетаУчетаНоменклатуры(Организация, СтрокаТЧ.Номенклатура);

	ЗаполнитьСчетаБУ(СтрокаТЧ, ИмяТабЧасти, СчетаУчета, СчетаУчетаНовые, ЗаполнятьБУ, ЗаполнятьНУ);

КонецПроцедуры // ЗаполнитьСчетаУчетаВСтрокеТабЧастиРегл()

// Процедура заполняет счета БУ в табличной части.
//
Процедура ЗаполнитьСчетаУчетаВТабЧасти(ТабличнаяЧасть, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ) Экспорт

	Для Каждого СтрокаТабЧасти Из ТабличнаяЧасть Цикл		
		ЗаполнитьСчетаУчетаВСтрокеТабЧастиРегл(СтрокаТабЧасти, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ);		
	КонецЦикла;

КонецПроцедуры // обЗаполнитьСчетаУчетаВТабЧасти()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ ОБЕСПЕЧЕНИЯ ПРОВЕДЕНИЯ ДОКУМЕНТА

// Выгружает результат запроса в табличную часть, добавляет ей необходимые колонки для проведения.
//
// Параметры: 
//  РезультатЗапросаПоТоварам - результат запроса по табличной части "Товары",
//  СтруктураШапкиДокумента   - выборка по результату запроса по шапке документа.
//
// Возвращаемое значение:
//  Сформированная таблиица значений.
//
Функция ПодготовитьТаблицуТоваров(РезультатЗапросаПоТоварам, СтруктураШапкиДокумента)

	ТаблицаТоваров = РезультатЗапросаПоТоварам.Выгрузить();

	ТаблицаТоваров.Колонки.Добавить("КорСчетСписанияБУ");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияБУ1");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияБУ2");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияБУ3");
	ТаблицаТоваров.Колонки.Добавить("КорСчетСписанияНУ");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияНУ1");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияНУ2");
	ТаблицаТоваров.Колонки.Добавить("КорСубконтоСписанияНУ3");
	
	ТаблицаТоваров.Колонки.Добавить("ДоговорКонтрагента");
	ТаблицаТоваров.Колонки.Добавить("ДоговорПоставщика");
	ТаблицаТоваров.Колонки.Добавить("ДокументОприходования");
	ТаблицаТоваров.Колонки.Добавить("Регистратор");

	ТаблицаТоваров.ЗаполнитьЗначения(Неопределено, "ДоговорКонтрагента");
	ТаблицаТоваров.ЗаполнитьЗначения(ЭтотОбъект,   "Регистратор");
	
	ТаблицаТоваров.Колонки.Добавить("СтруктурноеПодразделение");
	ТаблицаТоваров.Колонки.Добавить("КорСтруктурноеПодразделение");
	ТаблицаТоваров.ЗаполнитьЗначения(СтруктураШапкиДокумента.СтруктурноеПодразделениеОтправитель, "СтруктурноеПодразделение");
	ТаблицаТоваров.ЗаполнитьЗначения(СтруктураШапкиДокумента.СтруктурноеПодразделениеПолучатель,  "КорСтруктурноеПодразделение");
	
	Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
		ТаблицаТоваров.ЗаполнитьЗначения(ПланыСчетов.Типовой.СырьеИМатериалы,"КорСчетСписанияБУ" );
		ТаблицаТоваров.ЗаполнитьЗначения(ПланыСчетов.Налоговый.СырьеИМатериалы,"КорСчетСписанияНУ" );
	ИначеЕсли ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
		ТаблицаТоваров.Колонки.Добавить("ГотоваяПродукция");
	Иначе
		ТаблицаТоваров.ЗаполнитьЗначения(ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами,"КорСчетСписанияБУ" );
		ТаблицаТоваров.ЗаполнитьЗначения(ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами.СчетНУ,"КорСчетСписанияНУ" );
	КонецЕсли;
	
	ТаблицаТоваров.ЗаполнитьЗначения(СтруктураШапкиДокумента.ТипОперации, "КорСубконтоСписанияБУ1");
	ТаблицаТоваров.ЗаполнитьЗначения(СтруктураШапкиДокумента.ТипОперации, "КорСубконтоСписанияНУ1");
	
	Для Каждого СтрокаТаблицы ИЗ ТаблицаТоваров Цикл
		Если (СтрокаТаблицы.Коэффициент<>0) Тогда
			СтрокаТаблицы.Количество = СтрокаТаблицы.Количество*СтрокаТаблицы.Коэффициент;
		КонецЕсли;
	КонецЦикла;

	Возврат ТаблицаТоваров;

КонецФункции // ПодготовитьТаблицуТоваров()

// Проверяет правильность заполнения шапки документа.
// Если какой-то из реквизтов шапки, влияющий на проведение не заполнен или
// заполнен не корректно, то выставляется флаг отказа в проведении.
// Проверяется также правильность заполнения реквизитов ссылочных полей документа.
// Проверка выполняется по объекту и по выборке из результата запроса по шапке.
//
// Параметры: 
//  СтруктураШапкиДокумента - выборка из результата запроса по шапке документа,
//  Отказ                   - флаг отказа в проведении,
//  Заголовок               - строка, заголовок сообщения об ошибке проведения.
//
Процедура ПроверитьЗаполнениеШапки(СтруктураШапкиДокумента, Отказ, Заголовок)

	// Укажем, что надо проверить:
	СтруктураОбязательныхПолей = Новый Структура("Организация, СкладОтправитель, СкладПолучатель");
	
	Если  СтруктураШапкиДокумента.УчитыватьКПН Тогда
		СтруктураОбязательныхПолей.Вставить("ВидУчетаНУ");
	КонецЕсли;
			
	// Документ должен принадлежать хотя бы к одному виду учета (управленческий, бухгалтерский, налоговый)
	ОбщегоНазначения.ПроверитьПринадлежностьКВидамУчета(СтруктураШапкиДокумента, Отказ, Заголовок);

	// Теперь позовем общую процедуру проверки.
	ОбщегоНазначения.ПроверитьЗаполнениеШапкиДокумента(ЭтотОбъект, СтруктураОбязательныхПолей, Отказ, Заголовок);

КонецПроцедуры // ПроверитьЗаполнениеШапки()

// Проверяет правильность заполнения строк табличной части "Товары".
//
// Параметры:
// Параметры: 
//  ТаблицаПоТоварам        - таблица значений, содержащая данные для проведения и проверки ТЧ Товары
//  СтруктураШапкиДокумента - выборка из результата запроса по шапке документа,
//  Отказ                   - флаг отказа в проведении.
//  Заголовок               - строка, заголовок сообщения об ошибке проведения.
//
Процедура ПроверитьЗаполнениеТабличнойЧастиТовары(ТаблицаПоТоварам, СтруктураШапкиДокумента, Отказ, Заголовок)

	ИмяТабличнойЧасти = "Товары";

	СтруктураОбязательныхПолей = Новый Структура("Номенклатура, Количество");
	
	// Укажем, что надо проверить:
	
	Если ВидОперации <> Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходТоварыВПути И 
		ВидОперации <> Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
		СтруктураОбязательныхПолей.Вставить("ЗерноваяРасписка");
	КонецЕсли;
	СтруктураОбязательныхПолей.Вставить("СчетУчетаБУ");
	
	Если СтруктураШапкиДокумента.УчитыватьКПН И СтруктураШапкиДокумента.ВедениеУчетаВременныхРазницБалансовымМетодом Тогда
		СтруктураОбязательныхПолей.Вставить("СчетУчетаНУ");
	КонецЕсли;
		

	// Теперь позовем общую процедуру проверки.
	ОбщегоНазначения.ПроверитьЗаполнениеТабличнойЧасти(ЭтотОбъект, "Товары", СтруктураОбязательныхПолей, Отказ, Заголовок);

	// Здесь услуг быть не должно.
	УправлениеЗапасами.ПроверитьЧтоНетУслуг(ЭтотОбъект, "Товары", ТаблицаПоТоварам, Отказ, Заголовок);
	
КонецПроцедуры // ПроверитьЗаполнениеТабличнойЧастиТовары()

Процедура ПроверитьЗаполнениеЗерновыхРасписок(ТаблицаПоЗерновымРаспискам, Отказ, Заголовок)
	СтрокаНачалаСообщенияОбОшибке = "";
	
	Если не ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
		Для каждого СтрокаЗР ИЗ ТаблицаПоЗерновымРаспискам Цикл
			СтрокаНачалаСообщенияОбОшибке = "В строке номер """+ СокрЛП(СтрокаЗР.НомерСтроки) +
			""" Зерновая расписка """;
			
			если Не ЗначениеЗаполнено(СтрокаЗР.ВидРесурса)  Тогда
				
				СтрокаСообщения = "Не заполнено значение реквизита вид ресурса !";
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + СтрокаСообщения, Отказ, Заголовок);
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(СтрокаЗР.ГодУрожая) Тогда
				
				СтрокаСообщения = "Не заполнено значение реквизита Год урожая !";
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + СтрокаСообщения, Отказ, Заголовок);
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(СтрокаЗР.Культура) Тогда
				
				СтрокаСообщения = "Не заполнено значение реквизита Вид культуры !";
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + СтрокаСообщения, Отказ, Заголовок);
			КонецЕсли;
			
			Если Не ЗначениеЗаполнено(СтрокаЗР.Класс)  Тогда
				
				СтрокаСообщения = "Не заполнено значение реквизита класс культуры !";
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + СтрокаСообщения, Отказ, Заголовок);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;

КонецПроцедуры

// По результату запроса по шапке документа формируем движения по регистрам.
//
// Параметры: 
//  РежимПроведения           - режим проведения документа (оперативный или неоперативный),
//  СтруктураШапкиДокумента   - выборка из результата запроса по шапке документа,
//  ТаблицаПоТоварам          - таблица значений, содержащая данные для проведения и проверки ТЧ Товары
//  ТаблицаПоТаре             - таблица значений, содержащая данные для проведения и проверки ТЧ "Возвратная тара",
//  Отказ                     - флаг отказа в проведении,
//  Заголовок                 - строка, заголовок сообщения об ошибке проведения.
//
Процедура ДвиженияПоРегистрам(РежимПроведения, СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоЗерновымРаспискам, Отказ, Заголовок);
	
	// признак "отражать в налоговом учете" пока не отрабатываем, поэтому установим "Ложь"
	Если Видоперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.Расход
		ИЛИ Видоперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
		
		Если ПараметрыСеанса.ТекущийПользователь.Наименование = "Администратор" Тогда
			Сообщить("Администратор");
			ДатаДока   = Дата;
			ПроводкиБУ 					= Движения.Типовой;
			ПроводкиНУ 					= Движения.Налоговый;
			
			СчетКТ = ПланыСчетов.Типовой.КоммерческиеРесурсыЗерна;
				Для Каждого Строка Из Товары Цикл
					Проводка = ПроводкиБУ.Добавить();
					Проводка.Период       = ДатаДока;
					Проводка.Организация  = СтруктураШапкиДокумента.Организация;
					Проводка.Содержание   = "Перемещены ТМЗ";
										
					Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
						Проводка.СчетДт = ПланыСчетов.Типовой.СырьеИМатериалы;
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура", Строка.Номенклатура,Истина, Заголовок);
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады", СтруктураШапкиДокумента.СкладПолучатель,Истина, Заголовок);
						Проводка.КоличествоДт = Строка.Количество;
					Иначе
						Проводка.СчетДт = ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами; 
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"ТипыОпераций", ТипОперации,Истина, Заголовок);
					КонецЕсли;

					Проводка.СчетКт = СчетКТ;
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", Строка.Номенклатура,Истина, Заголовок);
					Проводка.СубконтоКт.Номенклатура = Строка.Номенклатура;
					Проводка.КоличествоКт = Строка.Количество;
									
					Проводка.Сумма  = Строка.Сумма;
				КонецЦикла;	
				// Налоговый учет
				Для Каждого СтрокаТаблицы Из Товары Цикл
					Если СтруктураШапкиДокумента.НеобходимостьОтраженияВНУ Тогда		
						Если ЗначениеЗаполнено(СтрокаТаблицы.СчетУчетаНУ) Тогда
							Проводка = ПроводкиНУ.Добавить();
							
							Проводка.Период       = Дата;
							Проводка.Организация  = Организация;	
							Проводка.Содержание   = "Оприходованы ТМЗ";
							
							Проводка.СчетДт       = СтрокаТаблицы.СчетУчетаНУ;
							ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура",СтрокаТаблицы.Номенклатура,Истина , Заголовок);
							ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",	СтруктураШапкиДокумента.СкладПолучатель);
							
							Проводка.КоличествоДт = СтрокаТаблицы.Количество;
							
							Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
								Проводка.СчетКт       = ПланыСчетов.Налоговый.СырьеИМатериалы;	
								ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", СтрокаТаблицы.Номенклатура);
								Проводка.КоличествоДт = Строка.Количество;
							Иначе
								Проводка.СчетКт       = ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами.СчетНУ;	
								ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"ТипыОпераций", ТипОперации);
							КонецЕсли;
						
							
							//ПроцедурыБухгалтерскогоУчета.УстановитьПодразделенияПроводки(
							//Проводка, СтруктураШапкиДокумента.СтруктурноеПодразделение, СтруктураШапкиДокумента.СтруктурноеПодразделение);
							
							Проводка.Сумма = СтрокаТаблицы.Сумма;
							
							ПроцедурыНалоговогоУчета.ВидУчетаНУ(Проводка, СтруктураШапкиДокумента.ВидУчетаНУ);										
						КонецЕсли; 	
					КонецЕсли;
				КонецЦикла;
		Иначе
				Для Каждого СтрокаСписания ИЗ ТаблицаПоТоварам Цикл
					СтруктураОтбора = Новый Структура;
					СтруктураОтбора.Вставить("ЗерноваяРасписка",СтрокаСписания.ЗерноваяРасписка);
					
					ТаблицаСписания = ТаблицаПоТоварам.СКопировать(СтруктураОтбора);
					УправлениеЗапасамиПартионныйУчет.ДвижениеПартийТоваров(ТаблицаСписания, Истина, СтруктураШапкиДокумента.НеобходимостьОтраженияВНУ, Отказ,СтрокаСписания.ЗерноваяРасписка,"Перемещены ТМЗ");
				КонецЦикла;
		КонецЕсли;
	Иначе
		// Формирование проводок
		// Проводки по поступлению .
		
		ДатаДока   = Дата;
		ПроводкиБУ 					= Движения.Типовой;
		ПроводкиНУ 					= Движения.Налоговый;
		// чтобы для каждой строки не выполнять запрос по стратегии списания для счета
		// добавим соответствие [Счет, СтратегияСписания]
		СтратегииСписания = Новый Соответствие;
		// Проводки по товарам
		Для каждого СтрокаТаблицы Из ТаблицаПоТоварам Цикл
			
			Проводка = ПроводкиБУ.Добавить();
			
			Проводка.Период       = ДатаДока;
			Проводка.Организация  = СтруктураШапкиДокумента.Организация;
			Проводка.Содержание   = "Поступление зерна при перемещении";
			
			Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходТоварыВПути Тогда
				Проводка.СчетДт       = Планысчетов.Типовой.ТоварыВПутиСоб;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура", СтрокаТаблицы.Номенклатура,Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",       СтруктураШапкиДокумента.СкладПолучатель);
			ИначеЕсли ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
				Проводка.СчетДт       = СтрокаТаблицы.СчетУчетаБУ;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура", СтрокаТаблицы.Номенклатура,Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",       СтруктураШапкиДокумента.СкладПолучатель);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Партии",       СтрокаТаблицы.ЗерноваяРасписка);
				
			Иначе
				Проводка.СчетДт       = СтрокаТаблицы.СчетУчетаБУ;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура", СтрокаТаблицы.Номенклатура,Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",       СтруктураШапкиДокумента.СкладПолучатель);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Партии",       СтрокаТаблицы.ЗерноваяРасписка);
			КонецЕсли;
			
			//ПроцедурыБухгалтерскогоУчета.УстановитьПодразделенияПроводки(
			//Проводка, СтруктураШапкиДокумента.СтруктурноеПодразделение, СтруктураШапкиДокумента.СтруктурноеПодразделение);
			
			Если Проводка.СчетДт.Валютный Тогда
				
				Проводка.ВалютаДт        = СтруктураШапкиДокумента.ВалютаВзаиморасчетов;
				Проводка.ВалютнаяСуммаДт = СтрокаТаблицы.СуммаВал;
				
			КонецЕсли;
			
			// если нет соответствия стратегии выбранному счету, добавим значение
			//Если СтратегииСписания.Получить(СтрокаТаблицы.СчетУчетаБУ) = Неопределено Тогда
			//	
			//	СтратегииСписания.Вставить(СтрокаТаблицы.СчетУчетаБУ,УправлениеЗапасами.ВедетсяПартионныйУчетДляСчета(СтрокаТаблицы.СчетУчетаБУ));
			//	
			//КонецЕсли;
			//
			//ВедетсяПартионныйУчетДляСчета = СтратегииСписания.Получить(СтрокаТаблицы.СчетУчетаБУ);
			//
			//Если ВедетсяПартионныйУчетДляСчета Тогда
			//	
			//	ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Партии", Ссылка,, Заголовок);
			//	
			//КонецЕсли;
			
			Проводка.КоличествоДт = СтрокаТаблицы.Количество;
			
			Проводка.Сумма = СтрокаТаблицы.Сумма;
			
						
			Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходИзТоварыВПути Тогда
				Проводка.СчетКт       = Планысчетов.Типовой.ТоварыВПутиСоб;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура",        СтрокаТаблицы.Номенклатура, Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Склады",        СтруктураШапкиДокумента.СкладПолучатель, Истина, Заголовок);
				Проводка.КоличествоКт = СтрокаТаблицы.Количество;
			ИначеЕсли ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
				Проводка.СчетКт       = Планысчетов.Типовой.СырьеИМатериалы;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", ГотоваяПродукция  , Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Склады",        СтруктураШапкиДокумента.СкладОтправитель, Истина, Заголовок);
				Проводка.КоличествоКт = СтрокаТаблицы.Количество;
			
			Иначе
				
				Проводка.СчетКт = ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами;
				
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"ТипыОпераций",        СтруктураШапкиДокумента.ТипОперации, Истина, Заголовок);
			КонецЕсли;
			
			
			// Налоговый учет
			Если СтруктураШапкиДокумента.НеобходимостьОтраженияВНУ Тогда		
				Если ЗначениеЗаполнено(СтрокаТаблицы.СчетУчетаНУ) Тогда
					Проводка = ПроводкиНУ.Добавить();
					
					Проводка.Период       = ДатаДока;
					Проводка.Организация  = СтруктураШапкиДокумента.Организация;	
					Проводка.Содержание   = "Оприходованы ТМЗ";
					
					Проводка.СчетДт       = СтрокаТаблицы.СчетУчетаНУ;
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура",СтрокаТаблицы.Номенклатура,Истина , Заголовок);
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",	СтруктураШапкиДокумента.СкладПолучатель);
					
					Проводка.КоличествоДт = СтрокаТаблицы.Количество;
					
					Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда
						Проводка.СчетКт       = Планысчетов.Типовой.СырьеИМатериалы.СчетНУ;
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", ГотоваяПродукция  , Истина, Заголовок);
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Склады",        СтруктураШапкиДокумента.СкладОтправитель, Истина, Заголовок);
						Проводка.КоличествоКт = СтрокаТаблицы.Количество;
					Иначе	

						Проводка.СчетКт       = ПланыСчетов.Типовой.ПереоформлениеПереводМеждуРесурсами.СчетНУ;				
						ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"ТипыОпераций", СтруктураШапкиДокумента.ТипОперации);
					КонецЕсли;
					
					//ПроцедурыБухгалтерскогоУчета.УстановитьПодразделенияПроводки(
					//Проводка, СтруктураШапкиДокумента.СтруктурноеПодразделение, СтруктураШапкиДокумента.СтруктурноеПодразделение);
					
					Проводка.Сумма = СтрокаТаблицы.Сумма;
					
					ПроцедурыНалоговогоУчета.ВидУчетаНУ(Проводка, СтруктураШапкиДокумента.ВидУчетаНУ);										
				КонецЕсли; 	
			КонецЕсли;
			
			
			
			//Доп проводка
			Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки И ЗначениеЗаполнено(КоличествоОтходов) Тогда
				Проводка = ПроводкиБУ.Добавить();
			
				Проводка.Период       = ДатаДока;
				Проводка.Организация  = СтруктураШапкиДокумента.Организация;
				Проводка.Содержание   = "Поступление зерна при перемещении";
			
				Проводка.СчетДт       = Планысчетов.Типовой.СырьеИМатериалы;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура", ГотоваяПродукция,Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",       СтруктураШапкиДокумента.СкладОтправитель);
								
				Проводка.КоличествоДт = -КоличествоОтходов;
				//Проводка.Сумма = СтрокаТаблицы.Сумма;
			
				Проводка.СчетКт       = Планысчетов.Типовой.СырьеИМатериалы;
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", ГотоваяПродукция  , Истина, Заголовок);
				ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Склады",        СтруктураШапкиДокумента.СкладОтправитель, Истина, Заголовок);
				//Проводка.КоличествоКт = СтрокаТаблицы.Количество;
						
			
			// Налоговый учет
			Если СтруктураШапкиДокумента.НеобходимостьОтраженияВНУ Тогда		
				Если ЗначениеЗаполнено(СтрокаТаблицы.СчетУчетаНУ) Тогда
					Проводка = ПроводкиНУ.Добавить();
					
					Проводка.Период       = ДатаДока;
					Проводка.Организация  = СтруктураШапкиДокумента.Организация;	
					Проводка.Содержание   = "Оприходованы ТМЗ";
					
					Проводка.СчетДт       = СтрокаТаблицы.СчетУчетаНУ;
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Номенклатура",ГотоваяПродукция,Истина , Заголовок);
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетДт,Проводка.СубконтоДт,"Склады",	СтруктураШапкиДокумента.СкладОтправитель);
					
					Проводка.КоличествоДт = -КоличествоОтходов;
					
					Проводка.СчетКт       = СтрокаТаблицы.СчетУчетаНУ;
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Номенклатура", ГотоваяПродукция  , Истина, Заголовок);
					ПроцедурыБухгалтерскогоУчета.УстановитьСубконто(Проводка.СчетКт,Проводка.СубконтоКт,"Склады",        СтруктураШапкиДокумента.СкладОтправитель, Истина, Заголовок);
					//Проводка.КоличествоКт = СтрокаТаблицы.Количество;
									
					//Проводка.Сумма = СтрокаТаблицы.Сумма;
					
					ПроцедурыНалоговогоУчета.ВидУчетаНУ(Проводка, СтруктураШапкиДокумента.ВидУчетаНУ);										
				КонецЕсли; 	
			КонецЕсли;
	
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ДвиженияРегистровПодсистемыУчетаРесурсов(СтруктураШапкиДокумента, ТаблицаПоЗерновымРаспискам, 
											 Отказ, Заголовок);
	
КонецПроцедуры // ДвиженияПоРегистрам()

Процедура ДвиженияРегистровСведенийПоСтроке(СтрокаТаблицы,СтруктураШапкиДокумента, КонтрагентОрганизации)
	
	Если ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.Расход
		Или ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку 
		И СкладОтправитель<>СкладПолучатель Тогда
		Статус = УправлениеРесурсами.ПолучитьСтатусЗерновойРасписки(СтрокаТаблицы.ЗерноваяРасписка);
		если Статус = Перечисления.ур_СтатусыЗерновойРасписки.Действующая Тогда
			//Движения по регистру сведений "Статусы зерновых расписок
			//
			Движение = Движения.ур_СтатусыЗерновыхРасписок.Добавить();
			// Свойства
			Движение.Период           = СтруктураШапкиДокумента.Дата;
			// Измерения
			Движение.ЗерноваяРасписка = СтрокаТаблицы.ЗерноваяРасписка.Ссылка;
			
			// Ресурсы
			Движение.Статус         = Перечисления.ур_СтатусыЗерновойРасписки.Закрыта;
		КонецЕсли;
		
		// Движения по регистру сведений "Погашения зерновой расписки"
		//
		СтатусПогашения = УправлениеРесурсами.ПолучитьСтатусПогашения(СтрокаТаблицы.ЗерноваяРасписка);
		Если СтатусПогашения = Неопределено 
			И СкладОтправитель <> СкладПолучатель Тогда
			Движение = Движения.ур_ПогашенияЗерновыхРасписок.Добавить();
			// Свойства
			Движение.Период           = СтруктураШапкиДокумента.Дата;
			// Измерения
			Движение.ЗерноваяРасписка = СтрокаТаблицы.ЗерноваяРасписка.Ссылка;
			
			// Ресурсы
			Движение.ВидПогашения         = Перечисления.ур_ВидыПогашенияЗерновыхРасписок.Замена;
			Движение.ДатаПогашения        = СтруктураШапкиДокумента.Дата;
		КонецЕсли;
	ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.приход Тогда	
	КонецЕсли;
	
КонецПроцедуры

Процедура ДвиженияРегистровСведенийПодсистемыУчетаРесурсов(ТаблицаПоЗерновымРаспискам,СтруктураШапкиДокумента)
	
	НаборЗаписей = РегистрыСведений.СобственныеКонтрагенты.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Организация.Значение = СтруктураШапкиДокумента.организация;
	НаборЗаписей.Отбор.Организация.Использование = Истина;
	НаборЗаписей.Прочитать();
	
	Если НаборЗаписей.Количество() > 0 Тогда
		КонтрагентОрганизации = НаборЗаписей[0].Контрагент;
	Иначе 
		КонтрагентОрганизации = Справочники.Контрагенты.ПустаяСсылка();
	КонецЕсли;
	
	Для каждого СтрокаТаблицы ИЗ ТаблицаПоЗерновымРаспискам Цикл
		
		ДвиженияРегистровСведенийПоСтроке(СтрокаТаблицы,СтруктураШапкиДокумента, КонтрагентОрганизации);
		//Движение по оборотному регистру "Движения зерна"
		Если ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.Расход 
			Или ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
			
			Движение = Движения.ур_ДвиженияЗерна.Добавить();
			
			Движение.Период 				 = СтруктураШапкиДокумента.Дата;
			Движение.Организация 			 = СтруктураШапкиДокумента.Организация;
			Движение.Склад 	  				 = СтруктураШапкиДокумента.Склад;
			Движение.ТипОперации			 = СтруктураШапкиДокумента.ТипОперации;
			Движение.Контрагент 			 = СтруктураШапкиДокумента.СкладПолучатель;
			Движение.Видресурса				 = СтрокаТаблицы.Видресурса;
			Движение.РегламентныйВидОперации = Перечисления.ур_РегламентныеОперацииДвиженияЗерна.Расход;
			Движение.Зерноваярасписка		 = СтрокаТаблицы.Зерноваярасписка;
			Движение.ЗачтенныйВес  			 = СтрокаТаблицы.ЗачтенныйВес;
		ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.приход
			ИЛИ ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходТоварыВПути Тогда	
			Движение = Движения.ур_ДвиженияЗерна.Добавить();
			
			Движение.Период 				 = СтруктураШапкиДокумента.Дата;
			Движение.Организация 			 = СтруктураШапкиДокумента.Организация;
			Движение.Склад 	  				 = СтруктураШапкиДокумента.Склад;
			Движение.ТипОперации			 = СтруктураШапкиДокумента.ТипОперации;
			Движение.Контрагент 			 = СтруктураШапкиДокумента.СкладОтправитель;
			Движение.Видресурса				 = СтрокаТаблицы.Видресурса;
			Движение.РегламентныйВидОперации = Перечисления.ур_РегламентныеОперацииДвиженияЗерна.Приход;
			Движение.Зерноваярасписка		 = СтрокаТаблицы.Зерноваярасписка;
			Движение.ЗачтенныйВес  			 = СтрокаТаблицы.ЗачтенныйВес;
		ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходИзТоварыВПути Тогда	
			//Расход
			Движение = Движения.ур_ДвиженияЗерна.Добавить();
			
			Движение.Период 				 = СтруктураШапкиДокумента.Дата;
			Движение.Организация 			 = СтруктураШапкиДокумента.Организация;
			Движение.Склад 	  				 = СтруктураШапкиДокумента.Склад;
			Движение.ТипОперации			 = Справочники.ТипыОпераций.ЗерноВПути;
			Движение.Контрагент 			 = СтруктураШапкиДокумента.Склад;
			Движение.Видресурса				 = СтрокаТаблицы.Видресурса;
			Движение.РегламентныйВидОперации = Перечисления.ур_РегламентныеОперацииДвиженияЗерна.Расход;
			Движение.Зерноваярасписка		 = Документы.ур_ЗерноваяРасписка.ПустаяСсылка();
			Движение.ЗачтенныйВес  			 = СтрокаТаблицы.ЗачтенныйВес;
			
			//Приход
			Движение = Движения.ур_ДвиженияЗерна.Добавить();
			
			Движение.Период 				 = СтруктураШапкиДокумента.Дата;
			Движение.Организация 			 = СтруктураШапкиДокумента.Организация;
			Движение.Склад 	  				 = СтруктураШапкиДокумента.Склад;
			Движение.ТипОперации			 = СтруктураШапкиДокумента.ТипОперации;
			Движение.Контрагент 			 = СтруктураШапкиДокумента.Склад;
			Движение.Видресурса				 = СтрокаТаблицы.Видресурса;
			Движение.РегламентныйВидОперации = Перечисления.ур_РегламентныеОперацииДвиженияЗерна.Приход;
			Движение.Зерноваярасписка		 = СтрокаТаблицы.Зерноваярасписка;
			Движение.ЗачтенныйВес  			 = СтрокаТаблицы.ЗачтенныйВес;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Процедура вызывается из тела процедуры ДвиженияПоРегистрам
// Формирует движения по регистрам подсистемы учета ресурсов "ЗерноНаСкладах"
Процедура ДвиженияРегистровПодсистемыУчетаРесурсов(СтруктураШапкиДокумента, ТаблицаПоЗерновымРаспискам, 
													Отказ, Заголовок)
	ДвиженияРегистровСведенийПодсистемыУчетаРесурсов(ТаблицаПоЗерновымРаспискам, СтруктураШапкиДокумента);
													
	Если ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.Расход
		Или ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
														
		ДвиженияПоРегиструБронирования(ЭтотОбъект, СтруктураШапкиДокумента, Отказ);
		
		// Выполнить движения по регистру накопления "Зерно на складах"
		
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
														
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ТаблицаПоЗерновымРаспискамПолученным = ТаблицаПоЗерновымРаспискам.Скопировать();
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладОтправитель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(ТипОперации,"ТипОперации");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьРасход();
		КонецЕсли;
	ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.приход  Тогда	
		
		Для Каждого СтрокаТаблицы ИЗ ТаблицаПоЗерновымРаспискам Цикл
			Статус = УправлениеРесурсами.ПолучитьСтатусЗерновойРасписки(СтрокаТаблицы.ЗерноваяРасписка);
			если Статус = Неопределено Тогда
				//Движения по регистру сведений "Статусы зерновых расписок
				//
				Движение = Движения.ур_СтатусыЗерновыхРасписок.Добавить();
				// Свойства
				Движение.Период           = СтруктураШапкиДокумента.Дата;
				// Измерения
				Движение.ЗерноваяРасписка = СтрокаТаблицы.ЗерноваяРасписка.Ссылка;
				
				// Ресурсы
				Движение.Статус         = Перечисления.ур_СтатусыЗерновойРасписки.Действующая;
			КонецЕсли;
		КонецЦикла;
		
		// Выполнить движения по регистру накопления "Зерно на складах"
		
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
		
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ТаблицаПоЗерновымРаспискамПолученным = ТаблицаПоЗерновымРаспискам.Скопировать();
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладПолучатель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(ТипОперации,"ТипОперации");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьПриход();
		КонецЕсли;
	//+++ Oleg SmartT. 2021-12-09	
	ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходТоварыВПути Тогда
		// Выполнить движения по регистру накопления "Зерно на складах"
		
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
		
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ТаблицаПоЗерновымРаспискамПолученным = ТаблицаПоЗерновымРаспискам.Скопировать();
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладПолучатель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(ТипОперации,"ТипОперации");
		ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.ур_ВидыЗерна.Продовольственные,"ВидЗерна");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьПриход();
		КонецЕсли;
	ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПоступлениеИзПереработки Тогда	//движение только по отрубям
		// Выполнить движения по регистру накопления "Зерно на складах"
		
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
		
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ПараметрыОтбора = Новый Структура("Культура", Справочники.ур_ВидыКультур.НайтиПоКоду("ПР000000061")); //Отруби
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискам.Скопировать(ПараметрыОтбора), ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладПолучатель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(ТипОперации,"ТипОперации");
		ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.ур_ВидыЗерна.Продовольственные,"ВидЗерна");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьПриход();
		КонецЕсли;
	//--- Oleg SmartT. 2021-12-09	
	ИначеЕсли ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходИзТоварыВПути Тогда	
		
		//06.09.19
		//21.11.19
		
		// Выполнить движения по регистру накопления "Зерно на складах"
		// расход
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
		
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ТаблицаПоЗерновымРаспискамПолученным = ТаблицаПоЗерновымРаспискам.Скопировать();
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладПолучатель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(Справочники.ТипыОпераций.ЗерноВПути,"ТипОперации");
		
		Для Каждого СтрокаДв Из ТаблицаДвижений Цикл
			Запрос = Новый Запрос;
			Запрос.Текст = 
				"ВЫБРАТЬ
				|	ур_ЗерноваяРасписка.Ссылка
				|ИЗ
				|	Документ.ур_ЗерноваяРасписка КАК ур_ЗерноваяРасписка
				|ГДЕ
				|	ур_ЗерноваяРасписка.СерияНомерМСХ = &СерияНомерМСХ
				|	И ур_ЗерноваяРасписка.Ссылка <> &НоваяЗерновая";
			
			Запрос.УстановитьПараметр("СерияНомерМСХ", СтрокаДв.ЗерноваяРасписка.СерияНомерМСХ);
			Запрос.УстановитьПараметр("НоваяЗерновая", СтрокаДв.ЗерноваяРасписка);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			Выборка = РезультатЗапроса.Выбрать();
			
			Пока Выборка.Следующий() Цикл
				НоваяЗерновая = Выборка.Ссылка;
				СтрокаДв.ЗерноваяРасписка = НоваяЗерновая;
			КонецЦикла;
		КонецЦикла;
		

		//ТаблицаДвижений.ЗаполнитьЗначения(Документы.ур_ЗерноваяРасписка.ПустаяСсылка(), "ЗерноваяРасписка");
		ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.ур_ВидыЗерна.Продовольственные,"ВидЗерна");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьРасход();
		КонецЕсли;
		
		
		//Приход
		
		НаборДвижений = Движения.ур_ЗерноНаСкладах;
		
		// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
		ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
		
		// Заполним таблицу движений.
		ТаблицаПоЗерновымРаспискамПолученным = ТаблицаПоЗерновымРаспискам.Скопировать();
		ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
		
		// Недостающие поля.
		ТаблицаДвижений.ЗаполнитьЗначения(Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СкладПолучатель, "Склад");
		ТаблицаДвижений.ЗаполнитьЗначения(ТипОперации,"ТипОперации");
		
		НаборДвижений.мПериод            = Дата;
		НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
		
		
		Если Не Отказ Тогда
			Движения.ур_ЗерноНаСкладах.ВыполнитьПриход();
		КонецЕсли;
		
		//06.09.19

	КонецЕсли;

КонецПроцедуры

Процедура ДвиженияПоРегиструБронирования(ЭтотОбъект, СтруктураШапкиДокумента, Отказ)
	
	ТаблицаБронированияЗерна = УправлениеРесурсами.ПодготовитьТаблицуЗабронированногоЗерна(ЭтотОбъект, СтруктураШапкиДокумента, Отказ);
	
	
	НаборДвижений = Движения.ур_ЗабронированноеЗерно;
	
	// Получим таблицу значений, совпадающую со струкутрой набора записей регистра.
	ТаблицаДвижений = НаборДвижений.ВыгрузитьКолонки();
	
	// Заполним таблицу движений.
	ТаблицаПоЗерновымРаспискамПолученным = ТаблицаБронированияЗерна.Скопировать();
	ОбщегоНазначения.ЗагрузитьВТаблицуЗначений(ТаблицаПоЗерновымРаспискамПолученным, ТаблицаДвижений);
	
	НаборДвижений.мПериод            = Дата;
	НаборДвижений.мТаблицаДвижений   = ТаблицаДвижений;
	
	Для Каждого Стр из ТаблицаДвижений Цикл
		
		ЗерноваяСтарая = Стр.ЗерноваяРасписка;
		
	КонецЦикла;

	
	Если Не Отказ Тогда
		Движения.ур_ЗабронированноеЗерно.ВыполнитьРасход();
	КонецЕсли;

КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаЗаполнения(Основание)
	// Обработка для работы в версии 8.2
	Если ТипЗнч(Основание) <> Тип("Структура")
		И Основание <> НЕОПРЕДЕЛЕНО Тогда
	
		ЗаполнитьПоДокументуОснования(Основание);		
	КонецЕсли;
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)

	// Дерево значений, содержащее имена необходимых полей в запросе по шапке.
	Перем ДеревоПолейЗапросаПоШапке;

	// Заголовок для сообщений об ошибках проведения.
	Заголовок = ОбщегоНазначения.ПредставлениеДокументаПриПроведении(Ссылка);

	// Проверка ручной корректировки
	Если ОбщегоНазначения.РучнаяКорректировкаОбработкаПроведения(РучнаяКорректировка,Отказ,Заголовок,ЭтотОбъект) Тогда
		Возврат
	КонецЕсли;
	
	СтруктураШапкиДокумента = ОбщегоНазначения.СформироватьСтруктуруШапкиДокумента(ЭтотОбъект);
	
	Если ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.Расход
		Или ВидОперации = перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
		СтруктураШапкиДокумента.Вставить("Склад", СкладОтправитель);
		СтруктураШапкиДокумента.Вставить("Получатель", СкладПолучатель);
	Иначе
		СтруктураШапкиДокумента.Вставить("Склад", СкладПолучатель);
		СтруктураШапкиДокумента.Вставить("Получатель", СкладОтправитель);
	КонецЕсли;
	// для плательщиков КПН в любом случае формируются корреспонденции по отражению в налоговом учете
	// если признак "Отражать в НУ" в документе не установлен, то формируется проводка по постоянной разнице
	ОрганизацияПлательщикНалогаНаПрибыль 			= ПроцедурыНалоговогоУчета.ПолучитьПризнакПлательщикаНалогаНаПрибыль(Организация, Дата, мУчетнаяПолитикаПоНалоговомуУчету);
	ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль 	= ОрганизацияПлательщикНалогаНаПрибыль и ПроцедурыНалоговогоУчета.ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль(Организация, Дата, мУчетнаяПолитикаПоБухгалтерскомуУчету);	
	ВедениеУчетаВременныхРазницБалансовымМетодом = ПроцедурыНалоговогоУчета.ПолучитьПризнакВеденияУчетаВременныхРазницБалансовымМетодом(Организация, Дата, мУчетнаяПолитикаПоБухгалтерскомуУчету);
	
	СтруктураШапкиДокумента.Вставить("НеобходимостьОтраженияВНУ", 						УчитыватьКПН И ВедениеУчетаВременныхРазницБалансовымМетодом И (ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль ИЛИ ВидУчетаНУ = Справочники.ВидыУчетаНУ.НУ));
	СтруктураШапкиДокумента.Вставить("ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль", 	ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль);
	СтруктураШапкиДокумента.Вставить("ОрганизацияПлательщикНалогаНаПрибыль", 			ОрганизацияПлательщикНалогаНаПрибыль);
	СтруктураШапкиДокумента.Вставить("ВедениеУчетаВременныхРазницБалансовымМетодом", 	ВедениеУчетаВременныхРазницБалансовымМетодом);
			

	// Проверим правильность заполнения шапки документа
	ПроверитьЗаполнениеШапки(СтруктураШапкиДокумента, Отказ, Заголовок);

	// Получим необходимые данные для проведения и проверки заполенения данные по табличной части "Товары".
	СтруктураПолей = Новый Структура;
	СтруктураПолей.Вставить("Номенклатура"    , "Номенклатура");
	СтруктураПолей.Вставить("ЗерноваяРасписка", "ЗерноваяРасписка");
	СтруктураПолей.Вставить("Количество"      , "Количество");
	СтруктураПолей.Вставить("Сумма"      	  , "Сумма");
	СтруктураПолей.Вставить("Коэффициент"     , "Коэффициент");
	СтруктураПолей.Вставить("Услуга"          , "Номенклатура.Услуга");
	СтруктураПолей.Вставить("СчетУчетаБУ"     , "СчетУчетаБУ");
	СтруктураПолей.Вставить("НовыйСчетУчетаБУ", "НовыйСчетУчетаБУ");
	
	СтруктураПолей.Вставить("СчетУчетаНУ"     , "СчетУчетаНУ");
	СтруктураПолей.Вставить("НовыйСчетУчетаНУ", "НовыйСчетУчетаНУ");
	

	// Поля необходимы для партионного учета
	СтруктураПолей.Вставить("Организация",            "Ссылка.Организация");
	Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПеремещениеНаПереработку Тогда
		СтруктураПолей.Вставить("Склад",                  "Ссылка.СкладПолучатель");
	Иначе
		СтруктураПолей.Вставить("Склад",                  "Ссылка.СкладОтправитель");
	КонецЕсли;

	//СтруктураПолей.Вставить("КорСчетСписанияБУ",      "ПланыСчетов.Типовой.ПеремещениеПереводМеждуРесурсами");
	
	//СтруктураПолей.Вставить("КорСубконтоСписанияБУ1", "Ссылка.ТипОперации");
	//СтруктураПолей.Вставить("КорСубконтоСписанияБУ2", "");
	//СтруктураПолей.Вставить("КорСубконтоСписанияБУ3", "");
	
	//СтруктураПолей.Вставить("КорСчетСписанияНУ",      "ПланыСчетов.Налоговый.ПеремещениеПереводМеждуРесурсами");
	//
	//СтруктураПолей.Вставить("КорСубконтоСписанияНУ1", "Ссылка.ТипОперации");
	//СтруктураПолей.Вставить("КорСубконтоСписанияНУ2", "");
	//СтруктураПолей.Вставить("КорСубконтоСписанияНУ3", "");


	РезультатЗапросаПоТоварам = УправлениеЗапасами.СформироватьЗапросПоТабличнойЧасти(ЭтотОбъект, "Товары", СтруктураПолей);

	// Подготовим таблицу товаров и тары для проведения.
	ТаблицаПоТоварам 	= ПодготовитьТаблицуТоваров(РезультатЗапросаПоТоварам, СтруктураШапкиДокумента);

	// Проверить заполнение ТЧ "Товары" и "Возвратная тара".
	ПроверитьЗаполнениеТабличнойЧастиТовары(ТаблицаПоТоварам, СтруктураШапкиДокумента, Отказ, Заголовок);

	УправлениеВзаиморасчетами.ПодготовкаТаблицыЗначенийДляЦелейПриобретенияИРеализации(ТаблицаПоТоварам	, СтруктураШапкиДокумента, Истина);
	
 	ТаблицаПоЗерновымРаспискам    = УправлениеРесурсами.ПодготовитьТаблицуЗерновыхРасписок(ЭтотОбъект);
	ПроверитьЗаполнениеЗерновыхРасписок(ТаблицаПоЗерновымРаспискам, Отказ, Заголовок);
	
	
	//Если ВидОперации = Перечисления.ур_ВидыОперацийПеремещенияЗерна.ПриходИзТоварыВПути Тогда
	//	Дата = КонецДня(Дата);
	//	Сообщить("Для учета средней цены, Реализацию зерна нужно сформировать следующим днем");
	//КонецЕсли;
	
	// Движения по документу
	Если Не Отказ Тогда
		ДвиженияПоРегистрам(РежимПроведения, СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоЗерновымРаспискам, Отказ, Заголовок);
		Если Не Отказ Тогда			
			ПроцедурыНалоговогоУчета.ОтразитьПостоянныеРазницыВНУ(ЭтотОбъект, СтруктураШапкиДокумента, Истина);
		КонецЕсли; 		
	КонецЕсли;
	
КонецПроцедуры // ОбработкаПроведения()

// Предопределенная процедура обработки удаления проведения документа
//
Процедура ОбработкаУдаленияПроведения(Отказ)
	ОбщегоНазначения.УдалитьДвиженияРегистратора(ЭтотОбъект, Отказ, РучнаяКорректировка);
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

мВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
УчетнаяПолитикаНеЗадана = Ложь;
мОтображатьСтруктурныеПодразделения = ОбщегоНазначения.ПолучитьПризнакОтображенияСтруктурныхПодразделений();