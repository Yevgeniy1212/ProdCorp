//////////////////////////////////////////////////////////////////////////////////
// ВСПОМОГАТЕЛЬНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ
//

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Возвращает список видов времени, которые нельзя вводить этим документом
//
// Параметры
//  нет
//
// Возвращаемое значение:
//   Список значений, содержащий подходящий перечень значений перечисления ВидыВремени
//
Функция ПолучитьСписокНедопустимыхВидовВремени() Экспорт
	
	Список = Новый СписокЗначений;
	Список.Добавить(Перечисления.ВидыВремени.ОтработанноеСверхНормы);
	Список.Добавить(Перечисления.ВидыВремени.ЧасовоеНеотработанное);
	
	Возврат Список;

КонецФункции

// Выполняет автоматическое заполнение документа по данным документа и переданным параметрам
// 
// Параметры: 
//  нет
//
Процедура Автозаполнение(ПостроительЗапроса = Неопределено) Экспорт

	// АВТОЗАПОЛНЕНИЕ ТЧ "ОтработанноеВремя"

	ГоловнаяОрганизация = ОбщегоНазначения.ГоловнаяОрганизация(Организация);
	УчетнаяПолитикаПоПерсоналуОрганизации = глЗначениеПеременной("глУчетнаяПолитикаПоПерсоналуОрганизации");
	
	// Определим ссылку на элементы справочника КлассификаторИспользованияРабочегоВремени - ночное время,
	// который является предопределенным
	УчетВремениНочноеВремя = Справочники.КлассификаторИспользованияРабочегоВремени.РаботаНочныеЧасы;
	
	Если ПостроительЗапроса = Неопределено Тогда
		
		Запрос = Новый Запрос;
		
		// Установим параметры запроса
		Запрос.УстановитьПараметр("парамНачало" , ПериодРегистрации);
		Запрос.УстановитьПараметр("парамКонец" , КонецМесяца(ПериодРегистрации));
		Запрос.УстановитьПараметр("парамОрганизация" , Организация);
		Запрос.УстановитьПараметр("парамГоловнаяОрганизация", ГоловнаяОрганизация);
		Запрос.УстановитьПараметр("парамПользователь" , Ответственный);
		Запрос.УстановитьПараметр("парамПодразделение" , ПодразделениеОрганизации);
		Запрос.УстановитьПараметр("Уволен" , Перечисления.ПричиныИзмененияСостояния.Увольнение);
		Запрос.УстановитьПараметр("Прием" , Перечисления.ПричиныИзмененияСостояния.ПриемНаРаботу);
		Запрос.УстановитьПараметр("УчетВремениРабота" , Справочники.КлассификаторИспользованияРабочегоВремени.Работа);
		Запрос.УстановитьПараметр("УчетВремениНочноеВремя", УчетВремениНочноеВремя);
		Запрос.УстановитьПараметр("ЦелодневноеНеотработанное", Перечисления.ВидыВремени.ЦелодневноеНеотработанное);
		Запрос.УстановитьПараметр("парамСсылка", Ссылка);
		Запрос.УстановитьПараметр("ЧасовоеНеотработанное", Перечисления.ВидыВремени.ЧасовоеНеотработанное);
		Запрос.УстановитьПараметр("ПоЧасам", Перечисления.ВидыУчетаВремени.ПоЧасам);
		Запрос.УстановитьПараметр("ПоНочнымЧасам", Перечисления.ВидыУчетаВремени.ПоНочнымЧасам);
		
		// Проверим ответсвенного - является ли он расчетчиком вообще и для заданного 
		// подразделения (если оно задано)
		Если Не Ответственный.Пустая() Тогда
			Если УчетнаяПолитикаПоПерсоналуОрганизации[Организация].РасчетЗарплатыОрганизацииПоОтветственным Тогда
				Если ПодразделениеОрганизации.Пустая() Тогда
					Запрос.Текст = 
					"ВЫБРАТЬ ПЕРВЫЕ 1
					|	Расчетчики.ПодразделениеОрганизации
					|ИЗ
					|	РегистрСведений.РасчетчикиЗарплатыОрганизаций.СрезПоследних(&парамНачало, ) КАК Расчетчики
					|ГДЕ
					|	Расчетчики.Пользователь = &парамПользователь";
					Если Запрос.Выполнить().Пустой() Тогда
						Сообщить("Ответственный за этот документ не является расчетчиком ни одного из подразделений организации");
						Возврат;
					КонецЕсли;
				Иначе
					Запрос.Текст = 
					"ВЫБРАТЬ ПЕРВЫЕ 1
					|	Подразделения.Ссылка
					|ИЗ
					|	Справочник.ПодразделенияОрганизаций КАК Подразделения
					|ГДЕ
					|	Подразделения.Ссылка В ИЕРАРХИИ(&парамПодразделение)
					|	И Подразделения.Ссылка В ИЕРАРХИИ
					|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
					|				Расчетчики.ПодразделениеОрганизации
					|			ИЗ
					|				РегистрСведений.РасчетчикиЗарплатыОрганизаций.СрезПоследних(&парамНачало) КАК Расчетчики
					|			ГДЕ
					|				Расчетчики.Пользователь = &парамПользователь)";
					Если Запрос.Выполнить().Пустой() Тогда
						Сообщить("Ответственный за этот документ не является расчетчиком для выбранного подразделения");
						Возврат;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если ПодразделениеОрганизации.Пустая() И Ответственный.Пустая() Тогда
			ПоВсемПодразделениямОрганизации = Истина;
			УсловиеНаПодразделение = "ОбособленноеПодразделение = &парамОрганизация";
		ИначеЕсли ПодразделениеОрганизации.Пустая() Тогда
			Если УчетнаяПолитикаПоПерсоналуОрганизации[Организация].РасчетЗарплатыОрганизацииПоОтветственным Тогда
				ПоВсемПодразделениямОрганизации = Ложь;
				УсловиеНаПодразделение = "ПодразделениеОрганизации В ИЕРАРХИИ (ВЫБРАТЬ РАЗЛИЧНЫЕ Расчетчики.ПодразделениеОрганизации ИЗ РегистрСведений.РасчетчикиЗарплатыОрганизаций.СрезПоследних(&парамНачало) Расчетчики ГДЕ Расчетчики.Пользователь = &парамПользователь)";
			Иначе
				ПоВсемПодразделениямОрганизации = Истина;
				УсловиеНаПодразделение = "ОбособленноеПодразделение = &парамОрганизация";
			КонецЕсли;
		Иначе
			ПоВсемПодразделениямОрганизации = Ложь;
			УсловиеНаПодразделение = "ПодразделениеОрганизации В ИЕРАРХИИ (&парамПодразделение)";
		КонецЕсли;
		
		//ТаблицаДвиженийРаботниковТекст
		//Описание:
		//	Выбирает список работников, отвечающих условиям отбора, числящихся на начало месяца и их движения за месяц.
		
		ТаблицаДвиженийРаботниковТекст = "
		|		// срез работников на начало месяца
		|		ВЫБРАТЬ
		|			&парамНачало КАК Период,
		|			РаботникиОрганизации.Физлицо КАК Физлицо,
		|			РаботникиОрганизации.Приказ КАК Приказ,
		|			ИСТИНА КАК Подходит,
		|			ИСТИНА КАК Работает,
		|			РаботникиОрганизации.ГрафикРаботы КАК ГрафикРаботы,
		|			РаботникиОрганизации.ПодразделениеОрганизации КАК ПодразделениеОрганизации
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций.СрезПоследних(&парамНачало, Организация = &парамГоловнаяОрганизация) КАК РаботникиОрганизации
		|		
		|		ГДЕ 
		|			РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен И " + УсловиеНаПодразделение + " 
		|		
		|		ОБЪЕДИНИТЬ ВСЕ
		|
		|		// движения работников за месяц
		|		ВЫБРАТЬ
		|			РаботникиОрганизации.Период,
		|			РаботникиОрганизации.Физлицо,
		|			РаботникиОрганизации.Приказ,
		|			ВЫБОР КОГДА " + УсловиеНаПодразделение + " ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ,
		|			ВЫБОР КОГДА РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ,
		|			РаботникиОрганизации.ГрафикРаботы,
		|			РаботникиОрганизации.ПодразделениеОрганизации
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации
		|		
		|		ГДЕ
		|			РаботникиОрганизации.Период > &парамНачало И
		|			РаботникиОрганизации.Период <= &парамКонец И
		|			РаботникиОрганизации.Организация = &парамГоловнаяОрганизация
		|
		|		// отдельно выбираем всех принятых в середине месяца (кроме 1 числа),
		|		// чтобы по ним сгенерировать строки времени с нулевым фактом и корректной нормой
		|		// за тот период, что они еще не работали в организации, чтобы в расчетах для них 
		|		// учитывать полную норму за весь месяц. Для уволенных такая  ситуация обрабатывается за 
		|		// счет того, что не откидываются уволенные в предыдущем подзапросе.
		|		ОБЪЕДИНИТЬ ВСЕ
		|
		|		ВЫБРАТЬ
		|			&парамНачало КАК Период,
		|			РаботникиОрганизации.Физлицо,
		|			РаботникиОрганизации.Приказ,
		|			ИСТИНА Подходит,
		|			ЛОЖЬ КАК Работает,
		|			РаботникиОрганизации.ГрафикРаботы,
		|			РаботникиОрганизации.ПодразделениеОрганизации
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации
		|		ГДЕ
		|			РаботникиОрганизации.Период > &парамНачало И
		|			РаботникиОрганизации.Период <= &парамКонец И
		|			РаботникиОрганизации.Организация = &парамГоловнаяОрганизация И
		|			РаботникиОрганизации.ПричинаИзмененияСостояния = &Прием И
		|			" + УсловиеНаПодразделение + "
		|";
		
	Иначе
		ПостроительЗапроса.Параметры.Вставить("парамГоловнаяОрганизация" , ГоловнаяОрганизация);
		ПостроительЗапроса.Параметры.Вставить("парамНачало" , ПериодРегистрации);
		ПостроительЗапроса.Параметры.Вставить("парамКонец" , КонецМесяца(ПериодРегистрации));
		ПостроительЗапроса.Параметры.Вставить("парамОрганизация" , Организация);
		ПостроительЗапроса.Параметры.Вставить("парамПользователь" , Ответственный);
		ПостроительЗапроса.Параметры.Вставить("парамПодразделение" , ПодразделениеОрганизации);
		ПостроительЗапроса.Параметры.Вставить("Уволен", Перечисления.ПричиныИзмененияСостояния.Увольнение);
		ПостроительЗапроса.Параметры.Вставить("Прием" , Перечисления.ПричиныИзмененияСостояния.ПриемНаРаботу);
		ПостроительЗапроса.Параметры.Вставить("УчетВремениРабота" , Справочники.КлассификаторИспользованияРабочегоВремени.Работа);
		ПостроительЗапроса.Параметры.Вставить("УчетВремениНочноеВремя", УчетВремениНочноеВремя);
		ПостроительЗапроса.Параметры.Вставить("ЦелодневноеНеотработанное", Перечисления.ВидыВремени.ЦелодневноеНеотработанное);
		ПостроительЗапроса.Параметры.Вставить("парамСсылка", Ссылка);
		ПостроительЗапроса.Параметры.Вставить("ЧасовоеНеотработанное", Перечисления.ВидыВремени.ЧасовоеНеотработанное);
		ПостроительЗапроса.Параметры.Вставить("ПоЧасам", Перечисления.ВидыУчетаВремени.ПоЧасам);
		ПостроительЗапроса.Параметры.Вставить("ПоНочнымЧасам", Перечисления.ВидыУчетаВремени.ПоНочнымЧасам);

		ИсходныйТекстПостроителя = ПостроительЗапроса.Текст;
		ТекстЗапросаПоСпискуРаботников = СтрЗаменить(ИсходныйТекстПостроителя,"РАЗРЕШЕННЫЕ","");
		ТекстЗапросаПоСпискуРаботников = Лев(ТекстЗапросаПоСпискуРаботников, Найти(ТекстЗапросаПоСпискуРаботников,"УПОРЯДОЧИТЬ") - 1);
		УсловиеНаПодразделение = "";
		ТаблицаДвиженийРаботниковТекст = 
		"ВЫБРАТЬ
		|	СписокРаботников.ФизЛицо,
		|	СписокРаботников.Приказ,
		|	ДвижениеРаботников.Период,
		|	ДвижениеРаботников.Подходит,
		|	ДвижениеРаботников.Работает,
		|	ДвижениеРаботников.ПодразделениеОрганизации,
		|	ДвижениеРаботников.ГрафикРаботы
		|ИЗ
		|	(" + ТекстЗапросаПоСпискуРаботников + ") КАК СписокРаботников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			&парамНачало КАК Период,
		|			РаботникиОрганизации.Физлицо КАК Физлицо,
		|			РаботникиОрганизации.Приказ КАК Приказ,
		|			ИСТИНА КАК Подходит,
		|			ИСТИНА КАК Работает,
		|			РаботникиОрганизации.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
		|			РаботникиОрганизации.ГрафикРаботы КАК ГрафикРаботы
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций.СрезПоследних(&парамНачало, Организация = &парамГоловнаяОрганизация) КАК РаботникиОрганизации
		|		ГДЕ
		|			РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
		|			И РаботникиОрганизации.ОбособленноеПодразделение = &парамОрганизация
		|		
		|		ОБЪЕДИНИТЬ ВСЕ
		|		
		|		ВЫБРАТЬ
		|			РаботникиОрганизации.Период,
		|			РаботникиОрганизации.Физлицо,
		|			РаботникиОрганизации.Приказ,
		|			ВЫБОР
		|				КОГДА РаботникиОрганизации.ОбособленноеПодразделение = &парамОрганизация
		|					ТОГДА ИСТИНА
		|				ИНАЧЕ ЛОЖЬ
		|			КОНЕЦ КАК Подходит,
		|			ВЫБОР
		|				КОГДА РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
		|					ТОГДА ИСТИНА
		|				ИНАЧЕ ЛОЖЬ
		|			КОНЕЦ КАК Работает,
		|			РаботникиОрганизации.ПодразделениеОрганизации,
		|			РаботникиОрганизации.ГрафикРаботы
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации
		|		ГДЕ
		|			РаботникиОрганизации.Период > &парамНачало
		|			И РаботникиОрганизации.Период <= &парамКонец
		|			И РаботникиОрганизации.Организация = &парамГоловнаяОрганизация
		|
		|		// отдельно выбираем всех принятых в середине месяца (кроме 1 числа),
		|		// чтобы по ним сгенерировать строки времени с нулевым фактом и корректной нормой
		|		// за тот период, что они еще не работали в организации, чтобы в расчетах для них 
		|		// учитывать полную норму за весь месяц. Для уволенных такая  ситуация обрабатывается за 
		|		// счет того, что не откидываются уволенные в предыдущем подзапросе.
		|		ОБЪЕДИНИТЬ ВСЕ
		|
		|		ВЫБРАТЬ
		|			&парамНачало КАК Период,
		|			РаботникиОрганизации.Физлицо,
		|			РаботникиОрганизации.Приказ,
		|			ИСТИНА Подходит,
		|			ЛОЖЬ КАК Работает,
		|			РаботникиОрганизации.ПодразделениеОрганизации,
		|			РаботникиОрганизации.ГрафикРаботы
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации
		|		ГДЕ
		|			РаботникиОрганизации.Период > &парамНачало И
		|			РаботникиОрганизации.Период <= &парамКонец И
		|			РаботникиОрганизации.Организация = &парамГоловнаяОрганизация И
		|			РаботникиОрганизации.ПричинаИзмененияСостояния = &Прием И
		|			РаботникиОрганизации.ОбособленноеПодразделение = &парамОрганизация) КАК ДвижениеРаботников
		|		ПО СписокРаботников.Физлицо = ДвижениеРаботников.Физлицо
		|			И СписокРаботников.Приказ = ДвижениеРаботников.Приказ
		|";
	КонецЕсли;
	
	// Развернем назначение работников по периодам действия
	ПериодыДвиженийРаботниковТекст = "
	|ВЫБРАТЬ
	|	РаботникиОрганизации1.ФизЛицо,
	|	РаботникиОрганизации1.Приказ,
	|	РаботникиОрганизации1.Период КАК ДатаНачала,
	|	МИНИМУМ(ЕСТЬNULL(КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(РаботникиОрганизации2.Период, ДЕНЬ, -1), ДЕНЬ), &парамКонец)) КАК ДатаОкончания,
	|   РаботникиОрганизации1.ГрафикРаботы,
	|   РаботникиОрганизации1.ПодразделениеОрганизации,
	|	РаботникиОрганизации1.Работает
	|ИЗ
	|	(" + ТаблицаДвиженийРаботниковТекст + ") КАК РаботникиОрганизации1
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации2
	|		ПО РаботникиОрганизации1.ФизЛицо = РаботникиОрганизации2.ФизЛицо 
	|			И РаботникиОрганизации1.Приказ = РаботникиОрганизации2.Приказ 
	|			И РаботникиОрганизации1.Период < РаботникиОрганизации2.Период
	|			И РаботникиОрганизации2.Организация = &парамГоловнаяОрганизация
	|ГДЕ
	|	РаботникиОрганизации1.Подходит
	|
	|СГРУППИРОВАТЬ ПО
	|	РаботникиОрганизации1.ФизЛицо,
	|	РаботникиОрганизации1.Приказ,
	|	РаботникиОрганизации1.Период,
	|   РаботникиОрганизации1.ГрафикРаботы,
	|   РаботникиОрганизации1.ПодразделениеОрганизации,
	|   РаботникиОрганизации1.Работает
	|";
	
	// Выберем зарегистрированные отклонения за месяц
	// Развернем фактический период действия зарегистрированных отклонений на полный месяц
	// из-за того, что в регистре данные могут быть "кусками" по работнику 
	// (напр, 10.08.2005 - 20.08.2005 больничный лист, 25.08.2005 - 29.08.2005 отпуск), а
	// "целого" месяца нет, из-за чего потом при соединении будут неправильные данные
	НачалаФПДТекст = "
	|ВЫБРАТЬ
	|	РаботникиОрганизации.ФизЛицо,
	|	РаботникиОрганизации.Приказ,
	|	NULL КАК ВидРасчета,
	|	&парамНачало КАК Период
	|ИЗ
	|	(" + ТаблицаДвиженийРаботниковТекст + ") КАК РаботникиОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|			И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени В (&ЦелодневноеНеотработанное, ЗНАЧЕНИЕ(Перечисление.ВидыВремени.ОтработанноеВПределахНормы))
	|			) КАК ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия
	|		ПО РаботникиОрганизации.ФизЛицо = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ФизЛицо
	|			И РаботникиОрганизации.Приказ = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.Приказ
	|			И (&парамГоловнаяОрганизация = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.Организация)
	|			И (&парамНачало = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ПериодДействияНачало)
	|ГДЕ
	|	ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ФизЛицо ЕСТЬ NULL 
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ФПД.ФизЛицо,
	|	ФПД.Приказ,
	|	ФПД.ВидРасчета,
	|	ФПД.ПериодДействияНачало
	|ИЗ
	|	РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|		    И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени В (&ЦелодневноеНеотработанное, ЗНАЧЕНИЕ(Перечисление.ВидыВремени.ОтработанноеВПределахНормы))
	|			) КАК ФПД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ФПД.ФизЛицо,
	|	ФПД.Приказ,
	|	NULL,
	|	ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(ФПД.ПериодДействияКонец, ДЕНЬ), СЕКУНДА, 1) 
	|ИЗ
	|	РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|		    И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени В (&ЦелодневноеНеотработанное, ЗНАЧЕНИЕ(Перечисление.ВидыВремени.ОтработанноеВПределахНормы))
	| ) КАК ФПД
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|		    И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени = &ЦелодневноеНеотработанное) КАК ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия
	|		ПО ФПД.ФизЛицо = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ФизЛицо
	|			И ФПД.Организация = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.Организация
	|			И ФПД.Приказ = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.Приказ
	|			И (ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(ФПД.ПериодДействияКонец, ДЕНЬ), СЕКУНДА, 1) = ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ПериодДействияНачало)
	|ГДЕ
	|	ОсновныеНачисленияРаботниковОрганизацийФактическийПериодДействия.ФизЛицо ЕСТЬ NULL 
	|";
	
	ОкончанияФПДТекст = "
	|ВЫБРАТЬ
	|	ФПД.ФизЛицо,
	|	ФПД.Приказ,
	|	ФПД.ВидРасчета,
	|	ФПД.ПериодДействияНачало КАК Период
	|ИЗ
	|	РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|		    И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени В (&ЦелодневноеНеотработанное, ЗНАЧЕНИЕ(Перечисление.ВидыВремени.ОтработанноеВПределахНормы))
	|	) КАК ФПД
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ФПД.ФизЛицо,
	|	ФПД.Приказ,
	|	NULL,
	|	ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(ФПД.ПериодДействияКонец, ДЕНЬ), СЕКУНДА, 1) 
	|ИЗ
	|	РегистрРасчета.ОсновныеНачисленияРаботниковОрганизаций.ФактическийПериодДействия(
	|		Организация = &парамГоловнаяОрганизация
	|		    И ПериодДействия = &парамНачало
	|		    И ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени.ВидВремени В (&ЦелодневноеНеотработанное, ЗНАЧЕНИЕ(Перечисление.ВидыВремени.ОтработанноеВПределахНормы))
	|) КАК ФПД
	|";
	
	РазвернутыйФПДТекст = "
	|ВЫБРАТЬ
	|	РаботникиОрганизации1.ФизЛицо,
	|	РаботникиОрганизации1.Приказ,
	|	МАКСИМУМ(РаботникиОрганизации1.ВидРасчета) КАК ВидРасчета,
	|	НАЧАЛОПЕРИОДА(РаботникиОрганизации1.Период, ДЕНЬ) КАК ПериодДействияНачало,
	|	МИНИМУМ(ЕСТЬNULL(КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(РаботникиОрганизации2.Период, ДЕНЬ, -1), ДЕНЬ), &парамКонец)) КАК ПериодДействияКонец
	|ИЗ
	|	(" + НачалаФПДТекст + ") КАК РаботникиОрганизации1
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ (" + ТаблицаДвиженийРаботниковТекст + ") КАК ОграничениеРаботники
	|		ПО РаботникиОрганизации1.Физлицо = ОграничениеРаботники.Физлицо И РаботникиОрганизации1.Приказ = ОграничениеРаботники.Приказ 
	|	ЛЕВОЕ СОЕДИНЕНИЕ (" + ОкончанияФПДТекст + ") КАК РаботникиОрганизации2
	|		ПО РаботникиОрганизации1.Физлицо = РаботникиОрганизации2.Физлицо И РаботникиОрганизации1.Приказ = РаботникиОрганизации2.Приказ И РаботникиОрганизации1.Период < РаботникиОрганизации2.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	РаботникиОрганизации1.ФизЛицо,
	|	РаботникиОрганизации1.Приказ,
	|	РаботникиОрганизации1.Период
	|";
	
	// Соединим периоды движений с развернутым периодом действия зарегистрированных отклонений за месяц заполнения
	ДвиженияСОтклонениямиТекст = "
	|ВЫБРАТЬ
	|	ПериодыНазначения.ФизЛицо,
	|	ПериодыНазначения.Приказ,
	|	ПериодыНазначения.ГрафикРаботы,
	|	ПериодыНазначения.ПодразделениеОрганизации,
	|	ПериодыНазначения.Работает,
	|	ВЫБОР
	|		КОГДА ПериодыНазначения.ДатаНачала > ФПД.ПериодДействияНачало
	|			ТОГДА ПериодыНазначения.ДатаНачала
	|		ИНАЧЕ ФПД.ПериодДействияНачало
	|	КОНЕЦ КАК ДатаНачала,
	|	ВЫБОР
	|		КОГДА ПериодыНазначения.ДатаОкончания < ФПД.ПериодДействияКонец
	|			ТОГДА ПериодыНазначения.ДатаОкончания
	|		ИНАЧЕ ФПД.ПериодДействияКонец
	|	КОНЕЦ КАК ДатаОкончания,
	|	ВЫБОР
	|		КОГДА НЕ ПериодыНазначения.Работает
	|			ТОГДА &УчетВремениРабота
	|		ИНАЧЕ ФПД.ВидРасчета.ОбозначениеВТабелеУчетаРабочегоВремени 
	|	КОНЕЦ КАК ВидИспользованияРабочегоВремени
	|ИЗ
	|	(" + ПериодыДвиженийРаботниковТекст + ") КАК ПериодыНазначения
	|	ЛЕВОЕ СОЕДИНЕНИЕ (" + РазвернутыйФПДТекст + ") КАК ФПД
	|		ПО ПериодыНазначения.ФизЛицо = ФПД.ФизЛицо 
	|			И ПериодыНазначения.Приказ = ФПД.Приказ 
	|			И ПериодыНазначения.ДатаНачала <= ФПД.ПериодДействияКонец 
	|			И ПериодыНазначения.ДатаОкончания >= ФПД.ПериодДействияНачало
	|";

	// Выберем ранее внесенные данные о времени из регистра РабочееВремяРаботниковОрганизаций
	// другим документом КорректировкаИспользованияРаботникамиРабочегоВремени, чтобы избежать дублирования при вводе
	РанееУчтенноеРабочееВремяТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РабочееВремя.Физлицо,
	|	РабочееВремя.Приказ,
	|	РабочееВремя.Период,
	|	РабочееВремя.ВидИспользованияРабочегоВремени
	|ИЗ
	|	РегистрНакопления.РабочееВремяРаботниковОрганизаций КАК РабочееВремя
	|ГДЕ
	|	РабочееВремя.Организация = &парамГоловнаяОрганизация
	|	И РабочееВремя.Период МЕЖДУ &парамНачало И &парамКонец
	|	И РабочееВремя.Регистратор <> &парамСсылка
	|	И РабочееВремя.ВидИспользованияРабочегоВремени.ВидВремени <> &ЧасовоеНеотработанное";
	
	//Основной текст запроса за каждый день
	ОсновнойТекстЗапроса = "
	|ВЫБРАТЬ
	|	ДвиженияСОтклонениями.ФизЛицо,
	|	ДвиженияСОтклонениями.Приказ,
	|	ДвиженияСОтклонениями.ДатаНачала,
	|	ДвиженияСОтклонениями.ДатаОкончания,
	|	ГрафикиПоВидамВремени.Дата,
	|	ВЫБОР
	|		КОГДА ДвиженияСОтклонениями.Работает
	|			ТОГДА ГрафикиПоВидамВремени.ДополнительноеЗначение 
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ВсегоДней,
	|	ВЫБОР
	|		КОГДА ДвиженияСОтклонениями.Работает
	|			ТОГДА ГрафикиПоВидамВремени.ОсновноеЗначение - ВЫБОР
	|																КОГДА ДвиженияСОтклонениями.ВидИспользованияРабочегоВремени ЕСТЬ NULL 
	|																		И (НЕ ГрафикиПоВидамВремени.ВидУчетаВремени В (&ПоНочнымЧасам))
	|																	ТОГДА ЕСТЬNULL(ПочасовыеОтклонения.Часов, 0)
	|																ИНАЧЕ 0
	|														   КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ВсегоЧасов,
	|	ГрафикиПоВидамВремени.ДополнительноеЗначениеНорма КАК ВсегоДнейПоНорме,
	|	ГрафикиПоВидамВремени.ОсновноеЗначениеНорма КАК ВсегоЧасовПоНорме,
	|	ЕСТЬNULL(ДвиженияСОтклонениями.ВидИспользованияРабочегоВремени, ВЫБОР
	|			КОГДА ГрафикиПоВидамВремени.ВидУчетаВремени = &ПоЧасам
	|				ТОГДА &УчетВремениРабота
	|			ИНАЧЕ &УчетВремениНочноеВремя
	|		КОНЕЦ) КАК ВидИспользованияРабочегоВремени
	|ИЗ
	|	(" + ДвиженияСОтклонениямиТекст + ") КАК ДвиженияСОтклонениями
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ГрафикиРаботыПоВидамВремени КАК ГрафикиПоВидамВремени
	|	ПО ДвиженияСОтклонениями.ГрафикРаботы = ГрафикиПоВидамВремени.ГрафикРаботы
	|		И (ГрафикиПоВидамВремени.Дата МЕЖДУ ДвиженияСОтклонениями.ДатаНачала И ДвиженияСОтклонениями.ДатаОкончания)
	|		И (ГрафикиПоВидамВремени.ВидУчетаВремени В (&ПоЧасам, &ПоНочнымЧасам))
	|	ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|		ПочасовыеОтклонения.Физлицо КАК Физлицо,
	|		ПочасовыеОтклонения.Приказ КАК Приказ,
	|		ПочасовыеОтклонения.Период КАК Период,
	|		СУММА(ПочасовыеОтклонения.Часов) КАК Часов
	|	ИЗ
	|		РегистрНакопления.РабочееВремяРаботниковОрганизаций КАК ПочасовыеОтклонения
	|	ГДЕ
	|		ПочасовыеОтклонения.Период МЕЖДУ &парамНачало И &парамКонец
	|		И ПочасовыеОтклонения.Организация = &парамГоловнаяОрганизация
	|		И ПочасовыеОтклонения.ВидИспользованияРабочегоВремени.ВидВремени = &ЧасовоеНеотработанное
	|		И (НЕ ПочасовыеОтклонения.СводнаяЗапись)
	|		
	|	СГРУППИРОВАТЬ ПО
	|		ПочасовыеОтклонения.Физлицо,
	|		ПочасовыеОтклонения.Приказ,
	|		ПочасовыеОтклонения.Период) КАК ПочасовыеОтклонения
	|	ПО ДвиженияСОтклонениями.Физлицо = ПочасовыеОтклонения.Физлицо
	|		И ДвиженияСОтклонениями.Приказ = ПочасовыеОтклонения.Приказ
	|		И ПочасовыеОтклонения.Период = ГрафикиПоВидамВремени.Дата
	|	ЛЕВОЕ СОЕДИНЕНИЕ (" + РанееУчтенноеРабочееВремяТекст + ") КАК РанееУчтенноеВремя
	|	ПО ДвиженияСОтклонениями.Физлицо = РанееУчтенноеВремя.Физлицо
	|		И ДвиженияСОтклонениями.Приказ = РанееУчтенноеВремя.Приказ
	|		И (РанееУчтенноеВремя.Период МЕЖДУ ДвиженияСОтклонениями.ДатаНачала И ДвиженияСОтклонениями.ДатаОкончания)
	|		И ЕСТЬNULL(ДвиженияСОтклонениями.ВидИспользованияРабочегоВремени, ВЫБОР
	|			КОГДА ГрафикиПоВидамВремени.ВидУчетаВремени = &ПоЧасам
	|				ТОГДА &УчетВремениРабота
	|			ИНАЧЕ &УчетВремениНочноеВремя
	|		КОНЕЦ) = РанееУчтенноеВремя.ВидИспользованияРабочегоВремени
	|ГДЕ
	|	РанееУчтенноеВремя.Физлицо ЕСТЬ NULL 
	|	И (ДвиженияСОтклонениями.ВидИспользованияРабочегоВремени ЕСТЬ NULL 
	|			ИЛИ ГрафикиПоВидамВремени.ВидУчетаВремени = &ПоЧасам)
	|";
	
	Если РазвернутыйПериод Тогда
		// Суммируем дни/часы за период действия
		ОсновнойТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Данные.ФизЛицо,
		|	Данные.Приказ,
		|	Данные.ДатаНачала,
		|	Данные.ДатаОкончания,
		|	Данные.ВидИспользованияРабочегоВремени,
		|	СУММА(Данные.ВсегоДней) КАК ВсегоДней,
		|	СУММА(Данные.ВсегоЧасов) КАК ВсегоЧасов,
		|	СУММА(Данные.ВсегоДнейПоНорме) КАК ВсегоДнейПоНорме,
		|	СУММА(Данные.ВсегоЧасовПоНорме) КАК ВсегоЧасовПоНорме
		|ИЗ
		|	(" + ОсновнойТекстЗапроса + ") КАК Данные
		|СГРУППИРОВАТЬ ПО
		|	Данные.ФизЛицо,
		|	Данные.Приказ,
		|	Данные.ДатаНачала,
		|	Данные.ДатаОкончания,
		|	Данные.ВидИспользованияРабочегоВремени
		|ИМЕЮЩИЕ 
		|	СУММА(Данные.ВсегоДней) <> 0 Или
		|	СУММА(Данные.ВсегоЧасов) <> 0 Или
		|	СУММА(Данные.ВсегоДнейПоНорме) <> 0 Или
		|	СУММА(Данные.ВсегоЧасовПоНорме) <> 0 
		|	
		|УПОРЯДОЧИТЬ ПО 
		|	Данные.ФизЛицо.Наименование,
		|	Данные.Приказ,
		|	Данные.ДатаНачала
		|";
	Иначе
		// Исправим даты периода
		ОсновнойТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Данные.ФизЛицо,
		|	Данные.Приказ,
		|	Данные.Дата КАК ДатаНачала,
		|	Данные.Дата КАК ДатаОкончания,
		|	Данные.ВидИспользованияРабочегоВремени,
		|	Данные.ВсегоДней,
		|	Данные.ВсегоЧасов,
		|	Данные.ВсегоДнейПоНорме,
		|	Данные.ВсегоЧасовПоНорме
		|ИЗ
		|	(" + ОсновнойТекстЗапроса + ") КАК Данные
		|ГДЕ
		|	Данные.ВсегоДней <> 0 Или
		|	Данные.ВсегоЧасов <> 0 Или
		|	Данные.ВсегоДнейПоНорме <> 0 Или
		|	Данные.ВсегоЧасовПоНорме <> 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	Данные.ФизЛицо.Наименование,
		|	Данные.Приказ,
		|	Данные.Дата
		|";
	КонецЕсли;
	
	Если ПостроительЗапроса = Неопределено Тогда
		Запрос.Текст = ОсновнойТекстЗапроса;
		РезультатЗапроса = Запрос.Выполнить();
	Иначе 
		//Основной текст запроса
		ПостроительЗапроса.Текст = ОсновнойТекстЗапроса;
		ПостроительЗапроса.Выполнить();
		РезультатЗапроса = ПостроительЗапроса.Результат;
	КонецЕсли;
	
	ОтработанноеВремя.Загрузить(РезультатЗапроса.Выгрузить());
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ ОБЕСПЕЧЕНИЯ ПРОВЕДЕНИЯ ДОКУМЕНТА

// Формирует запрос по шапке документа
//
// Параметры: 
//  нет
//
// Возвращаемое значение:
//  Результат запроса
//
Функция СформироватьЗапросПоШапке()

	Запрос = Новый Запрос;

	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка" , Ссылка);
	Запрос.УстановитьПараметр("парамПустаяОрганизация", Справочники.Организации.ПустаяСсылка());

	Запрос.Текст = "
	|ВЫБРАТЬ 
	|	Дата, 
	|	ПериодРегистрации,
	|	РазвернутыйПериод, 
	|	ВЫБОР КОГДА Организация.ГоловнаяОрганизация = &парамПустаяОрганизация ТОГДА Организация ИНАЧЕ Организация.ГоловнаяОрганизация КОНЕЦ Как ГоловнаяОрганизация, 
	| 	Ссылка 
	|ИЗ 
	|	Документ.КорректировкаИспользованияРаботникамиРабочегоВремени
	|ГДЕ 
	|	Ссылка = &ДокументСсылка
	|";

	Возврат Запрос.Выполнить();

КонецФункции // СформироватьЗапросПоШапке()

// Формирует запрос по таблице "ОтработанноеВремя" документа
//
// Параметры: 
//	ВыборкаПоШапкеДокумента
//
// Возвращаемое значение:
//  Результат запроса.
//
Функция СформироватьЗапросПоОтработанноеВремя(ВыборкаПоШапкеДокумента)

	Запрос = Новый Запрос;
	
	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка", Ссылка);
	Запрос.УстановитьПараметр("ГоловнаяОрганизация", ВыборкаПоШапкеДокумента.ГоловнаяОрганизация);
	Запрос.УстановитьПараметр("ПустаяДата", Дата('00010101'));
	Запрос.УстановитьПараметр("СписокНедопустимыхВидовВремени", ПолучитьСписокНедопустимыхВидовВремени());

	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтрокиТЧ.Физлицо КАК Физлицо,
	|	СтрокиТЧ.Приказ КАК Приказ,
	|	СтрокиТЧ.ВидИспользованияРабочегоВремени КАК ВидИспользованияРабочегоВремени,
	|	СтрокиТЧ.ВидИспользованияРабочегоВремени.ВидВремени КАК ВидВремени,
	|	ВЫБОР КОГДА СтрокиТЧ.ВидИспользованияРабочегоВремени.ВидВремени В (&СписокНедопустимыхВидовВремени) ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК НедопустимыйВидВремени,
	|	СтрокиТЧ.ДатаНачала КАК ДатаНачала,
	|	ВЫБОР
	|		КОГДА СтрокиТЧ.ДатаОкончания <> &ПустаяДата
	|			ТОГДА НАЧАЛОПЕРИОДА(СтрокиТЧ.ДатаОкончания, ДЕНЬ)
	|		ИНАЧЕ &ПустаяДата
	|	КОНЕЦ КАК ДатаОкончания,
	|	СтрокиТЧ.НомерСтроки КАК НомерСтроки,
	|	СтрокиТЧ.ИндексСтрокиТаблицыОтработанноеВремя КАК ИндексСтрокиТаблицыОтработанноеВремя,
	|	СтрокиТЧ.ВсегоДней КАК ВсегоДней,
	|	СтрокиТЧ.ВсегоДнейПоНорме КАК ВсегоДнейПоНорме,
	|	СтрокиТЧ.ВсегоЧасов КАК ВсегоЧасов,
	|	СтрокиТЧ.ВсегоЧасовПоНорме КАК ВсегоЧасовПоНорме
	|ИЗ
	|	Документ.КорректировкаИспользованияРаботникамиРабочегоВремени.ОтработанноеВремя КАК СтрокиТЧ
	|ГДЕ
	|	СтрокиТЧ.Ссылка = &ДокументСсылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";

	Возврат Запрос.Выполнить();

КонецФункции // СформироватьЗапросПоОтработанноеВремя()

// Проверяет правильность заполнения шапки документа.
// Если какой-то из реквизитов шапки, влияющий на проведение, не заполнен или
// заполнен некорректно, то выставляется флаг отказа в проведении.
// Проверка выполняется по выборке из результата запроса по шапке,
// все проверяемые реквизиты должны быть включены в выборку по шапке.
//
// Параметры: 
//  ВыборкаПоШапкеДокумента	- выборка из результата запроса по шапке документа,
//  Отказ 					- флаг отказа в проведении.
//
Процедура ПроверитьЗаполнениеШапки(ВыборкаПоШапкеДокумента, Отказ, Заголовок = "")

	//  Организация
	Если НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ГоловнаяОрганизация) Тогда
		ОбщегоНазначения.ОшибкаПриПроведении("Не указана организация, по которой вводится рабочее время!", Отказ, Заголовок);
	КонецЕсли;
	
	// ПериодРегистрации
	Если НЕ ЗначениеЗаполнено(ВыборкаПоШапкеДокумента.ПериодРегистрации) Тогда
		ОбщегоНазначения.ОшибкаПриПроведении("Не указан период регистрации!", Отказ, Заголовок);
	КонецЕсли;

КонецПроцедуры // ПроверитьЗаполнениеШапки()

// Проверяет правильность заполнения реквизитов в строке ТЧ "ОтработанноеВремя" документа.
// Если какой-то из реквизтов, влияющий на проведение, не заполнен или
// заполнен некорректно, то выставляется флаг отказа в проведении.
// Проверка выполняется по выборке из результата запроса к ТЧ документа,
// все проверяемые реквизиты должны быть включены в выборку.
//
// Параметры: 
//  ВыборкаПоСтрокамДокумента	- спозиционированная на определеной строке выборка 
//  							  из результата запроса к ТЧ документа, 
//  Отказ 						- флаг отказа в проведении.
//
Процедура ПроверитьЗаполнениеСтрокиОтработанноеВремя(ВыборкаПоШапкеДокумента, ВыборкаПоСтрокамДокумента, Отказ, Заголовок = "", УчетнаяПолитикаПоПерсоналуОрганизации, ПредыдущийИндексСтрокиТаблицыОтработанноеВремя)

	СтрокаНачалаСообщенияОбОшибке = "В строке номер """+ СокрЛП(Строка(ВыборкаПоСтрокамДокумента.ИндексСтрокиТаблицыОтработанноеВремя + 1)) +
									""" табл. части ""Отработанное время"": ";
	
	// т.к. на форме для одной строки может быть несколько колонок, то чтобы одно и тоже сообщение не выводить 
	// по нескольку раз, запомним индекс предыдущей строки
	ПовторяющийсяИндексСтроки = (ПредыдущийИндексСтрокиТаблицыОтработанноеВремя = ВыборкаПоСтрокамДокумента.ИндексСтрокиТаблицыОтработанноеВремя);
										
	ПредыдущийИндексСтрокиТаблицыОтработанноеВремя = ВыборкаПоСтрокамДокумента.ИндексСтрокиТаблицыОтработанноеВремя;

									
	// ФизЛицо
	Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ФизЛицо) Тогда
		Если НЕ ПовторяющийсяИндексСтроки Тогда
			ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "не выбрано физическое лицо!", Отказ, Заголовок);
		КонецЕсли;
	КонецЕсли;

	// Приказ
	Если УчетнаяПолитикаПоПерсоналуОрганизации[Организация].ПоддержкаВнутреннегоСовместительства Тогда
		Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.Приказ) Тогда
			Если НЕ ПовторяющийсяИндексСтроки Тогда
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "не задан приказ на работника!", Отказ, Заголовок);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	// ВидИспользованияРабочегоВремени
	Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ВидИспользованияРабочегоВремени) Тогда
		ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "не указано использование рабочего времени!", Отказ, Заголовок);
	КонецЕсли;

	// Дата начала
	Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ДатаНачала) Тогда
		Если НЕ ПовторяющийсяИндексСтроки Тогда
			ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "не указана дата начала периода!", Отказ, Заголовок);
		КонецЕсли;
	Иначе
		Если НачалоМесяца(ВыборкаПоСтрокамДокумента.ДатаНачала) <> ВыборкаПоШапкеДокумента.ПериодРегистрации Тогда
			Если НЕ ПовторяющийсяИндексСтроки Тогда
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "дата начала периода не совпадает с месяцем, за который составлен документ!", Отказ, Заголовок);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	// Дата окончания
	Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ДатаОкончания) Тогда
		Если НЕ ПовторяющийсяИндексСтроки Тогда
			ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "не указана дата окончания периода!", Отказ, Заголовок);
		КонецЕсли;
	Иначе
		Если НачалоМесяца(ВыборкаПоСтрокамДокумента.ДатаОкончания) <> ВыборкаПоШапкеДокумента.ПериодРегистрации Тогда
			Если НЕ ПовторяющийсяИндексСтроки Тогда
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "дата окончания периода не совпадает с месяцем, за который составлен документ!", Отказ, Заголовок);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	// Режим однодатного ввода
	Если НЕ ВыборкаПоШапкеДокумента.РазвернутыйПериод Тогда
		Если ВыборкаПоСтрокамДокумента.ДатаНачала <> ВыборкаПоСтрокамДокумента.ДатаОкончания Тогда
			Если НЕ ПовторяющийсяИндексСтроки Тогда
				ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "в режиме ввода данных за каждую дату начало и конец периода должны совпадать!", Отказ, Заголовок);
			КонецЕсли;
		КонецЕсли;
		
		Если ВыборкаПоСтрокамДокумента.ВсегоЧасов > 24 Или ВыборкаПоСтрокамДокумента.ВсегоЧасовПоНорме > 24 Тогда
			ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "в режиме ввода данных за каждую дату число часов не должно превышать 24!", Отказ, Заголовок);
		КонецЕсли;
	КонецЕсли;

	// Вид времени
	Если ВыборкаПоСтрокамДокумента.НедопустимыйВидВремени Тогда
		ОбщегоНазначения.ОшибкаПриПроведении(СтрокаНачалаСообщенияОбОшибке + "нельзя в документе указывать " + ВыборкаПоСтрокамДокумента.ВидИспользованияРабочегоВремени, Отказ, Заголовок);
	КонецЕсли;

КонецПроцедуры // ПроверитьЗаполнениеСтрокиНачисления()

// По строке выборок из результатов запроса по документу формируем движения по регистрам
//
// Параметры: 
//  ВыборкаПоСтрокамДокумента				- спозиционированная на определеной строке выборка 
//				  							  из результата запроса к ТЧ документа, 
//	НаборЗаписей							- набор записей для РабочееВремяРаботниковОрганизаций 
// Возвращаемое значение:
//  Нет.
//
Процедура ДобавитьСтрокуОтработанноеВремя(ВыборкаПоСтрокамДокумента, ВыборкаПоШапкеДокумента, НаборЗаписей)

	Движение = НаборЗаписей.Добавить();

	// Свойства
	Движение.Период          					= НачалоДня(ВыборкаПоСтрокамДокумента.ДатаОкончания);

	// Измерения
	Движение.ФизЛицо                    		= ВыборкаПоСтрокамДокумента.ФизЛицо;
	Движение.Организация						= ВыборкаПоШапкеДокумента.ГоловнаяОрганизация;
	Движение.Приказ	                    		= ВыборкаПоСтрокамДокумента.Приказ;
	Движение.ВидИспользованияРабочегоВремени 	= ВыборкаПоСтрокамДокумента.ВидИспользованияРабочегоВремени;

	// Ресурсы
	Движение.Дней								= ВыборкаПоСтрокамДокумента.ВсегоДней;
	Движение.Часов								= ВыборкаПоСтрокамДокумента.ВсегоЧасов;
	Движение.ДнейПоНорме						= ВыборкаПоСтрокамДокумента.ВсегоДнейПоНорме;
	Движение.ЧасовПоНорме						= ВыборкаПоСтрокамДокумента.ВсегоЧасовПоНорме;

	// Реквизиты
	Движение.СводнаяЗапись  	                = (ВыборкаПоСтрокамДокумента.ВсегоДней > 1) 
												  Или (ВыборкаПоСтрокамДокумента.ДатаНачала <> ВыборкаПоСтрокамДокумента.ДатаОкончания);
КонецПроцедуры // ДобавитьСтрокуОтработанноеВремя()

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаПроведения(Отказ, Режим)
	// Получим реквизиты шапки из запроса
	ВыборкаПоШапкеДокумента = СформироватьЗапросПоШапке().Выбрать();
	
	// Заголовок для сообщений об ошибках проведения.
	Заголовок = ОбщегоНазначения.ПредставлениеДокументаПриПроведении(Ссылка);
	
	// Проверка ручной корректировки
	Если ОбщегоНазначения.РучнаяКорректировкаОбработкаПроведения(РучнаяКорректировка,Отказ,Заголовок,ЭтотОбъект) Тогда
		Возврат
	КонецЕсли;
	
	Если ВыборкаПоШапкеДокумента.Следующий() Тогда

		//Надо позвать проверку заполнения реквизитов шапки
		ПроверитьЗаполнениеШапки(ВыборкаПоШапкеДокумента, Отказ, Заголовок);

		// Движения стоит добавлять, если в проведении еще не отказано (отказ =ложь)
		Если НЕ Отказ Тогда

			////////////////////////////////////////////////////////////////////////
			// Отработанное время

			// получим реквизиты табличной части
			ВыборкаПоОтработанноеВремя = СформироватьЗапросПоОтработанноеВремя(ВыборкаПоШапкеДокумента).Выбрать();
			УчетнаяПолитикаПоПерсоналуОрганизации = глЗначениеПеременной("глУчетнаяПолитикаПоПерсоналуОрганизации");

			ПредыдущийИндексСтрокиТаблицыОтработанноеВремя = -1;

			Пока ВыборкаПоОтработанноеВремя.Следующий() Цикл 

				// проверим очередную строку табличной части
				ПроверитьЗаполнениеСтрокиОтработанноеВремя(ВыборкаПоШапкеДокумента, ВыборкаПоОтработанноеВремя, Отказ, Заголовок, УчетнаяПолитикаПоПерсоналуОрганизации, ПредыдущийИндексСтрокиТаблицыОтработанноеВремя);
				Если НЕ Отказ Тогда
					// Заполним записи в наборах записей регистров
					ДобавитьСтрокуОтработанноеВремя(ВыборкаПоОтработанноеВремя, ВыборкаПоШапкеДокумента, Движения.РабочееВремяРаботниковОрганизаций);
				КонецЕсли;
			КонецЦикла;

		КонецЕсли; 

	КонецЕсли;

КонецПроцедуры

// Предопределенная процедура обработки события удаления проведения документа
//
Процедура ОбработкаУдаленияПроведения(Отказ)
	ОбщегоНазначения.УдалитьДвиженияРегистратора(ЭтотОбъект, Отказ, РучнаяКорректировка);
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат
	КонецЕсли;
	
	КраткийСоставДокумента = ПроцедурыУправленияПерсоналом.ЗаполнитьКраткийСоставДокумента(ОтработанноеВремя);
	
КонецПроцедуры
