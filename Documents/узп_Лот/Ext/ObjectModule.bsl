#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
		
	фин_ЗаполнениеДокументов.ЗаполнитьШапкуДокумента(ЭтотОбъект, фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("ВалютаРегламентированногоУчета"));
	ИспользоватьХарактеристики = фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("узп_ИспользоватьХарактеристикиНоменклатурыПриПланированииЗакупок");
	ИспользоватьПроекты = фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("узп_ВестиУчетЗакупокПоПроектам");
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.узп_ПланЗакупок") Тогда
		Организация = ДанныеЗаполнения.Организация;
		СтруктурноеПодразделение = ДанныеЗаполнения.СтруктурноеПодразделение;
		ДокументОснование = ДанныеЗаполнения.Ссылка; 
		Товары.Очистить();
		ТоварыИсточника = ДанныеЗаполнения.Товары.Выгрузить();
		//ТоварыИсточника.Свернуть("Номенклатура, Характеристика, Заявка","Количество");
		Если ИспользоватьХарактеристики Тогда
			СтрокаХарактеристика = ", Характеристика";
		Иначе
			СтрокаХарактеристика = "";
		КонецЕсли;
		Если ИспользоватьПроекты Тогда
			СтрокаПроект = ", Проект";
		Иначе
			СтрокаПроект = "";
		КонецЕсли;
		ТоварыИсточника.Свернуть("Номенклатура, Заявка, Подразделение, ОбъектРемонта" + СтрокаХарактеристика + СтрокаПроект,"Количество");
		//Если ИспользоватьПроекты Тогда
		//	ТоварыИсточника.Свернуть("Номенклатура, Характеристика, Заявка, Подразделение, ОбъектРемонта, Проект","Количество");
		//Иначе
		//	ТоварыИсточника.Свернуть("Номенклатура, Характеристика, Заявка, Подразделение, ОбъектРемонта","Количество");
		//КонецЕсли;
		Для Каждого СтрокаТЧ Из ТоварыИсточника Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.Номенклатура = СтрокаТЧ.Номенклатура;
			Если ИспользоватьХарактеристики Тогда
				НоваяСтрока.Характеристика = СтрокаТЧ.Характеристика;
			КонецЕсли;
			НоваяСтрока.Количество 		= СтрокаТЧ.Количество;
			НоваяСтрока.ЗаявкаМТС 		= СтрокаТЧ.Заявка;
			НоваяСтрока.Подразделение 	= СтрокаТЧ.Подразделение;
			НоваяСтрока.ОбъектРемонта 	= СтрокаТЧ.ОбъектРемонта;
			Если ИспользоватьПроекты Тогда
				НоваяСтрока.Проект 		= СтрокаТЧ.Проект;
			КонецЕсли;
		КонецЦикла;
		УслугиИсточника = ДанныеЗаполнения.Услуги.Выгрузить();
		УслугиИсточника.Свернуть("Номенклатура, Заявка, Подразделение, ОбъектРемонта" + СтрокаХарактеристика + СтрокаПроект,"Количество");
		//Если ИспользоватьПроекты Тогда
		//	УслугиИсточника.Свернуть("Номенклатура, Характеристика, Заявка, Подразделение, ОбъектРемонта, Проект","Количество");
		//Иначе
		//	УслугиИсточника.Свернуть("Номенклатура, Характеристика, Заявка, Подразделение, ОбъектРемонта","Количество");
		//КонецЕсли;
		Для Каждого СтрокаТЧ Из УслугиИсточника Цикл
			НоваяСтрока = Товары.Добавить();
			НоваяСтрока.Номенклатура = СтрокаТЧ.Номенклатура;
			Если ИспользоватьХарактеристики Тогда
				НоваяСтрока.Характеристика = СтрокаТЧ.Характеристика;
			КонецЕсли;
			НоваяСтрока.Количество 		= СтрокаТЧ.Количество;
			НоваяСтрока.ЗаявкаМТС 		= СтрокаТЧ.Заявка;
			НоваяСтрока.Подразделение 	= СтрокаТЧ.Подразделение;
			НоваяСтрока.ОбъектРемонта 	= СтрокаТЧ.ОбъектРемонта;
			Если ИспользоватьПроекты Тогда
				НоваяСтрока.Проект 		= СтрокаТЧ.Проект;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	ИспользоватьХарактеристики = фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("узп_ИспользоватьХарактеристикиНоменклатурыПриПланированииЗакупок");
	// регистр узп_ПозицииЛота
	Движения.узп_ПозицииЛота.Записывать = Истина;
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		Движение = Движения.узп_ПозицииЛота.Добавить();
		Движение.Лот = Ссылка;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.Количество = ТекСтрокаТовары.Количество;
		Если ИспользоватьХарактеристики Тогда
			Движение.Характеристика = ТекСтрокаТовары.Характеристика;
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

#КонецЕсли
