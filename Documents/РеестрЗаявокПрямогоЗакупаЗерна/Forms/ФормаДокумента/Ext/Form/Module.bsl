
&НаКлиенте
Процедура ЗаполнитьЗаявки(Команда)
	Если ЗначениеЗаполнено(Объект.НачПериода) и ЗначениеЗаполнено(Объект.КонПериода) Тогда
		Если Объект.СписокЗаявок.Количество()>0 Тогда
			Ответ = Вопрос("Список заявок будет очищен. Продолжить?", РежимДиалогаВопрос.ДаНет);
			Если Ответ = КодВозвратаДиалога.Да Тогда 
				Объект.СписокЗаявок.Очистить();
				ЗаполнитьЗаявкиНаСервере();
				  Модифицированность = истина;

			Иначе
				Возврат;
			КонецЕсли;
		Иначе
			ЗаполнитьЗаявкиНаСервере();
		КонецЕсли;
	Иначе
		СП = Новый СообщениеПользователю;
		СП.Текст = "Заполните период заполнения!";
		СП.Сообщить();
	КонецЕсли;
	  
КонецПроцедуры

Процедура ЗаполнитьЗаявкиНаСервере()
   	Док = РеквизитФормыВЗначение("Объект");

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаявкаНаПрямойЗакупЗерна.Ссылка,
		|	ЗаявкаНаПрямойЗакупЗерна.СтатусЗаявки
		|ИЗ
		|	Документ.ЗаявкаНаПрямойЗакупЗерна КАК ЗаявкаНаПрямойЗакупЗерна
		|ГДЕ
		|	ЗаявкаНаПрямойЗакупЗерна.Дата МЕЖДУ &НачПериода И &КонПериода
		|	И ЗаявкаНаПрямойЗакупЗерна.ПометкаУдаления = ЛОЖЬ
		|	И ЗаявкаНаПрямойЗакупЗерна.Организация = &Организация";

	Запрос.УстановитьПараметр("КонПериода", КонецДня(Объект.КонПериода));
	Запрос.УстановитьПараметр("Организация", объект.Организация);

	Запрос.УстановитьПараметр("НачПериода", НачалоДня(Объект.НачПериода));

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НовСтр = Док.СписокЗаявок.Добавить();
		НовСтр.Заявка = ВыборкаДетальныеЗаписи.Ссылка;
		НовСтр.Статус = ВыборкаДетальныеЗаписи.СтатусЗаявки;
	КонецЦикла;

	ЗначениеВРеквизитФормы(Док,"Объект");
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	Объект.СтруктурноеПодразделение = Неопределено;
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	ОповеститьОбИзменении(ПредопределенноеЗначение("Документ.цс_ЗаявкаНаФинасирование.ПустаяСсылка"));
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	НеИзменять = Ложь;
	Док = РеквизитФормыВЗначение("Объект");
	
	Элементы.Организация.ТолькоПросмотр = Не УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(ЦС_ОбщегоНазначенияКлиентСерверПовтИсп.ТекущийПользователь(), "УчетПоВсемОрганизациям");
	
	Если ЦС_ОбщегоНазначенияКлиентСерверПовтИсп.ПолучитьПризнакОтображенияСтруктурныхПодразделений() Тогда
		Элементы.СтруктурноеПодразделение.Видимость = Истина;
	КонецЕсли;
	
	//НастройкаПравДоступа.УстановитьДоступностьФормыДляРедактирования(Док, ЭтаФорма);
	
	ТолькоПросмотр = НеИзменять;
	
	Если Параметры.Ключ.Пустая() тогда
		Объект.НачПериода = НачалоДня(ТекущаяДата());
		Объект.КонПериода = КонецДня(ТекущаяДата());
	КонецЕсли;
	
	Если не (РольДоступна("ПолныеПрава") или РольДоступна("УтверждениеЗаявокФорвардногоЗакупа")) тогда
		ТолькоПросмотр = Истина;	
	КонецЕсли;
	Статус = ПредопределенноеЗначение("Перечисление.цс_СтатусЗаявкиФорвардныйЗакуп.Одобрена");
КонецПроцедуры

&НаКлиенте
Процедура СтруктурноеПодразделениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	СтруктураПараметров = Новый Структура("Организация, ОргИзменять", Объект.Организация,Элементы.Организация.ТолькоПросмотр);
	ВыбранныйЭлем = ОткрытьФормуМодально("ОбщаяФорма.ЦС_ФормаВыбораСтрукЕдУпр", СтруктураПараметров);

	Если ВыбранныйЭлем <> Неопределено Тогда
		Объект.СтруктурноеПодразделение	= ВыбранныйЭлем.СтруктурноеПодразделение;
		Если Объект.Организация <> ВыбранныйЭлем.организация Тогда
			 Объект.Организация = ВыбранныйЭлем.организация
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ВыделитьВсе(Команда)
	Для каждого СтрокаТЧ из Объект.СписокЗаявок Цикл
		СтрокаТЧ.Отметка = истина;	
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура СнятьВыделение(Команда)
	Для каждого строкатч из объект.СписокЗаявок Цикл
		СтрокаТЧ.Отметка = ложь;	
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура УстановитьСтатусДляОтмеченных(Команда)
	Модифицированность = Истина;
	Для Каждого строкатч из объект.СписокЗаявок Цикл
		Если строкатч.отметка тогда
		строкатч.статус = Статус;	
		КонецЕсли;
	КонецЦикла;// Вставить содержимое обработчика.
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	Для каждого строкатч из текущийобъект.СписокЗаявок цикл
		
		Если строкатч.заявка.организация <> текущийобъект.организация тогда
			Сообщить("Имеются заявки, не относящиеся к этой организации");
			Отказ = Истина;
		КонецЕсли;
		
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура СменаОтметки(Команда)
	Для каждого СтрокаТЧ из Объект.СписокЗаявок Цикл
		Если СтрокаТЧ.Отметка Тогда
			СтрокаТЧ.Отметка = Ложь;	
		Иначе
			СтрокаТЧ.Отметка = Истина;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
