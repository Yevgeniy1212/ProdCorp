&НаКлиенте
//Хранит настройку пользователя "Открывать настройку движений"
Перем ОткрыватьНастройкуДвижений;


&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)	
	Объект.СтруктурноеПодразделение = Неопределено;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	НеИзменять = Ложь;
	Док = РеквизитФормыВЗначение("Объект");
	
	//ЦС_ОбщегоНазначенияСервер.ЗаполнитьРеквизитыПриСозданииНаСервере(ЭтаФорма,Объект);
	
	
	Элементы.Организация.ТолькоПросмотр = Не УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(ЦС_ОбщегоНазначенияКлиентСерверПовтИсп.ТекущийПользователь(), "УчетПоВсемОрганизациям");
	
	Если ЦС_ОбщегоНазначенияКлиентСерверПовтИсп.ПолучитьПризнакОтображенияСтруктурныхПодразделений() Тогда
		Элементы.СтруктурноеПодразделение.Видимость = Истина;
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура СтруктурноеПодразделениеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	СтруктураПараметров = Новый Структура("Организация, ОргИзменять", Объект.Организация,Элементы.Организация.ТолькоПросмотр);
	ВыбранныйЭлем = ОткрытьФормуМодально("ОбщаяФорма.ЦС_ФормаВыбораСтрукЕдУпр", СтруктураПараметров);

	Если ВыбранныйЭлем <> Неопределено Тогда
		Объект.СтруктурноеПодразделение	= ВыбранныйЭлем.СтруктурноеПодразделение;
		Если Объект.Организация <> ВыбранныйЭлем.организация Тогда
			 Объект.Организация = ВыбранныйЭлем.организация
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ОткрыватьНастройкуДвижений = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(ЦС_ОбщегоНазначенияКлиентСерверПовтИсп.ТекущийПользователь(), "ПоказыватьДвиженияПриПроведении");	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	ОбщегоНазначения.РучнаяКорректировкаОсновнаяФормаПослеЗаписи(Объект.Проведен,ОткрыватьНастройкуДвижений,Объект.Ссылка);
КонецПроцедуры

&НаКлиенте
// Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ОсновныеДействияФормыНастройка(Кнопка)
	
	ОсновныеДействияФормыНастройкаНаСервере();
    	
КонецПроцедуры

&НаСервере
// Процедура отрабатывает печать движений документа по регистрам.
//
Процедура ОсновныеДействияФормыНастройкаНаСервере()
	ОбщегоНазначения.РучнаяКорректировкаОсновнаяФорма(Параметры.Ключ.Пустая(),Объект.Ссылка, Ложь);	   	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТаблицу(Команда)
	если не ПроверитьЗаполнение() тогда
		Возврат
	КонецЕсли;

	Если Объект.РасчетнаяТаблица.Количество()>0 Тогда
		ТекстВопроса = "Перед заполнением табличная часть будет очищена.Продолжить ?";
		Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да,);
		Если Ответ <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
		Объект.РасчетнаяТаблица.Очистить();
	КонецЕсли;
	ЗаполнитьТаблицуНаСервере(Объект.Дата,Объект.Ссылка);
КонецПроцедуры

Процедура ЗаполнитьТаблицуНаСервере(Дата,Ссылка = Неопределено)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТиповойОстатки.Субконто1 КАК Контрагент,
	|	ТиповойОстатки.Субконто2 КАК ДоговорКонтрагента,
	|	ТиповойОстатки.Субконто3 КАК ТипыОперации,
	|	ТиповойОстатки.СуммаОстаток КАК СуммаОст,
	|	ЗарегистрированныеГарантии.СуммаОстаток КАК ЗарегистрированаГарантия
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	РегистрБухгалтерии.Типовой.Остатки(
	|			&ДатаДок,
	|			Счет = &СчетБУ,
	|			,
	|			ИСТИНА
	|				И Субконто3 = &ТипОперации) КАК ТиповойОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Типовой.Остатки(
	|				,
	|				Счет = &СчетГарантий,
	|				&ВидыСубконто,
	|				Организация = &Организация
	|					И Субконто3 = &ТипОперации) КАК ЗарегистрированныеГарантии
	|		ПО ТиповойОстатки.Субконто1 = ЗарегистрированныеГарантии.Субконто1
	|			И ТиповойОстатки.Субконто2 = ЗарегистрированныеГарантии.Субконто2
	|			И ТиповойОстатки.Субконто3 = ЗарегистрированныеГарантии.Субконто3
	|			И ТиповойОстатки.Организация = ЗарегистрированныеГарантии.Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Контрагент,
	|	ВТ.ДоговорКонтрагента,
	|	ВТ.ТипыОперации,
	|	ВТ.СуммаОст,
	|	ВТ.ЗарегистрированаГарантия - ЕСТЬNULL(ВложенныйЗапрос.СуммаОборотДт, 0) КАК ЗарегистрированаГарантия,
	|	ВложенныйЗапрос.СуммаОборотДт
	|ИЗ
	|	ВТ КАК ВТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ТиповойОбороты.Субконто1 КАК Субконто1,
	|			ТиповойОбороты.Субконто2 КАК Субконто2,
	|			ТиповойОбороты.Субконто3 КАК Субконто3,
	|			ТиповойОбороты.СуммаОборотДт КАК СуммаОборотДт
	|		ИЗ
	|			РегистрБухгалтерии.Типовой.Обороты(
	|					,
	|					,
	|					Регистратор,
	|					Счет = &СчетГарантий,
	|					&ВидыСубконто,
	|					Организация = &Организация
	|						И Субконто3 = &ТипОперации,
	|					,
	|					) КАК ТиповойОбороты
	|		ГДЕ
	|			ТиповойОбороты.Регистратор = &Регистратор) КАК ВложенныйЗапрос
	|		ПО ВТ.Контрагент = ВложенныйЗапрос.Субконто1
	|			И ВТ.ДоговорКонтрагента = ВложенныйЗапрос.Субконто2
	|			И ВТ.ТипыОперации = ВложенныйЗапрос.Субконто3
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ.Контрагент.Наименование";
	
	Период = Дата;
	
	Если Ссылка <> Неопределено тогда
		Если Ссылка.Проведен тогда
			Период = Ссылка.МоментВремени();			
		КонецЕсли;
	КонецЕсли;
	
	
	ВидыСубконто = новый Массив;
	ВидыСубконто.Добавить(ПредопределенноеЗначение("ПланВидовХарактеристик.ВидыСубконтоТиповые.Контрагенты"));
	ВидыСубконто.Добавить(ПредопределенноеЗначение("ПланВидовХарактеристик.ВидыСубконтоТиповые.Договоры"));
	ВидыСубконто.Добавить(ПредопределенноеЗначение("ПланВидовХарактеристик.ВидыСубконтоТиповые.ТипыОпераций"));
	Запрос.УстановитьПараметр("ДатаДок"		, Период);
	Запрос.УстановитьПараметр("Организация"	, Объект.Организация);
	Запрос.УстановитьПараметр("СчетБУ"		, Объект.СчетБУ);
	Запрос.УстановитьПараметр("СчетГарантий", Объект.СчетГарантии);
	Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
	Запрос.УстановитьПараметр("ТипОперации"	, Объект.ТипОперации);
	Запрос.УстановитьПараметр("Регистратор"	, Объект.Ссылка);
	Если объект.ТипОперации.Пустая() тогда
		Запрос.Текст = СтрЗаменить(запрос.Текст, "И Субконто3 = &ТипОперации", " ");
	КонецЕсли;
	
	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НовСтр = Объект.РасчетнаяТаблица.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр,ВыборкаДетальныеЗаписи);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТаблицуКонцомДня(Команда)
	
	Если Объект.РасчетнаяТаблица.Количество()>0 Тогда
		ТекстВопроса = "Перед заполнением табличная часть будет очищена.Продолжить ?";
		Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да,);
		Если Ответ <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
		Объект.РасчетнаяТаблица.Очистить();
	КонецЕсли;
	ЗаполнитьТаблицуНаСервере(Новый граница(Объект.Дата,ВидГраницы.Включая));

КонецПроцедуры

&НаКлиенте
Процедура УдалитьСтрокиСУдовлетворяющейГарантией(Команда)
	
	МассивУдаляемыхСтрок = Новый массив;
	
	Для Каждого СтрокаТЧ Из Объект.РасчетнаяТаблица Цикл
		Если СтрокаТЧ.ЗарегистрированаГарантия >= СтрокаТЧ.СуммаОст 
			И СтрокаТЧ.суммаОст > 0 тогда
			МассивУдаляемыхСтрок.Добавить(СтрокаТЧ);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого УдаляемаяСтрока из МассивУдаляемыхСтрок Цикл
		объект.РасчетнаяТаблица.Удалить(УдаляемаяСтрока);	
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура РасчетнаяТаблицаПриИзменении(Элемент)
	РассчитатьСуммуДокумента(ЭтаФорма);
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура РассчитатьСуммуДокумента(Форма)
	Объект = Форма.Объект;
	//Объект.СуммаДокумента = Объект.РасчетнаяТаблица.Итог("")
КонецПроцедуры


