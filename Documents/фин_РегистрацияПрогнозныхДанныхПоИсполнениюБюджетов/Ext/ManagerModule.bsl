#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
	
////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС


////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ


////////////////////////////////////////////////////////////////////////////////
// Заполнение

Процедура ЗаполнитьПоОснованию(Объект, ДокументОснование) Экспорт
	
	Если ТипЗнч(ДокументОснование) = Тип("Структура") Тогда
	
		фин_ПроцедурыМеханизмовБюджетирования.ЗаполнитьДокументРегистрацииФактаПоОстаткамОтчета(Объект, ДокументОснование);
		
	КонецЕсли;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// Проведение

Функция ПодготовитьПараметрыПроведения(ДокументСсылка, Отказ) Экспорт
	
	ПереопределяемыеТаблицы = Новый Массив;
	ПереопределяемыеТаблицы.Добавить("БюджетныеОперации");
	
	ДополнительныеПараметрыЗапросов = Новый Структура;
	ДополнительныеПараметрыЗапросов.Вставить("ВалютаУпрУчета",фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("ВалютаУправленческогоУчета"));
	ДополнительныеПараметрыЗапросов.Вставить("БюджетированиеПоОрганизациям",фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("БюджетированиеПоОрганизациям"));
	
	ПараметрыПроведения = фин_УправлениеПроведениемДокументовСервер.ПодготовитьПараметрыПроведения(ДокументСсылка, Отказ,,,,,,ПереопределяемыеТаблицы,ДополнительныеПараметрыЗапросов);
	
	Возврат ПараметрыПроведения;

КонецФункции 

Функция ТекстЗапросаБюджетныеОперации(НомераТаблиц,ПараметрыПроведения, Реквизиты)  Экспорт

	ТекстЗапроса = "";
	
	Если НЕ Реквизиты["ЕстьБюджетныеОперации"] Тогда
		ПараметрыПроведения.Вставить("ТаблицаБюджетныеОперации", Неопределено);
	Иначе
	ТекстЗапроса="ВЫБРАТЬ
	             |	БюджетныеОперации.Ссылка,
	             |	БюджетныеОперации.Ссылка.Дата КАК Дата,
	             |	БюджетныеОперации.НомерСтроки,
	             |	БюджетныеОперации.Период,
	             |	БюджетныеОперации.ФинансовыйПоказатель,
	             |	БюджетныеОперации.УправленческоеПодразделение,
	             |	БюджетныеОперации.Проект,
	             |	БюджетныеОперации.Контрагент,
	             |	БюджетныеОперации.Номенклатура,
	             |	БюджетныеОперации.Валюта,
	             |	БюджетныеОперации.Количество,
	             |	БюджетныеОперации.Сумма,
	             |	БюджетныеОперации.Регистратор,
	             |	БюджетныеОперации.Разрез1,
	             |	БюджетныеОперации.Разрез10,
	             |	БюджетныеОперации.Разрез2,
	             |	БюджетныеОперации.Разрез3,
	             |	БюджетныеОперации.Разрез4,
	             |	БюджетныеОперации.Разрез5,
	             |	БюджетныеОперации.Разрез6,
	             |	БюджетныеОперации.Разрез7,
	             |	БюджетныеОперации.Разрез8,
	             |	БюджетныеОперации.Разрез9,
	             |	БюджетныеОперации.ДополнительныеРазрезы,
	             |	БюджетныеОперации.Ссылка.Организация
	             |ПОМЕСТИТЬ ВТ_Операции
	             |ИЗ
	             |	Документ.фин_РегистрацияПрогнозныхДанныхПоИсполнениюБюджетов.БюджетныеОперации КАК БюджетныеОперации
	             |ГДЕ
	             |	БюджетныеОперации.Ссылка = &Ссылка
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПериодПоследнейЗаписиКурсаНаДатуОборота.Дата КАК Дата,
	             |	КурсыВалют.Курс КАК Курс,
	             |	КурсыВалют.Кратность КАК Кратность,
	             |	КурсыВалют.Валюта КАК Валюта
	             |ПОМЕСТИТЬ ВТ_КурсыОперации
	             |ИЗ
	             |	РегистрСведений.КурсыВалют КАК КурсыВалют
	             |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	             |			МАКСИМУМ(КурсыВнутр.Период) КАК Период,
	             |			Обороты.Дата КАК Дата,
	             |			КурсыВнутр.Валюта КАК Валюта
	             |		ИЗ
	             |			РегистрСведений.КурсыВалют КАК КурсыВнутр
	             |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |					УчетФактическихДанныхПоБюджетамБюджетныеОперации.Период КАК Дата,
	             |					УчетФактическихДанныхПоБюджетамБюджетныеОперации.Валюта КАК ВалютаДок
	             |				ИЗ
	             |					ВТ_Операции КАК УчетФактическихДанныхПоБюджетамБюджетныеОперации) КАК Обороты
	             |				ПО (Обороты.Дата >= КурсыВнутр.Период)
	             |					И КурсыВнутр.Валюта = Обороты.ВалютаДок
	             |		
	             |		СГРУППИРОВАТЬ ПО
	             |			Обороты.Дата,
	             |			КурсыВнутр.Валюта) КАК ПериодПоследнейЗаписиКурсаНаДатуОборота
	             |		ПО КурсыВалют.Период = ПериодПоследнейЗаписиКурсаНаДатуОборота.Период
	             |			И КурсыВалют.Валюта = ПериодПоследнейЗаписиКурсаНаДатуОборота.Валюта
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ПериодПоследнейЗаписиКурсаНаДатуОборота.Дата КАК Дата,
	             |	КурсыВалют.Курс КАК Курс,
	             |	КурсыВалют.Кратность КАК Кратность
	             |ПОМЕСТИТЬ ВТ_КурсыУпрУчета
	             |ИЗ
	             |	РегистрСведений.КурсыВалют КАК КурсыВалют
	             |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	             |			МАКСИМУМ(КурсыВнутр.Период) КАК Период,
	             |			Обороты.Дата КАК Дата
	             |		ИЗ
	             |			РегистрСведений.КурсыВалют КАК КурсыВнутр
	             |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	             |					ОперацииДата.Период КАК Дата
	             |				ИЗ
	             |					ВТ_Операции КАК ОперацииДата) КАК Обороты
	             |				ПО (Обороты.Дата >= КурсыВнутр.Период)
	             |					И (КурсыВнутр.Валюта = &ВалютаУпрУчета)
	             |		
	             |		СГРУППИРОВАТЬ ПО
	             |			Обороты.Дата) КАК ПериодПоследнейЗаписиКурсаНаДатуОборота
	             |		ПО КурсыВалют.Период = ПериодПоследнейЗаписиКурсаНаДатуОборота.Период
	             |ГДЕ
	             |	КурсыВалют.Валюта = &ВалютаУпрУчета
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	БюджетныеОперацииДокумент.Ссылка КАК ДокументПланирования,
	             |	БюджетныеОперацииДокумент.Дата КАК Период,
	             |	БюджетныеОперацииДокумент.Валюта КАК Валюта,
	             |	БюджетныеОперацииДокумент.УправленческоеПодразделение КАК УправленческоеПодразделение,
	             |	БюджетныеОперацииДокумент.Проект КАК Проект,
	             |	БюджетныеОперацииДокумент.Контрагент КАК Контрагент,
	             |	БюджетныеОперацииДокумент.Номенклатура КАК Номенклатура,
	             |	БюджетныеОперацииДокумент.ДополнительныеРазрезы КАК ДополнительныеРазрезы,
	             |	БюджетныеОперацииДокумент.ФинансовыйПоказатель КАК ФинансовыйПоказатель,
	             |	СУММА(БюджетныеОперацииДокумент.Сумма) КАК ВалютнаяСумма,
	             |	СУММА(БюджетныеОперацииДокумент.Количество) КАК Количество,
	             |	СУММА(ВЫРАЗИТЬ(ВЫБОР
	             |				КОГДА БюджетныеОперацииДокумент.Валюта = &ВалютаУпрУчета
	             |					ТОГДА БюджетныеОперацииДокумент.Сумма
	             |				КОГДА БюджетныеОперацииДокумент.Валюта <> &ВалютаУпрУчета
	             |						И КурсыОперации.Курс <> 0
	             |						И КурсыУпрУчета.Курс <> 0
	             |					ТОГДА БюджетныеОперацииДокумент.Сумма * КурсыОперации.Курс * КурсыУпрУчета.Кратность / (КурсыУпрУчета.Курс * КурсыОперации.Кратность)
	             |				ИНАЧЕ 0
	             |			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СуммаУпр,
	             |	БюджетныеОперацииДокумент.Период КАК ПериодПланирования,
	             |	ВЫБОР
	             |		КОГДА &БюджетированиеПоОрганизациям
	             |			ТОГДА БюджетныеОперацииДокумент.Организация
	             |		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	             |	КОНЕЦ КАК Организация
	             |ИЗ
	             |	ВТ_Операции КАК БюджетныеОперацииДокумент
	             |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КурсыОперации КАК КурсыОперации
	             |		ПО (КурсыОперации.Дата = БюджетныеОперацииДокумент.Период)
	             |			И (КурсыОперации.Валюта = БюджетныеОперацииДокумент.Валюта)
	             |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КурсыУпрУчета КАК КурсыУпрУчета
	             |		ПО (КурсыУпрУчета.Дата = БюджетныеОперацииДокумент.Период)
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	БюджетныеОперацииДокумент.Ссылка,
				 |	БюджетныеОперацииДокумент.Дата,
	             |	БюджетныеОперацииДокумент.Период,
	             |	БюджетныеОперацииДокумент.Валюта,
	             |	БюджетныеОперацииДокумент.УправленческоеПодразделение,
	             |	БюджетныеОперацииДокумент.ДополнительныеРазрезы,
	             |	БюджетныеОперацииДокумент.Проект,
	             |	БюджетныеОперацииДокумент.Контрагент,
	             |	БюджетныеОперацииДокумент.Номенклатура,
	             |	БюджетныеОперацииДокумент.ФинансовыйПоказатель,
	             |	БюджетныеОперацииДокумент.Период,
	             |	ВЫБОР
	             |		КОГДА &БюджетированиеПоОрганизациям
	             |			ТОГДА БюджетныеОперацииДокумент.Организация
	             |		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	             |	КОНЕЦ";

		ТекстЗапроса = ТекстЗапроса + фин_УправлениеПроведениемДокументовСервер.ТекстРазделителяЗапросовПакета();
		НомераТаблиц.Вставить("ВТ_Операции",  НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_КурсыОперации",  НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ВТ_КурсыУпрУчета",  НомераТаблиц.Количество());
		НомераТаблиц.Вставить("ТаблицаБюджетныеОперации",  НомераТаблиц.Количество());
	КонецЕсли;
	
	Возврат ТекстЗапроса;	
КонецФункции 

////////////////////////////////////////////////////////////////////////////////
// Интерфейс для работы с подсистемой Печать.

// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
КонецПроцедуры

// Формирует печатные формы.
//
// Параметры:
//  МассивОбъектов  - Массив    - ссылки на объекты, которые нужно распечатать;
//  ПараметрыПечати - Структура - дополнительные настройки печати;
//  КоллекцияПечатныхФорм - ТаблицаЗначений - сформированные табличные документы (выходной параметр)
//  ОбъектыПечати         - СписокЗначений  - значение - ссылка на объект;
//                                            представление - имя области в которой был выведен объект (выходной параметр);
//  ПараметрыВывода       - Структура       - дополнительные параметры сформированных табличных документов (выходной параметр).
//
Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
	
	ПараметрыВывода.ДоступнаПечатьПоКомплектно = Истина;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Прочие служебные процедуры и функции


#КонецЕсли