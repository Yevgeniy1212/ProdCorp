
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ТабДок = Новый ТабличныйДокумент; 
	ТабДок.АвтоМасштаб = Истина;

	ПечатьЗаявки(ПараметрКоманды,ТабДок);
	КоличествоЭкземпляров = 1;
	НаПринтер = Ложь;
	УниверсальныеМеханизмы.НапечататьДокумент(ТабДок, КоличествоЭкземпляров, НаПринтер, РаботаСДиалогами.СформироватьЗаголовокДокумента(ПараметрКоманды,"Заявка"));
КонецПроцедуры

&НаСервере
Процедура ПечатьЗаявки(ПараметрКоманды,ТабДок)
	ТабДок.Очистить();
		
	Макет        = БизнесПроцессы.СогласованиеПлатежейПредставительств.ПолучитьМакет("Заявка");
	Шапка        = Макет.ПолучитьОбласть("ОбластьШапка");
	ШапкаТаблицы = Макет.ПолучитьОбласть("ОбластьЗаголовокТаблицы");
	ОблСтрока    = Макет.ПолучитьОбласть("ОбластьСтрокаТаблицы");
	
	ПодписьКурЧП = Макет.ПолучитьОбласть("ПодписьКурЧП");
	ПодписьДирСП = Макет.ПолучитьОбласть("ПодписьДирСП");
	ПодписьМенФД = Макет.ПолучитьОбласть("ПодписьМенФД");
	ПодписьДирФД = Макет.ПолучитьОбласть("ПодписьДирФД");
	ПодписьГБ    = Макет.ПолучитьОбласть("ПодписьГБ");
	ПодписьИсп   = Макет.ПолучитьОбласть("ПодписьИсп");
	
	Подвал       = Макет.ПолучитьОбласть("ОбластьПодвал");
	
	ПодписьКурЧП.Параметры.ДолжКурирующийРуководитель    = "Курирующий руководитель";
	ПодписьДирСП.Параметры.ДолжДирСПИнициатора           = "Директор инициирующего структурного подразделения";
	ПодписьМенФД.Параметры.ДолжМенФД                     = "Главный менеджер/менеджер финансового департамента";
	ПодписьДирФД.Параметры.ДолжДирФД                     = "Директор финансового департамента";
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	 "ВЫБРАТЬ
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Ссылка,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.НомерСтроки,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.КодСтрокиБюджета,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СтатьяБюджета,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ГодовойПлан,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Отклонение,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СуммаПоЗаявке,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ОдобреннаяСумма,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Примечание,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Контрагент,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Договор,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ФактПредыдущегоПериода,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СуммыПредыдущихПлатежей,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ОстатокПланаСУчетомФакта,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ВалютаДокумента,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ДокументПоступления,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ОплаченоПоДоговору,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СуммаДоговора,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ТипОперации,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СтатьяДвиженияДенежныхСредств,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.СчетКонтрагента,
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.ЭСФ
	 |ИЗ
	 |	БизнесПроцесс.СогласованиеПлатежейПредставительств.РасчетнаяТаблица КАК СогласованиеПлатежейПредставительствРасчетнаяТаблица
	 |ГДЕ
	 |	СогласованиеПлатежейПредставительствРасчетнаяТаблица.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", ПараметрКоманды);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	
	Шапка.Параметры.Номер = ПараметрКоманды.Номер;
	Шапка.Параметры.Дата  = Формат(ПараметрКоманды.Дата, "ДФ=dd.MM.yyyy");
	
	ТабДок.Вывести(Шапка);
	ТабДок.Вывести(ШапкаТаблицы);
		
	//получим значения строки
	Пока Выборка.Следующий() Цикл 	
		ОблСтрока.Параметры.Заполнить(Выборка);		
		ТабДок.Вывести(ОблСтрока);	
	КонецЦикла;
	
	Для Каждого Стр из ПараметрКоманды.Подписи Цикл
		
		СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
		ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;	
		
		Если Стр.Этап = БизнесПроцессы.СогласованиеПлатежейПредставительств.ТочкиМаршрута.СогласованиеСКурирующимЧП Тогда
			ПодписьКурЧП.Параметры.ФИОКурирующийРуководитель     = СФио;
			ПодписьКурЧП.Параметры.ДолжКурирующийРуководитель    = ДолжностьДляПечФормы;
			ПодписьКурЧП.Параметры.ДатаКР                        = Стр.Дата;
			ПодписьКурЧП.Параметры.СогласованоКурЧП              = "Утверждено";
			ПодписьКурЧП.Параметры.ФлажокКурЧП		             = "V";	
		ИначеЕсли Стр.Этап =  БизнесПроцессы.СогласованиеПлатежейПредставительств.ТочкиМаршрута.СогласованиеСРП Тогда
			ПодписьДирСП.Параметры.ФИОДирСПИнициатора            = СФио;
			ПодписьДирСП.Параметры.ДолжДирСПИнициатора           = ДолжностьДляПечФормы;
			ПодписьДирСП.Параметры.ДатаДирИницСП                 = Стр.Дата;
			ПодписьДирСП.Параметры.СогласованоДирИницСП          = "Подписано";
			ПодписьДирСП.Параметры.ФлажокДирИницСП		         = "V";
			
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеПлатежейПредставительств.ТочкиМаршрута.СогласованиеСМенеджеромФД Тогда
			ПодписьМенФД.Параметры.ФИОМенФД                      = СФио;
			ПодписьМенФД.Параметры.ДолжМенФД                     = ДолжностьДляПечФормы;
			ПодписьМенФД.Параметры.ДатаМенФД                     = Стр.Дата;
			ПодписьМенФД.Параметры.СогласованоМенФД              = "Согласовано";
			ПодписьМенФД.Параметры.ФлажокМенФД		             = "V";	
			
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеПлатежейПредставительств.ТочкиМаршрута.СогласованиеСРуководителемФД Тогда
			ПодписьДирФД.Параметры.ФИОДирФД                      = СФио;
			ПодписьДирФД.Параметры.ДолжДирФД                     = ДолжностьДляПечФормы;
			ПодписьДирФД.Параметры.ДатаДирФД                     = Стр.Дата;
			ПодписьДирФД.Параметры.СогласованоДирФД              = "Согласовано";
			ПодписьДирФД.Параметры.ФлажокДирФД		             = "V";
		КонецЕсли;
		
	КонецЦикла;
	
	//Стр = ПараметрКоманды.Подписи.Найти(БизнесПроцессы.СогласованиеПлатежейПредставительств.ТочкиМаршрута.СогласованиеСГБ, "Этап");
	//Если Стр <> Неопределено Тогда
	//	СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	//	ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	//-=-=
	СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	//-=-=
	ПодписьГБ.Параметры.ФИОГБ                      = СФио;
	ПодписьГБ.Параметры.ДолжГБ                     = ДолжностьДляПечФормы;
	//ПодписьГБ.Параметры.ДатаГБ                     = Стр.Дата; //-=-=
	//-=-=
	ПодписьГБ.Параметры.ДатаГБ                     = ПараметрКоманды.Дата;
	//-=-=
	ПодписьГБ.Параметры.СогласованоГБ              = "Согласовано";
	ПодписьГБ.Параметры.ФлажокГБ		           = "V";
	//Иначе
	ПодписьГБ.Параметры.ДолжГБ                     = "Главный бухгалтер ";
	//КонецЕсли;

	
	СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	ПодписьИсп.Параметры.ФИОИспСПИнициатора            = СФио;
	ПодписьИсп.Параметры.ДолжИспСПИнициатора           = ДолжностьДляПечФормы;
	ПодписьИсп.Параметры.ДатаИницСП                    = ПараметрКоманды.Дата;
	ПодписьИсп.Параметры.СогласованоИспИниц            = "Согласовано";
	ПодписьИсп.Параметры.ФлажокИспИниц		           = "V";
	
	ТабДок.Вывести(ПодписьКурЧП);
	ТабДок.Вывести(ПодписьДирСП);
	ТабДок.Вывести(ПодписьМенФД);
	ТабДок.Вывести(ПодписьДирФД);
	ТабДок.Вывести(ПодписьГБ);
	ТабДок.Вывести(ПодписьИсп);
		
	Подвал.Параметры.ДатаРеестра             = Формат(ПараметрКоманды.Дата,"ДФ=dd.MM.yyyy");
		
	ТабДок.Вывести(Подвал);
	
КонецПроцедуры	
