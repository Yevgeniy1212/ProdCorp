
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ТабДок = Новый ТабличныйДокумент; 
	ТабДок.АвтоМасштаб = Истина;

	ПечатьРесстр(ПараметрКоманды,ТабДок);
	КоличествоЭкземпляров = 1;
	НаПринтер = Ложь;
	УниверсальныеМеханизмы.НапечататьДокумент(ТабДок, КоличествоЭкземпляров, НаПринтер, РаботаСДиалогами.СформироватьЗаголовокДокумента(ПараметрКоманды,"Реестр платежей "));	
КонецПроцедуры

&НаСервере
Функция ПолучитьСФ(ПарамВыборка);
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПоступлениеТоваровУслуг.Ссылка,
		|	ПоступлениеТоваровУслуг.ТипОперации,
		|	ПоступлениеТоваровУслуг.Склад
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
		|ГДЕ
		|	ПоступлениеТоваровУслуг.Дата МЕЖДУ &Дата1 И &Дата2
		|	И ПоступлениеТоваровУслуг.Склад = &Склад
		|	И ПоступлениеТоваровУслуг.ТипОперации = &ТипОперации";
	
	Запрос.УстановитьПараметр("Дата1", НачалоМесяца(ПарамВыборка.Дата));
	Запрос.УстановитьПараметр("Дата2", КонецМесяца(ПарамВыборка.Дата));
	Запрос.УстановитьПараметр("Склад", ПарамВыборка.Контрагент);
	Запрос.УстановитьПараметр("ТипОперации", Справочники.ТипыОпераций.НайтиПоКоду("ЮР-00135")); //хранение резервного запаса зерна
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ПоследняяСФ = ОбщегоНазначения.НайтиПодчиненныйДокумент(ВыборкаДетальныеЗаписи.Ссылка, "СчетФактураПолученный");
		Если ВыборкаДетальныеЗаписи.Количество() > 1 Тогда
			Сообщить(ПоследняяСФ);
		КонецЕсли;
	КонецЦикла;
	
	Возврат ПоследняяСФ;

КонецФункции

&НаСервере
Процедура ПечатьРесстр(ПараметрКоманды,ТабДок)
	ТабДок.Очистить();
		
	Макет     = БизнесПроцессы.РасчетПоХранениюЗерна.ПолучитьМакет("Реестр");
	Шапка     = Макет.ПолучитьОбласть("Шапка");
	ОблСтрока = Макет.ПолучитьОбласть("Строки");
	ОблСтрокаПоследняя = Макет.ПолучитьОбласть("СтрокаПоследняя");
	Подвал    = Макет.ПолучитьОбласть("Подвал");
	
	Шапка.Параметры.ДатаРеестра = Формат(ПараметрКоманды.Дата,"ДФ=dd.MM.yyyy");
	Шапка.Параметры.НомерРеестра = ПараметрКоманды.Номер;
	ТабДок.Вывести(Шапка);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	 "ВЫБРАТЬ
	 |	РасчетПоХранениюЗернаРасчетЗалог.Ссылка,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ВидРесурса,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Дата,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ОстатокНаНачало,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Приход,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Расход,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ОстатокНаКонец,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ДнейХранения КАК Срок,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Коэффициент,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Тариф,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ТоннаДни КАК Объем,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Сумма КАК ВсегоЗатрат,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Количество,
	 |	РасчетПоХранениюЗернаРасчетЗалог.ДатаНачалаРасчета,
	 |	РасчетПоХранениюЗернаРасчетЗалог.Ссылка.Склад КАК Контрагент,
	 |	""Пшеница"" КАК Культура
	 |ИЗ
	 |	БизнесПроцесс.РасчетПоХранениюЗерна.РасчетЗалог КАК РасчетПоХранениюЗернаРасчетЗалог
	 |ГДЕ
	 |	РасчетПоХранениюЗернаРасчетЗалог.Ссылка = &Ссылка
	 |	И РасчетПоХранениюЗернаРасчетЗалог.Сумма <> 0";
	
	Запрос.УстановитьПараметр("Ссылка", ПараметрКоманды);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	////
	////НомерСтроки = 0;
	////ОбщийОбъем  = 0;
	////ОбщаяСумма = 0;
	////ОбщаяСобственные  = 0;
	////ОбщаяЗаемные = 0;
	////ОбщаяБюджетКредит = 0;
	////ОбщаяРеспБюджет = 0;
	////

	НомерПоследнейСтроки = Выборка.Количество();
	
	НомерСтроки = 1;
	Пока Выборка.Следующий() Цикл
		НужнаяСФ = ПолучитьСФ(Выборка);
		
		ОблСтрока.Параметры.Заполнить(Выборка);
		ОблСтрокаПоследняя.Параметры.Заполнить(Выборка);
		
		ОблСтрока.Параметры.НомерСтроки = НомерСтроки;
		ОблСтрока.Параметры.Расценки = Выборка.Тариф;
		ОблСтрока.Параметры.НомерИДатаСФ = НужнаяСФ;
		////	ОблСтрока.Параметры.ДатаДоговора = Формат(Выборка.ДатаДоговора,"ДФ=dd.MM.yyyy");
		////	//ОблСтрока.Параметры.ДатаЗерновой = Формат(Выборка.ДатаЗерновой,"ДФ=dd.MM.yyyy");
		////	
		////	ОблСтрока.Параметры.Объем = Выборка.Объем;
		////		ОбщийОбъем = ОбщийОбъем + Выборка.Объем;
		////	ОблСтрока.Параметры.СуммаДоговора = Выборка.СуммаДоговора;
		////		ОбщаяСумма = ОбщаяСумма + Выборка.СуммаДоговора;
		////	ОблСтрока.Параметры.Собственные = Выборка.Собственные;
		////		ОбщаяСобственные = ОбщаяСобственные + Выборка.Собственные;
		////	//ОблСтрока.Параметры.Заемные = Выборка.Заемные;
		////	//	ОбщаяЗаемные = ОбщаяЗаемные + Выборка.Заемные;	
		////		
		////	//ОблСтрока.Параметры.БюджетКредит = Выборка.БюджетКредит;
		////	//	ОбщаяБюджетКредит = ОбщаяБюджетКредит + Выборка.БюджетКредит;	
		////		
		////	//ОблСтрока.Параметры.РеспБюджет = Выборка.РеспБюджет;
		////	//	ОбщаяРеспБюджет = ОбщаяРеспБюджет + Выборка.РеспБюджет;	
		
		////	ОблСтрока.Параметры.Примечание = Выборка.Примечание;
		
		////		
		////	Если ТипЗнч(Выборка.Гарантия) = ТипЗнч(Справочники.зм_Гарантии.ПустаяСсылка()) ИЛИ Выборка.Гарантия = Неопределено Тогда
		////		ОблСтрока.Параметры.ДатаГарантии = Формат(Выборка.ГарантияДатаВыдачи,"ДФ=dd.MM.yyyy");
		////	Иначе
		////		ОблСтрока.Параметры.ДатаГарантии = Формат(Выборка.Гарантия.ДатаДоговора,"ДФ=dd.MM.yyyy");
		////		ОблСтрока.Параметры.НомерГарантии = Выборка.Гарантия.НомерДоговора;
		////	КонецЕсли;
		
		////	//ОблСтрока.Параметры.ДатаФактическогоПлатежа = Формат(Выборка.ДатаФактическогоПлатежа,"ДФ=dd.MM.yyyy");
		////	//ОблСтрока.Параметры.ДатаПлатежногоПоручения = Формат(Выборка.ДатаПлатежногоПоручения,"ДФ=dd.MM.yyyy");
		
		ОблСтрокаПоследняя.Параметры.НомерСтроки = ОблСтрока.Параметры.НомерСтроки;
		ОблСтрокаПоследняя.Параметры.Расценки = ОблСтрока.Параметры.Расценки;
		ОблСтрокаПоследняя.Параметры.НомерИДатаСФ = ОблСтрока.Параметры.НомерИДатаСФ;
		
		Если НомерСтроки = 1 Тогда
			//
		Иначе
			ОблСтрока.Параметры.Контрагент = "";
			ОблСтрока.Параметры.Культура = "";
			ОблСтрока.Параметры.НомерИДатаСФ = "";
		КонецЕсли;
		
		Если НомерСтроки = НомерПоследнейСтроки Тогда
			Если НомерПоследнейСтроки = 1 Тогда
				//
			Иначе
				ОблСтрокаПоследняя.Параметры.Контрагент = "";
				ОблСтрокаПоследняя.Параметры.Культура = "";
				ОблСтрокаПоследняя.Параметры.НомерИДатаСФ = "";
			КонецЕсли;
			ТабДок.Вывести(ОблСтрокаПоследняя);
		Иначе
			ТабДок.Вывести(ОблСтрока);
		КонецЕсли;
		
		НомерСтроки = НомерСтроки + 1;
	КонецЦикла;
	
	////// выводим итоговые суммы 	
	////Подвал.Параметры.ИтогоОб = ОбщийОбъем;
	////Подвал.Параметры.ИтогоСумма  = ОбщаяСумма;
	////Подвал.Параметры.ИтогоСоб = ОбщаяСобственные;
	//////Подвал.Параметры.ИтогоЗаем = ОбщаяЗаемные;
	//////Подвал.Параметры.ИтогоБюджетКредит = ОбщаяБюджетКредит;
	//////Подвал.Параметры.ИтогоРеспБюджет = ОбщаяРеспБюджет;
                                   
	// Получаем руководитель 
	Для Каждого Стр из ПараметрКоманды.Подписи Цикл
		сФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
		ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеДолжности(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;

		Если Стр.Этап = БизнесПроцессы.РасчетПоХранениюЗерна.ТочкиМаршрута.СогласованиеСОбластноеПредставительство Тогда
			Подвал.Параметры.ФИООбластноеПредставительство          = сФио;
			Подвал.Параметры.ДолжностьОбластноеПредставительство    = ДолжностьДляПечФормы;
			Подвал.Параметры.ВремяПодписания1     				    = Стр.Дата;
		ИначеЕсли Стр.Этап = БизнесПроцессы.РасчетПоХранениюЗерна.ТочкиМаршрута.СогласованиеСДепартаментУчетаИХранения Тогда
			Подвал.Параметры.ФИОДепартаментУчетаИХранения       = сФио;
			Подвал.Параметры.ДолжностьДепартаментУчетаИХранения = ДолжностьДляПечФормы;
			Подвал.Параметры.ВремяПодписания2    			    = Стр.Дата;
		ИначеЕсли Стр.Этап = БизнесПроцессы.РасчетПоХранениюЗерна.ТочкиМаршрута.СогласованиеСДиректорОбластноеПредставительство Тогда
			Подвал.Параметры.ФИОДиректорОбластноеПредставительство          = сФио;
			Подвал.Параметры.ДолжностьДиректорОбластноеПредставительство    = ДолжностьДляПечФормы;
			Подвал.Параметры.ВремяПодписания3      							= Стр.Дата;
		КонецЕсли;
		
	КонецЦикла;
	
	//сФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	//ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	//Подвал.Параметры.ФИОМенеджераДЗСХП       = сФио;
	//Подвал.Параметры.ДолжностьМенеджераДЗСХП = ДолжностьДляПечФормы;
	//Подвал.Параметры.ВремяПодписания5        = ПараметрКоманды.Дата;
	//Подвал.Параметры.ДатаРеестра             = Формат(ПараметрКоманды.Дата,"ДФ=dd.MM.yyyy");
		
	ТабДок.Вывести(Подвал);
КонецПроцедуры	
