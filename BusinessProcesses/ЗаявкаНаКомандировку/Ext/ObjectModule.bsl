
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	ВалютаДокумента = Константы.ВалютаРегламентированногоУчета.Получить();
	Автор = ПараметрыСеанса.ТекущийПользователь;
	Состояние = Перечисления.ЦС_СостоянияСогласованияПлатежей.ВРаботе;	
	Организация = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(ПараметрыСеанса.ТекущийПользователь,"ОсновнаяОрганизация");
	
КонецПроцедуры

Функция ПолучитьАдресатаДляТекущегоЭтапа(Постановщик,ТочкаЭтапа);
	
	Если ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.ЗаполнениеРаботникомОтчетаОКомандировке Тогда
		Возврат Постановщик;
	ИначеЕсли ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСРуководителемСП Тогда
		 Возврат Согласующий1;
	ИначеЕсли ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСКурирующимЧП Тогда
		Возврат Согласующий2;
	ИначеЕсли ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.ОзнакомлениеСАвансовымОтчетом Тогда
		Возврат ОзнакомитьСОтчетом;
	КонецЕсли;
	
	//Если ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСРуководителемСП Тогда
	//	
	//	Сотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ЭтотОбъект.ФизЛицо);
	//	Подразделение = Сотрудник.ТекущееПодразделениеОрганизации;
	//	
	//		Запрос = Новый Запрос;
	//	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	Бит_АдресацияУведомленийПоКомандировкам.Адресат,
	//	|	Бит_АдресацияУведомленийПоКомандировкам.Пользователь КАК Пользователь
	//	|ИЗ
	//	|	РегистрСведений.Бит_АдресацияУведомленийПоКомандировкам КАК Бит_АдресацияУведомленийПоКомандировкам
	//	|ГДЕ
	//	|	(Бит_АдресацияУведомленийПоКомандировкам.Пользователь = &Пользователь
	//	|			ИЛИ Бит_АдресацияУведомленийПоКомандировкам.Пользователь = &ПустойПользователь)
	//	|	И Бит_АдресацияУведомленийПоКомандировкам.ЭтапМаршрута = &ЭтапМаршрута
	//	|	И Бит_АдресацияУведомленийПоКомандировкам.Подразделение = &Подразделение
	//	|
	//	|УПОРЯДОЧИТЬ ПО
	//	|	Пользователь УБЫВ";
	//	
	//	Запрос.УстановитьПараметр("Пользователь", Постановщик);
	//	Запрос.УстановитьПараметр("ПустойПользователь", Справочники.Пользователи.ПустаяСсылка());
	//	Запрос.УстановитьПараметр("Подразделение", Подразделение);

	//	Запрос.УстановитьПараметр("ЭтапМаршрута", ТочкаЭтапа);
	//	
	//	Результат = Запрос.Выполнить();
	//	Выборка = результат.Выбрать();
	//	Если Выборка.Следующий() тогда
	//		Возврат Выборка.Адресат;
	//	КонецЕсли;
	//	
	//КонецЕсли;
	
	
		Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Бит_АдресацияУведомленийПоКомандировкам.Адресат,
	|	Бит_АдресацияУведомленийПоКомандировкам.Пользователь КАК Пользователь
	|ИЗ
	|	РегистрСведений.Бит_АдресацияУведомленийПоКомандировкам КАК Бит_АдресацияУведомленийПоКомандировкам
	|ГДЕ
	|	(Бит_АдресацияУведомленийПоКомандировкам.Пользователь = &Пользователь
	|			ИЛИ Бит_АдресацияУведомленийПоКомандировкам.Пользователь = &ПустойПользователь)
	|	И Бит_АдресацияУведомленийПоКомандировкам.ЭтапМаршрута = &ЭтапМаршрута
	|
	|УПОРЯДОЧИТЬ ПО
	|	Пользователь УБЫВ";
	
	Запрос.УстановитьПараметр("Пользователь", Постановщик);
	Запрос.УстановитьПараметр("ПустойПользователь", Справочники.Пользователи.ПустаяСсылка());

	Запрос.УстановитьПараметр("ЭтапМаршрута", ТочкаЭтапа);
	
	Результат = Запрос.Выполнить();
	Выборка = результат.Выбрать();
	Если Выборка.Следующий() тогда
		Возврат Выборка.Адресат;
	КонецЕсли;
			
КонецФункции

Процедура ОбработатьЭтап(Постановщик, ТочкаЭтапа,ФормируемыеЗадачи,Отказ, ЯвныйАдресат = Неопределено)
	
	Если ТочкаЭтапа = Справочники.ЦС_ЭтапыМаршрутовБП.ОтправленНаДоработкуАвтором тогда 
		Адресат = Постановщик;
	Иначе    
		Если ЯвныйАдресат = Неопределено тогда
			Адресат = ПолучитьАдресатаДляТекущегоЭтапа(Постановщик,ТочкаЭтапа);
		Иначе
			Адресат = ЯвныйАдресат;	
		КонецЕсли;
		
	КонецЕсли;
	
	Если Адресат = Неопределено или Адресат.Пустая() тогда 
		Отказ = Истина;
		Сообщить("Для текущего пользователя на этапе "+ТочкаЭтапа+" не найден адресат");
		Возврат;
	КонецЕсли;
	
	Для Каждого Задача из ФормируемыеЗадачи Цикл
		
		Если ТипЗнч(Адресат) = Тип("СправочникСсылка.Пользователи") тогда
			Задача.Пользователь = Адресат;
		Иначе
			Задача.Подразделение = Адресат;
		КонецЕсли;
		ЦС_ОбщегоНазначенияСервер.ОтправитьПисьмоПоИзменениюЗаявок(Задача.бизнеспроцесс, Адресат, Задача);
	КонецЦикла;
	
	ЭтотОбъект.Записать();

КонецПроцедуры

Процедура ОбработатьВыборВарианта(ТочкаВыбораВарианта, Результат,МаркерЭтапа)
	
	Если МаркерЭтапа = "Согласовано" тогда
		Результат = ТочкаВыбораВарианта.Варианты.Согласовано;
	ИначеЕсли МаркерЭтапа = "Возвращено" тогда
		Результат = ТочкаВыбораВарианта.Варианты.Возвращено;
	ИначеЕсли МаркерЭтапа = "Отказано" тогда
		Результат = ТочкаВыбораВарианта.Варианты.Отказано;
		
		Завершен = Истина;
		Состояние = Перечисления.ЦС_СостоянияСогласованияПлатежей.Отказано;

	КонецЕсли;

КонецПроцедуры

Процедура ЧППроверкаУсловия(ТочкаМаршрутаБизнесПроцесса, Результат)
	
	Сотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ЭтотОбъект.ФизЛицо);
	
	Если Сотрудник.ТекущееПодразделениеОрганизации.Наименование = "Руководство" Тогда
		Результат = Истина;
	Иначе	
		Результат = Ложь;
	КонецЕсли;

КонецПроцедуры

Процедура СамолетИлиТальгоПроверкаУсловия(ТочкаМаршрутаБизнесПроцесса, Результат)
	
	Результат = Ложь;

	Для каждого Стр из Таблица Цикл
		Если Стр.ВидТранспорта = Справочники.бит_ВидыТранспорта.ЖДСкоростной ИЛИ Стр.ВидТранспорта = Справочники.бит_ВидыТранспорта.Самолет Тогда
			Результат = Истина;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПриСозданииЗадач(ТочкаМаршрутаБизнесПроцесса, ФормируемыеЗадачи, Отказ)
	
	ТекущаяТочка = ТочкаМаршрутаБизнесПроцесса;
	
	Если ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеСРП") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСРуководителемСП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеСКурирующимЧП")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСКурирующимЧП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеСПП") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеСПП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СозданиеПроектаПриказаНаКомандировку")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СозданиеПроектаПриказаНаКомандировку;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеПроектаПриказаСПД")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеПроектаПриказаСПД;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеПроектаПриказаСФД") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеПроектаПриказаСФД;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ПодписаниеПроектаПриказаУДЧП") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ПодписаниеПроектаПриказаУДЧП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РегистрацияПриказа")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.АДРегистрацияПриказа;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ДБУРасчетКомандировочных") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ДБУРасчетКомандировочных;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеРасчетаСЗамГБ")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеРасчетаСЗамГБ;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеРасчетаСГБ") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеРасчетаСГБ;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ДБУПеречислениеДенег")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ДБУПеречислениеДенег;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ЗаполнениеРаботникомОтчетаОКомандировке") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ЗаполнениеРаботникомОтчетаОКомандировке;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ДБУЗаполнениеАвансовогоОтчета")	Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ДБУЗаполнениеАвансовогоОтчета;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.ОзнакомлениеСАвансовымОтчетом") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.ОзнакомлениеСАвансовымотчетом;
		
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.СогласованиеРасчетаСГБ") Тогда
		Этап = Справочники.ЦС_ЭтапыМаршрутовБП.СогласованиеРасчетаСГБ;

	КонецЕсли;	
	
	ОбработатьЭтап(Автор, Этап, ФормируемыеЗадачи, Отказ);
	
КонецПроцедуры

Процедура РезультатПроверкиВыбораВарианта(ТочкаВыбораВарианта, Результат)
	
	ТекущаяТочка = ТочкаВыбораВарианта;
	Если ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиСТП") Тогда
		МаркерЭтапа = ЗаявкаСогласованаСДиректоромСТП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиКурирующимЧП")	Тогда
		МаркерЭтапа = ЗаявкаСогласованаСКурирующимЧП; 
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиПП") Тогда
		МаркерЭтапа = ЗаявкаСогласованаСПП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиПД")	Тогда
		МаркерЭтапа = ПроектПриказаСогласованСДиректоромПД;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиФД")	Тогда
		МаркерЭтапа = ПроектПриказаСогласованСДиректоромФД;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиУДЧП") Тогда
		МаркерЭтапа = ПроектПриказаПодписанУДЧП;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиЗамГБ")	Тогда
		МаркерЭтапа = РасчетКомандировочныхСогласованСЗамГБ;
	ИначеЕсли ТекущаяТочка = ПредопределенноеЗначение("БизнесПроцесс.ЗаявкаНаКомандировку.ТочкаМаршрута.РезультатПроверкиГБ") Тогда
		МаркерЭтапа = РасчетКомандировочныхСогласованСГБ;
	КонецЕсли;
	
	ОбработатьВыборВарианта(ТочкаВыбораВарианта, Результат, МаркерЭтапа);	
		
КонецПроцедуры

Процедура СлужебныйАвтотранспортПроверкаУсловия(ТочкаМаршрутаБизнесПроцесса, Результат)
	
	Результат = Ложь;

	Для каждого Стр из Таблица Цикл
		Если Стр.ВидТранспорта = Справочники.бит_ВидыТранспорта.ТранспортКомпании Тогда
			Результат = Истина;
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры



