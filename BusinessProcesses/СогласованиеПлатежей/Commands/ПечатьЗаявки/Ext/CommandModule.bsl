
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ТабДок = Новый ТабличныйДокумент; 
	ТабДок.АвтоМасштаб = Истина;

	ПечатьЗаявки(ПараметрКоманды,ТабДок);
	КоличествоЭкземпляров = 1;
	НаПринтер = Ложь;
	УниверсальныеМеханизмы.НапечататьДокумент(ТабДок, КоличествоЭкземпляров, НаПринтер, РаботаСДиалогами.СформироватьЗаголовокДокумента(ПараметрКоманды,"Заявка"));
КонецПроцедуры

&НаСервере
Процедура ПечатьЗаявки(ПараметрКоманды,ТабДок)
	ТабДок.Очистить();
		
	Макет        = БизнесПроцессы.СогласованиеПлатежей.ПолучитьМакет("Заявка");
	Шапка        = Макет.ПолучитьОбласть("ОбластьШапка");
	ШапкаТаблицы = Макет.ПолучитьОбласть("ОбластьЗаголовокТаблицы");
	ОблСтрока    = Макет.ПолучитьОбласть("ОбластьСтрокаТаблицы");
	
	ПодписьКурЧП = Макет.ПолучитьОбласть("ПодписьКурЧП");
	ПодписьДирСП = Макет.ПолучитьОбласть("ПодписьДирСП");
	ПодписьМенФД = Макет.ПолучитьОбласть("ПодписьМенФД");
	ПодписьДирФД = Макет.ПолучитьОбласть("ПодписьДирФД");
	ПодписьИсп   = Макет.ПолучитьОбласть("ПодписьИсп");
	
	Подвал       = Макет.ПолучитьОбласть("ОбластьПодвал");
	
	ПодписьКурЧП.Параметры.ДолжКурирующийРуководитель    = "Курирующий руководитель";
	ПодписьДирСП.Параметры.ДолжДирСПИнициатора           = "Директор инициирующего структурного подразделения";
	ПодписьМенФД.Параметры.ДолжМенФД                     = "Главный менеджер/менеджер финансового департамента";
	ПодписьДирФД.Параметры.ДолжДирФД                     = "Директор финансового департамента";
	
	//Шапка.Параметры.ДатаРеестра = Формат(ПараметрКоманды.ДатаОкончания,"ДФ=dd.MM.yyyy");
	//Шапка.Параметры.НомерРеестра = ПараметрКоманды.Номер;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	 "ВЫБРАТЬ
	 |	СогласованиеПлатежейРасчетнаяТаблица.Ссылка,
	 |	СогласованиеПлатежейРасчетнаяТаблица.НомерСтроки,
	 |	СогласованиеПлатежейРасчетнаяТаблица.КодСтрокиБюджета,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СтатьяБюджета,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ГодовойПлан,
	 |	СогласованиеПлатежейРасчетнаяТаблица.Отклонение,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СуммаПоЗаявке,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ОдобреннаяСумма,
	 |	СогласованиеПлатежейРасчетнаяТаблица.Примечание,
	 |	СогласованиеПлатежейРасчетнаяТаблица.Контрагент,
	 |	СогласованиеПлатежейРасчетнаяТаблица.Договор,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ФактПредыдущегоПериода,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СуммыПредыдущихПлатежей,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ОстатокПланаСУчетомФакта,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ВалютаДокумента,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ДокументПоступления,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ОплаченоПоДоговору,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СуммаДоговора,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ТипОперации,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СтатьяДвиженияДенежныхСредств,
	 |	СогласованиеПлатежейРасчетнаяТаблица.СчетКонтрагента,
	 |	СогласованиеПлатежейРасчетнаяТаблица.ЭСФ
	 |ИЗ
	 |	БизнесПроцесс.СогласованиеПлатежей.РасчетнаяТаблица КАК СогласованиеПлатежейРасчетнаяТаблица
	 |ГДЕ
	 |	СогласованиеПлатежейРасчетнаяТаблица.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", ПараметрКоманды);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
    //НомерСтроки = 0;
	//ОбщийОбъем  = 0;
	//ОбщаяСумма  = 0;
    //втчИтого    = 0;
	//втчИтогоРБ  = 0;
	//втчШапка    = "";
	
	Шапка.Параметры.Номер = ПараметрКоманды.Номер;
	Шапка.Параметры.Дата  = Формат(ПараметрКоманды.Дата, "ДФ=dd.MM.yyyy");
	
	ТабДок.Вывести(Шапка);
	ТабДок.Вывести(ШапкаТаблицы);
		
	//получим значения строки
	Пока Выборка.Следующий() Цикл 	
		ОблСтрока.Параметры.Заполнить(Выборка);		
		ТабДок.Вывести(ОблСтрока);	
	КонецЦикла;
	
	Для Каждого Стр из ПараметрКоманды.Подписи Цикл
		
		СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
		ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, Стр.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
		
		Если Стр.Этап = БизнесПроцессы.СогласованиеПлатежей.ТочкиМаршрута.СогласованиеСКурирующимЧП Тогда	
			ПодписьКурЧП.Параметры.ФИОКурирующийРуководитель     = СФио;
			ПодписьКурЧП.Параметры.ДолжКурирующийРуководитель    = ДолжностьДляПечФормы;
			ПодписьКурЧП.Параметры.ДатаКР                        = Стр.Дата;
			ПодписьКурЧП.Параметры.СогласованоКурЧП              = "Утверждено";
			ПодписьКурЧП.Параметры.ФлажокКурЧП		             = "V";
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеПлатежей.ТочкиМаршрута.СогласованиеСРП Тогда
			ПодписьДирСП.Параметры.ФИОДирСПИнициатора            = СФио;
			ПодписьДирСП.Параметры.ДолжДирСПИнициатора           = ДолжностьДляПечФормы;
			ПодписьДирСП.Параметры.ДатаДирИницСП                 = Стр.Дата;
			ПодписьДирСП.Параметры.СогласованоДирИницСП          = "Подписано";
			ПодписьДирСП.Параметры.ФлажокДирИницСП		         = "V";
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеПлатежей.ТочкиМаршрута.СогласованиеМенеджераФД Тогда
			ПодписьМенФД.Параметры.ФИОМенФД                      = СФио;
			ПодписьМенФД.Параметры.ДолжМенФД                     = ДолжностьДляПечФормы;
			ПодписьМенФД.Параметры.ДатаМенФД                     = Стр.Дата;
			ПодписьМенФД.Параметры.СогласованоМенФД              = "Согласовано";
			ПодписьМенФД.Параметры.ФлажокМенФД		             = "V";	
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеПлатежей.ТочкиМаршрута.СогласованиеДиректораФД Тогда
			ПодписьДирФД.Параметры.ФИОДирФД                      = СФио;
			ПодписьДирФД.Параметры.ДолжДирФД                     = ДолжностьДляПечФормы;
			ПодписьДирФД.Параметры.ДатаДирФД                     = Стр.Дата;
			ПодписьДирФД.Параметры.СогласованоДирФД              = "Согласовано";
			ПодписьДирФД.Параметры.ФлажокДирФД		             = "V";
		КонецЕсли;
		
	КонецЦикла;
	
	СФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	ПодписьИсп.Параметры.ФИОИспСПИнициатора            = СФио;
	ПодписьИсп.Параметры.ДолжИспСПИнициатора           = ДолжностьДляПечФормы;
	ПодписьИсп.Параметры.ДатаИницСП                    = ПараметрКоманды.Дата;
	ПодписьИсп.Параметры.СогласованоИспИниц            = "Согласовано";
	ПодписьИсп.Параметры.ФлажокИспИниц		           = "V";
	
	ТабДок.Вывести(ПодписьКурЧП);
	ТабДок.Вывести(ПодписьДирСП);
	ТабДок.Вывести(ПодписьМенФД);
	ТабДок.Вывести(ПодписьДирФД);
	ТабДок.Вывести(ПодписьИсп);
		
	//сФио                 = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Представление;
	//ДолжностьДляПечФормы = ПроцедурыУправленияПерсоналом.ДанныеФизЛица(ПараметрКоманды.Организация, ПараметрКоманды.Автор.ФизЛицо, ПараметрКоманды.Дата).Должность;
	//Подвал.Параметры.ФИОМенеджераДЗСХП       = сФио;
	//Подвал.Параметры.ДолжностьМенеджераДЗСХП = ДолжностьДляПечФормы;
	//Подвал.Параметры.ВремяПодписания5        = ПараметрКоманды.Дата;
	Подвал.Параметры.ДатаРеестра             = Формат(ПараметрКоманды.Дата,"ДФ=dd.MM.yyyy");
		
	ТабДок.Вывести(Подвал);
	
КонецПроцедуры	
