
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьОтбор(Этаформа);
КонецПроцедуры

// {{ Начало Аксиома: Попов В.С. 28.04.2024 15:11
&НаСервере
Функция ПолучитьЗначениеНастройки(Настройка)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НастройкиПользователей.Значение
		|ИЗ
		|	РегистрСведений.НастройкиПользователей КАК НастройкиПользователей
		|ГДЕ
		|	НастройкиПользователей.Настройка = &Настройка
		|	И НастройкиПользователей.Пользователь = &Пользователь";
	
	Запрос.УстановитьПараметр("Пользователь", ПараметрыСеанса.ТекущийПользователь);
	Запрос.УстановитьПараметр("Настройка", Настройка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() тогда
		Возврат ВыборкаДетальныеЗаписи.Значение;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции 
// }} Окончание  Аксиома: Попов В.С.

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьОтбор(Форма) 
	
	Если РольДоступна("ПолныеПрава") ИЛИ РольДоступна("усд_УправлениеСогласованиемИУтверждениемДокументов") Тогда
		Отбор = Ложь;
	Иначе
		Отбор = Истина;
	КонецЕсли;
	
	//ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(Форма.Список, "Автор", ПараметрыСеанса.ТекущийПользователь, Отбор );	
	
	ТекущийИсполнитель = ПараметрыСеанса.ТекущийПользователь;

	// {{ Начало Аксиома: Попов В.С. 28.04.2024 15:00
	ПользовательДоступа = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	НастройкиПользователей.Значение
		|ИЗ
		|	РегистрСведений.НастройкиПользователей КАК НастройкиПользователей
		|ГДЕ
		|	НастройкиПользователей.Настройка = &Настройка
		|	И НастройкиПользователей.Пользователь = &Пользователь";
	
	Запрос.УстановитьПараметр("Пользователь", ПараметрыСеанса.ТекущийПользователь);
	Запрос.УстановитьПараметр("Настройка", ПланыВидовХарактеристик.НастройкиПользователей.ДоступКДокументамСогласованияДругогоПользователя);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() тогда
		ПользовательДоступа = ВыборкаДетальныеЗаписи.Значение;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПользовательДоступа) тогда
		Сотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ТекущийИсполнитель.ФизЛицо); 
		
		ГруппаОтбора = Форма.Список.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
		ГруппаОтбора.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИЛИ;
		
		ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Автор");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = ТекущийИсполнитель;
		
		ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Автор");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = ПользовательДоступа;
		
		Если Не ТекущийИсполнитель.ПодачаЗаявокЗаДругиеПодразделения = Истина тогда
			Если Отбор = Истина Тогда
				Сотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ТекущийИсполнитель.ФизЛицо); 
				Подразделение = Сотрудник.ТекущееПодразделениеОрганизации; 

				ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
				ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Подразделение");
				ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
				ЭлементОтбора.ПравоеЗначение = Подразделение;
			КонецЕсли;
		КонецЕсли;
	//Если Не ТекущийИсполнитель.ПодачаЗаявокЗаДругиеПодразделения = Истина Тогда
	ИначеЕсли Не ТекущийИсполнитель.ПодачаЗаявокЗаДругиеПодразделения = Истина Тогда
	// }} Окончание  Аксиома: Попов В.С.
		
		Если Отбор = Истина Тогда
			Сотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ТекущийИсполнитель.ФизЛицо); 
			Подразделение = Сотрудник.ТекущееПодразделениеОрганизации; 
			
					
			ГруппаОтбора = Форма.Список.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
			ГруппаОтбора.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИЛИ;
		 
			ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Автор");
			ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
			ЭлементОтбора.ПравоеЗначение = ТекущийИсполнитель;
		 
			ЭлементОтбора = ГруппаОтбора.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Подразделение");
			ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
			ЭлементОтбора.ПравоеЗначение = Подразделение;
	   КонецЕсли;

	Иначе
		
		ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(Форма.Список, "Автор", ТекущийИсполнитель, Отбор );
		
	КонецЕсли;

КонецПроцедуры
