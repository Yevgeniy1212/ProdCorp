
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	ТабДок = Новый ТабличныйДокумент; 
	ТабДок.АвтоМасштаб = Истина;

	ПечатьРесстр(ПараметрКоманды,ТабДок);
	КоличествоЭкземпляров = 1;
	НаПринтер = Ложь;
	УниверсальныеМеханизмы.НапечататьДокумент(ТабДок, КоличествоЭкземпляров, НаПринтер, РаботаСДиалогами.СформироватьЗаголовокДокумента(ПараметрКоманды,"Реестр платежей "));	
КонецПроцедуры

&НаСервере
Процедура ПечатьРесстр(ПараметрКоманды,ТабДок)
	ТабДок.Очистить();
	// Получаем валюты чтоб рассчитать курс
	KZT = Справочники.Валюты.НайтиПоКоду("398");
	USD = Справочники.Валюты.НайтиПоКоду("840");
	RUB = Справочники.Валюты.НайтиПоКоду("643");
	
	Макет     = БизнесПроцессы.СогласованиеРеестров.ПолучитьМакет("Реестр");
	Шапка     = Макет.ПолучитьОбласть("Шапка");
	ОблСтрока = Макет.ПолучитьОбласть("Строки");
	Подвал    = Макет.ПолучитьОбласть("Подвал");
	
	Шапка.Параметры.Дата = Формат(ПараметрКоманды.ДатаОкончания,"ДФ=dd.MM.yyyy");
	Шапка.Параметры.НомерРеестра = ПараметрКоманды.Номер;
	ТабДок.Вывести(Шапка);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СогласованиеРеестровПлатежи.Ссылка,
	|	СогласованиеРеестровПлатежи.НомерСтроки,
	|	СогласованиеРеестровПлатежи.Поручение,
	|	СогласованиеРеестровПлатежи.Контрагент,
	|	СогласованиеРеестровПлатежи.Договор,
	|	СогласованиеРеестровПлатежи.НазначениеПлатежа,
	|	СогласованиеРеестровПлатежи.СуммаПлатежа,
	|	СогласованиеРеестровПлатежи.РасчетныйСчет,
	|	СогласованиеРеестровПлатежи.Представительство,
	|	СогласованиеРеестровПлатежи.Валюта,
	|	СогласованиеРеестровПлатежи.Ссылка.Номер КАК НомерРеестра,
	|	СогласованиеРеестровПлатежи.КонтрагентПолучатель,
	|	СогласованиеРеестров.ТипПлатежа,
	|	СогласованиеРеестровПлатежи.ЗаявкаНаФинансированиеПредставительств.Организация КАК Организация
	|ИЗ
	|	БизнесПроцесс.СогласованиеРеестров.Платежи КАК СогласованиеРеестровПлатежи
	|		ЛЕВОЕ СОЕДИНЕНИЕ БизнесПроцесс.СогласованиеРеестров КАК СогласованиеРеестров
	|		ПО СогласованиеРеестровПлатежи.Ссылка = СогласованиеРеестров.Ссылка
	|ГДЕ
	|	СогласованиеРеестровПлатежи.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", ПараметрКоманды);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
    НомерСтроки = 0;
	СуммаТенге  = 0;
	СуммаДоллор = 0;
	СуммаРубль  = 0;
	
	Пока Выборка.Следующий() Цикл 
		
		ОблСтрока.Параметры.Заполнить(Выборка);
		
		Если Выборка.ТипПлатежа = Перечисления.ТипыПлатежей.ФинансированиеПредставительств Тогда
			 ОблСтрока.Параметры.Контрагент = Выборка.Контрагент;
			 ОблСтрока.Параметры.КонтрагентПолучатель = Выборка.КонтрагентПолучатель;
		 КонецЕсли;
		 
		Если Выборка.ТипПлатежа = Перечисления.ТипыПлатежей.ПлатежиЦА Тогда
			 ОблСтрока.Параметры.КонтрагентПолучатель = Выборка.Контрагент;
			 ОблСтрока.Параметры.Контрагент = "";
		 КонецЕсли;
		 
		Если Выборка.ТипПлатежа = Перечисления.ТипыПлатежей.ПлатежиОбластей Тогда
			 ОблСтрока.Параметры.Контрагент = Выборка.Организация;
			 ОблСтрока.Параметры.КонтрагентПолучатель = Выборка.Контрагент;
		 КонецЕсли; 
			 
		//Если НЕ ЗначениеЗаполнено(Выборка.Представительство) Тогда
		//	ОблСтрока.Параметры.Контрагент = "";
		//КонецЕсли;
		
		Если Выборка.Валюта = KZT Тогда 
			ОблСтрока.Параметры.СуммаТг = Выборка.СуммаПлатежа;
			СуммаТенге = СуммаТенге + Выборка.СуммаПлатежа;
			ОблСтрока.Параметры.СуммаД = "";
			ОблСтрока.Параметры.СуммаРб = "";
			
		ИначеЕсли Выборка.Валюта = USD Тогда
			ОблСтрока.Параметры.СуммаД = Выборка.СуммаПлатежа;
			СуммаДоллор = СуммаДоллор + Выборка.СуммаПлатежа;
			ОблСтрока.Параметры.СуммаРб = "";
			ОблСтрока.Параметры.СуммаТг = "";
		Иначе
			ОблСтрока.Параметры.СуммаРб = Выборка.СуммаПлатежа;
			СуммаРубль = СуммаРубль + Выборка.СуммаПлатежа;
			ОблСтрока.Параметры.СуммаД = "";
			ОблСтрока.Параметры.СуммаТг = "";
		КонецЕсли;
		
		ОблСтрока.Параметры.НомерПП = Выборка.Поручение.Номер;
		
		ТабДок.Вывести(ОблСтрока);
		
	КонецЦикла;
	
	// выводим итоговые суммы 	
	Подвал.Параметры.ИтогоТг = СуммаТенге;
	Подвал.Параметры.ИтогоД  = СуммаДоллор;
	Подвал.Параметры.ИтогоРб = СуммаРубль;
	
	// Получаем руководитель 
	ДолжностьРуководителя = Перечисления.ОтветственныеЛицаОрганизаций.Руководитель;
	Отбор = Новый Структура("ОтветственноеЛицо", ДолжностьРуководителя);
	////Руководитель = РегистрыСведений.ОтветственныеЛицаОрганизаций.ПолучитьПоследнее(ПараметрКоманды.Дата,Отбор);
	
	// Фин дир
	//ДолжностьФинДиректора = "Директор Финансового департамента";
	//ФинДир = "А. Мукашова";
	
	СотрудникКурирующийЧП = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("Физлицо", ПараметрКоманды.КурирующийЧП.ФизЛицо);
	ДолжностьРуководителя = СотрудникКурирующийЧП.ТекущаяДолжностьОрганизации;

	//Подвал.Параметры.ДолжностьРуководителя = "Управляющий директор - член Правления";
	//Подвал.Параметры.ФИОРуководителя = ПараметрКоманды.КурирующийЧП.Наименование;
	//Подвал.Параметры.ФИОФиндира =  ФинДир;
	//Подвал.Параметры.ДолжностьФиндира = ДолжностьФинДиректора;
	
	Подвал.Параметры.Исполнитель = ПараметрКоманды.Автор;
	Подвал.Параметры.Телефон = ПараметрКоманды.Телефон;
	
	Для Каждого Стр из ПараметрКоманды.Подписи Цикл
		Если Стр.Этап = БизнесПроцессы.СогласованиеРеестров.ТочкиМаршрута.ПроверкаВР Тогда
			//Подвал.Параметры.ВремяПодписания1 = Стр.Дата;
		//ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеРеестров.ТочкиМаршрута.СогласованиеСДиректоромФД Тогда
		//	Подвал.Параметры.ВремяПодписания2 = Стр.Дата;
		//	Подвал.Параметры.ФИОФиндира = Стр.Автор;
		ИначеЕсли Стр.Этап = БизнесПроцессы.СогласованиеРеестров.ТочкиМаршрута.СогласованиеСДиректоромКД Тогда
			Подвал.Параметры.ВремяПодписания3 = Стр.Дата;
			Подвал.Параметры.ФИОДК = Стр.Автор;
	        Подвал.Параметры.ДолжностДК = "Директор департамента казначейства";
		КонецЕсли;
	КонецЦикла;

	Подвал.Параметры.Дата1 = Формат(ПараметрКоманды.Дата,"ДФ=dd.MM.yyyy");
	Подвал.Параметры.Время = Формат(ПараметрКоманды.Дата,"ДЛФ=T");
	
	ТабДок.Вывести(Подвал);
КонецПроцедуры	
