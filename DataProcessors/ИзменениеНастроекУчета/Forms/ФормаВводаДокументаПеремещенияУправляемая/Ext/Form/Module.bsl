
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Организация = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(фин_ОбщегоНазначенияВызовСервераПовтИсп.ЗначениеПеременной("глТекущийПользователь"), "ОсновнаяОрганизация");
	Если Параметры.Свойство("мДатаУстановкиАналитическогоУчета") Тогда
		мДатаУстановкиАналитическогоУчета = Параметры.мДатаУстановкиАналитическогоУчета;
	КонецЕсли;
	Элементы.НадписьДокументПеремещениеОС.Видимость = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	Элементы.НадписьДокументПеремещениеОС.Видимость = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ДокументПеремещениеОСНажатие(Элемент)
	ВыбранныйДокумент  = ВыбратьИзМеню(СписокДокументовПеремещениеОС);

	Если НЕ ВыбранныйДокумент = Неопределено Тогда 
		Форма = ВыбранныйДокумент.Значение.ПолучитьФорму();
		Форма.Открыть();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ИмеютсяДокументы()
	СписокДокументовПеремещениеОС.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПеремещениеОС.Ссылка
		|ИЗ
		|	Документ.ПеремещениеОС КАК ПеремещениеОС
		|ГДЕ
		|	НАЧАЛОПЕРИОДА(ПеремещениеОС.Дата, ДЕНЬ) = &Дата
		|	И ПеремещениеОС.Организация = &Организация
		|	И ПеремещениеОС.НачальноеЗаполнениеАналитикиНаСчетахУчетаОС = ИСТИНА
		|	И ПеремещениеОС.Проведен = ИСТИНА";

	Запрос.УстановитьПараметр("Дата", мДатаУстановкиАналитическогоУчета);
	Запрос.УстановитьПараметр("Организация", Организация);

	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			ДокПеремещение = Выборка.Ссылка;
			СписокДокументовПеремещениеОС.Добавить(Выборка.Ссылка);
		КонецЦикла;
	КонецЕсли;
	Возврат СписокДокументовПеремещениеОС.Количество()>0;
КонецФункции

&НаСервере
Функция КнопкаВыполнитьНажатие(Режим)
	
	Если Режим<>0 Тогда
		Если Режим = 1 Тогда
			ДокПеремещение = СписокДокументовПеремещениеОС.Получить(0);
			Если СписокДокументовПеремещениеОС.Количество() > 1 Тогда
				ДокПеремещение = СписокДокументовПеремещениеОС.ВыбратьЭлемент("Выберите документ", ДокПеремещение);
			КонецЕсли;
			Если ДокПеремещение <> Неопределено Тогда
		        ДокПеремещение = ДокПеремещение.Значение;
			КонецЕсли;
		Иначе
			ДокПеремещение = Документы.ПеремещениеОС.СоздатьДокумент();
			ДокПеремещение.Дата = мДатаУстановкиАналитическогоУчета;
			ДокПеремещение.Организация = Организация;
			ДокПеремещение.НачальноеЗаполнениеАналитикиНаСчетахУчетаОС = Истина;
		КонецЕсли;
		
	Иначе
		
		ДокПеремещение = Документы.ПеремещениеОС.СоздатьДокумент();
		ДокПеремещение.Дата = мДатаУстановкиАналитическогоУчета;
		ДокПеремещение.Организация = Организация;
		ДокПеремещение.НачальноеЗаполнениеАналитикиНаСчетахУчетаОС = Истина;
	
	КонецЕсли;

	Если ДокПеремещение <> Неопределено Тогда
		Если ТипЗнч(ДокПеремещение) = Тип("ДокументСсылка.ПеремещениеОС") Тогда
			Возврат ДокПеремещение;
		Иначе
			ДокПеремещение.Записать(РежимЗаписиДокумента.Запись);
			Возврат ДокПеремещение.Ссылка;
		КонецЕсли;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	             	
КонецФункции

&НаКлиенте
Процедура КнопкаВыполнить(Команда)
	Режим = 0;
	Если ИмеютсяДокументы() Тогда
		СписокКнопоки = Новый СписокЗначений;
		СписокКнопоки.Добавить(КодВозвратаДиалога.Да, "Создать новый");
		СписокКнопоки.Добавить(КодВозвратаДиалога.Отмена, "Отмена");
		СписокКнопоки.Добавить(КодВозвратаДиалога.Прервать, "Открыть существующий");
		
		ТекстВопроса = "На " + Формат(мДатаУстановкиАналитическогоУчета, "ДЛФ=Д") + " существуют проведенные документы ""Перемещение ОС""
		               |по начальному заполнению аналитики на счетах учета ОС!
					   |Необходимо проверить заполнение и перепровести их.
					   |
					   |Заполнение значений начальной аналитики на одну дату
					   |рекомендуется осуществлять одним документом.";
		Ответ = Вопрос(ТекстВопроса, СписокКнопоки, 0, КодВозвратаДиалога.Прервать, "Внимание!!!");
		
	    Элементы.НадписьДокументПеремещениеОС.Видимость = Истина;
		Если Ответ = КодВозвратаДиалога.Отмена Тогда
			Возврат;
		ИначеЕсли Ответ = КодВозвратаДиалога.Прервать Тогда
			Режим = 1;
		Иначе
			Режим = 2;
		КонецЕсли;
		
	КонецЕсли;
	РезультирующийДокумент = КнопкаВыполнитьНажатие(Режим);
	Если РезультирующийДокумент<>Неопределено Тогда
		ОткрытьФорму("Документ.ПеремещениеОС.ФормаОбъекта",Новый Структура("Ключ",РезультирующийДокумент));
	КонецЕсли;
КонецПроцедуры
