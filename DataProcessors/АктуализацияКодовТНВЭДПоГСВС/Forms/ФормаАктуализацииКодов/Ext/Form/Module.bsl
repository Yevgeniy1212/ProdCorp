#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)

	ЗаполнитьТаблицуАктуализации();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ЭтаФорма.КлючУникальности = Источник Тогда
		
		Если ИмяСобытия = "АктуализацияТНВЭД_ПроверятьОповещенияФоновогоЗадания" Тогда
			
			РезультатРаботыЗадания = Параметр;
			
			Если РезультатРаботыЗадания.ЗаданиеВыполнено Тогда
				
				АдресСообщенияПользователю = ЭСФВызовСервера.СообщенияФоновогоЗадания(РезультатРаботыЗадания.ИдентификаторЗадания);
				СообщенияПользователю = ПолучитьИзВременногоХранилища(АдресСообщенияПользователю);
				Если СообщенияПользователю <> Неопределено Тогда
					Для каждого СообщениеФоновогоЗадания Из СообщенияПользователю Цикл
						СообщениеФоновогоЗадания.Сообщить();
					КонецЦикла;
				КонецЕсли;
				
				Оповестить("АктуализацияТНВЭД_Выполнена", Параметр, ЭтаФорма.КлючУникальности);
			Иначе
			
				ПараметрыДлительнойОперации = Новый Структура;
				ПараметрыДлительнойОперации.Вставить("ИдентификаторЗадания");
				ПараметрыДлительнойОперации.Вставить("ВыводитьОкноОжидания", Истина);
				ПараметрыДлительнойОперации.Вставить("АдресРезультата", РезультатРаботыЗадания.АдресХранилища);
				ПараметрыДлительнойОперации.Вставить("ВыводитьСообщения", Истина);
				
				Если РезультатРаботыЗадания.Свойство("ТекстСообщения") Тогда
					ПараметрыДлительнойОперации.Вставить("ТекстСообщения", РезультатРаботыЗадания.ТекстСообщения);
				КонецЕсли;
				
				ПараметрыДлительнойОперации.ИдентификаторЗадания = РезультатРаботыЗадания.ИдентификаторЗадания;
				//БК2
				//ОписаниеОповещения = Новый ОписаниеОповещения("ОповеститьОЗавершениияДлительнойОперации_АктуализацияТНВЭД", ЭтотОбъект, ЭтаФорма);
				ОписаниеОповещения = Новый ОписаниеОповещения("ОповеститьОЗавершениияДлительнойОперации_АктуализацияТНВЭД", ЭтаФорма);
				//БК 2
				
				ОткрытьФорму("Обработка.ОбменЭСФ.Форма.ДлительнаяОперация", ПараметрыДлительнойОперации, ЭтаФорма,,,, ОписаниеОповещения);
				
			КонецЕсли;
			
		ИначеЕсли ИмяСобытия = "АктуализацияТНВЭД_Выполнена" Тогда
			
			РезультатРаботыЗадания = ПолучитьИзВременногоХранилища(Параметр.АдресХранилища);
			Если ТипЗнч(РезультатРаботыЗадания) = Тип("Структура") 
				И РезультатРаботыЗадания.Свойство("ОсталисьНеобработанныеСтроки") 
				И РезультатРаботыЗадания.ОсталисьНеобработанныеСтроки = Истина Тогда
				
				Сообщить("Актуализация кодов ТН ВЭД проведена не для всех элементов номенклатуры!", СтатусСообщения.Внимание);
				
			КонецЕсли;
			
			ЗаполнитьТаблицуАктуализации();

		ИначеЕсли ИмяСобытия = "ЗаполнениеТаблицыАктуализацииТНВЭД_ПроверятьОповещенияФоновогоЗадания" Тогда
			
			РезультатРаботыЗадания = Параметр;
			
			Если РезультатРаботыЗадания.ЗаданиеВыполнено Тогда
				
				АдресСообщенияПользователю = ЭСФВызовСервера.СообщенияФоновогоЗадания(РезультатРаботыЗадания.ИдентификаторЗадания);
				СообщенияПользователю = ПолучитьИзВременногоХранилища(АдресСообщенияПользователю);
				Если СообщенияПользователю <> Неопределено Тогда
					Для каждого СообщениеФоновогоЗадания Из СообщенияПользователю Цикл
						СообщениеФоновогоЗадания.Сообщить();
					КонецЦикла;
				КонецЕсли;
				
				Оповестить("ЗаполнениеТаблицыАктуализацииТНВЭД_Выполнена", Параметр, ЭтаФорма.КлючУникальности);
			Иначе
			
				ПараметрыДлительнойОперации = Новый Структура;
				ПараметрыДлительнойОперации.Вставить("ИдентификаторЗадания");
				ПараметрыДлительнойОперации.Вставить("ВыводитьОкноОжидания", Истина);
				ПараметрыДлительнойОперации.Вставить("АдресРезультата", РезультатРаботыЗадания.АдресХранилища);
				ПараметрыДлительнойОперации.Вставить("ВыводитьСообщения", Истина);
				
				Если РезультатРаботыЗадания.Свойство("ТекстСообщения") Тогда
					ПараметрыДлительнойОперации.Вставить("ТекстСообщения", РезультатРаботыЗадания.ТекстСообщения);
				КонецЕсли;
				
				ПараметрыДлительнойОперации.ИдентификаторЗадания = РезультатРаботыЗадания.ИдентификаторЗадания;
				//БК 2
				//ОписаниеОповещения = Новый ОписаниеОповещения("ОповеститьОЗавершениияДлительнойОперации_ЗаполнениеТаблицыАктуализацииТНВЭД", ЭтотОбъект, ЭтаФорма);
				ОписаниеОповещения = Новый ОписаниеОповещения("ОповеститьОЗавершениияДлительнойОперации_ЗаполнениеТаблицыАктуализацииТНВЭД", ЭтаФорма);
				//БК 2
				ОткрытьФорму("Обработка.ОбменЭСФ.Форма.ДлительнаяОперация", ПараметрыДлительнойОперации, ЭтаФорма,,,, ОписаниеОповещения);
				
			КонецЕсли;
			
		ИначеЕсли ИмяСобытия = "ЗаполнениеТаблицыАктуализацииТНВЭД_Выполнена" Тогда
			
			ЗаполнитьТаблицуАктуализацииИзХранилища(Параметр.АдресХранилища);
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура Актуализировать(Команда)
	
	Результат = АктуализироватьНаСервере();
	
	//БК2
	//РезультатРаботыЗадания = ПолучитьИзВременногоХранилища(Результат);
	//Если ТипЗнч(РезультатРаботыЗадания) = Тип("Структура") 
	//	И РезультатРаботыЗадания.Свойство("ОсталисьНеобработанныеСтроки") 
	//	И РезультатРаботыЗадания.ОсталисьНеобработанныеСтроки = Истина Тогда
	//БК 2
	ЗаполнитьТаблицуАктуализацииИзХранилища(Результат);
	
	Если ТаблицаАктуализации.Количество() > 0 Тогда
		Сообщить("Актуализация кодов ТН ВЭД проведена не для всех элементов номенклатуры!", СтатусСообщения.Внимание);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияРезервнаяКопияНажатие(Элемент)
	//БК 2
	//ОткрытьФорму("Обработка.РезервноеКопированиеИБ.Форма", Неопределено);
	//БК 2	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийДереваНоменклатуры

&НаКлиенте
Процедура ДеревоПриАктивизацииСтроки(Элемент)
	
	Если Элемент.ТекущиеДанные = Неопределено Или Элемент.ТекущиеДанные.Ссылка.Пустая() Тогда
		
		Элементы.ТаблицаАктуализации.ОтборСтрок = Неопределено;
		
	Иначе
		
		Элементы.ТаблицаАктуализации.ОтборСтрок = Новый ФиксированнаяСтруктура("Родитель", Элемент.ТекущиеДанные.Ссылка);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийТаблицыАктуализации

&НаКлиенте
Процедура ОбновитьТаблицу(Команда)
	
	Если Вопрос("Значения колонки ""Новый код ТН ВЭД"" будут перезаполнены. Продолжить?", РежимДиалогаВопрос.ДаНет, , , ) = КодВозвратаДиалога.Да Тогда
		ЗаполнитьТаблицуАктуализации();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьПометки(Команда)
	УправлениеПометками(Истина);
КонецПроцедуры

&НаКлиенте
Процедура СнятьПометки(Команда)
	УправлениеПометками(Ложь);
КонецПроцедуры

&НаКлиенте
Процедура ИнвертироватьПометки(Команда)
	УправлениеПометками();
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаАктуализацииНоменклатураГСВСНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаАктуализацииНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ЗаполнитьТаблицуАктуализации()
	
	Результат = ЗаполнитьТаблицуАктуализацииНаСервере();	
	
	ЗаполнитьТаблицуАктуализацииИзХранилища(Результат);
	
КонецПроцедуры

//БК 2
&НаСервере
Функция АктуализироватьнаСервере()
	
	ПараметрыПроцедуры = Новый Структура;
	ПараметрыПроцедуры.Вставить("ТаблицаАктуализации", ТаблицаАктуализации.Выгрузить(, "Номенклатура, ТекущийКодТНВЭД, НовыйКодТНВЭД, НоменклатураГСВС, Пометка, Родитель"));  
	
	Возврат ЭСФСерверПереопределяемый.АктуализироватьКодыТНВЭДВФоне (ПараметрыПроцедуры);

КонецФункции
//БК 2

&НаСервере
Функция АктуализироватьВФоне(ПараметрыВыполнения)
	
	КлючФоновогоЗадания = Новый УникальныйИдентификатор;		
	
	ПараметрыВыполнения.КлючФоновогоЗадания = КлючФоновогоЗадания;
	ПараметрыВыполнения.ОжидатьЗавершение = 0;
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НСтр("ru = 'Актуализация кодов ТН ВЭД номенклатуры'");
			    
	ПараметрыПроцедуры = Новый Структура;
	ПараметрыПроцедуры.Вставить("ТаблицаАктуализации", ТаблицаАктуализации.Выгрузить(, "Номенклатура, НовыйКодТНВЭД, Пометка"));  
	ПараметрыПроцедуры.Вставить("КлючФоновогоЗадания", КлючФоновогоЗадания);
	
	Возврат ЭСФСерверПереопределяемый.ВыполнитьВФоне("ЭСФСерверПереопределяемый.АктуализироватьКодыТНВЭДВФоне", ПараметрыПроцедуры, ПараметрыВыполнения);
	
КонецФункции
//БК 2
&НаСервере
Функция ЗаполнитьТаблицуАктуализацииНаСервере()
	
	ПараметрыПроцедуры = Новый Структура;
	ПараметрыПроцедуры.Вставить("ДатаАктуальности", ТекущаяДатаСеанса());
	
	Возврат ЭСФСерверПереопределяемый.ПолучитьСписокНоменклатурыДляАктуализации(ПараметрыПроцедуры);
	
КонецФункции
//БК 2

&НаСервере
Функция ЗаполнитьТаблицуАктуализацииВФоне(ПараметрыВыполнения)
	
	КлючФоновогоЗадания = Новый УникальныйИдентификатор;		
	
	ПараметрыВыполнения.КлючФоновогоЗадания = КлючФоновогоЗадания;
	ПараметрыВыполнения.ОжидатьЗавершение = 0;
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НСтр("ru = 'Заполнение таблицы актуализации кодов ТН ВЭД'");
			    
	ПараметрыПроцедуры = Новый Структура;
	ПараметрыПроцедуры.Вставить("КлючФоновогоЗадания", КлючФоновогоЗадания);
	
	Возврат ЭСФСерверПереопределяемый.ВыполнитьВФоне("ЭСФСерверПереопределяемый.ПолучитьСписокНоменклатурыДляАктуализации", ПараметрыПроцедуры, ПараметрыВыполнения);
	
КонецФункции

&НаКлиенте
Процедура ОповеститьОЗавершениияДлительнойОперации_АктуализацияТНВЭД(Результат, Источник) Экспорт

	Оповестить("АктуализацияТНВЭД_Выполнена", Результат);
	
КонецПроцедуры

&НаКлиенте
Процедура ОповеститьОЗавершениияДлительнойОперации_ЗаполнениеТаблицыАктуализацииТНВЭД(Результат, Источник) Экспорт

	Оповестить("ЗаполнениеТаблицыАктуализацииТНВЭД_Выполнена", Результат);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицуАктуализацииИзХранилища(Знач АдресХранилища)
	ТаблицаАктуализации.Загрузить(ПолучитьИзВременногоХранилища(АдресХранилища));
КонецПроцедуры	

&НаКлиенте
Процедура УправлениеПометками(Значение = Неопределено)
	Для Каждого ТекСтрока Из ТаблицаАктуализации Цикл
		ТекСтрока.Пометка = ?(Значение = Неопределено, Не ТекСтрока.Пометка, Значение);
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

