////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОКУМЕНТА

// Функция формирует текст запроса
//
// Возвращаемое значение:
//  Строка - текст запроса
//
Функция СформироватьТекстЗапроса(МетаданныеДокумента) Экспорт 
	
	ТекстЗапроса = "";	
	МетаданныеДокумента = ДокументСсылка.Метаданные();
	
	Для Каждого Движение Из МетаданныеДокумента.Движения Цикл
		// в запросе получаем имена регистров, по которым есть хотя бы одно движение
		// например,
		// ВЫБРАТЬ Первые 1 «РегистрНакопления.ТоварыНаСкладах»
		// ИЗ РегистрНакопления.ТоварыНаСкладах
		// ГДЕ Регистратор = &Регистратор
		
		ТекстЗапроса = ТекстЗапроса + "
		|" + ?(ТекстЗапроса = "", "", "ОБЪЕДИНИТЬ ВСЕ ") + "
		|ВЫБРАТЬ ПЕРВЫЕ 1 """ + Движение.ПолноеИмя() +  """ КАК Имя ИЗ " 
		+ Движение.ПолноеИмя() + " ГДЕ Регистратор = &Регистратор";
		
	КонецЦикла;
	
	Возврат ТекстЗапроса;
	
КонецФункции // СформироватьТекстЗапроса()

// Функция формирует запрос по регистратору
//
// Возвращаемое значение:
//  Результат запроса
//
Функция СформироватьЗапросПоРегистратору(МетаданныеДокумента) Экспорт 
	
	Запрос = Новый Запрос(СформироватьТекстЗапроса(МетаданныеДокумента));
	ЗАпрос.УстановитьПараметр("Регистратор", ДокументСсылка);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции // СформироватьЗапросПоРегистратору()
