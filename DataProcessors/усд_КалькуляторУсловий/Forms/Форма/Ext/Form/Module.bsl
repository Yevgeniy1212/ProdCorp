////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗаполнитьЗначенияСвойств(Объект,Параметры);
	мВидДокументов = Объект.ВидДокументов;
	мУсловие 		= Объект.Условие;
	УстановитьТип();
	НадписьПредметПроверки = "Предмет проверки";
	НадписьРезультатПроверки = "Результат проверки";
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура ВидДокументовПриИзменении(Элемент)
	Если мВидДокументов <> Объект.ВидДокументов Тогда
		УстановитьТип();
		Объект.Результат = Ложь;
		мВидДокументов 	= Объект.ВидДокументов;
		Объект.Условие 		= ПредопределенноеЗначение("Справочник.усд_УсловияВыполненияОперацийПоДокументам.ПустаяСсылка");
		мУсловие 		= Объект.Условие;
		Объект.Документ		= Элементы.Документ.ОграничениеТипа.ПривестиЗначение(Неопределено);
		Объект.ПроверкаПроведена = Ложь;
		мДокумент		= Объект.Документ;
		Объект.СоставныеЧастиУсловия.Очистить();
		Объект.Маршрут 		= ПредопределенноеЗначение("Справочник.усд_МаршрутыДвиженияДокументов.ПустаяСсылка");
		Объект.Этап 		= ПредопределенноеЗначение("Справочник.усд_ЭтапыМаршрутовДвиженияДокументов.ПустаяСсылка");
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДокументПриИзменении(Элемент)
	Если мДокумент <> Объект.Документ Тогда
		мДокумент		= Объект.Документ;
		Объект.Результат = Ложь;
		Объект.СоставныеЧастиУсловия.Очистить();
		Объект.Маршрут 		= ПредопределенноеЗначение("Справочник.усд_МаршрутыДвиженияДокументов.ПустаяСсылка");
		Объект.Этап 		= ПредопределенноеЗначение("Справочник.усд_ЭтапыМаршрутовДвиженияДокументов.ПустаяСсылка");
		Объект.ПроверкаПроведена = Ложь;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура УсловиеПриИзменении(Элемент)
	Если мУсловие <> Объект.ВидДокументов Тогда
		мУсловие 		= Объект.Условие;
		Объект.Результат = Ложь;
		Объект.СоставныеЧастиУсловия.Очистить();
		Объект.ПроверкаПроведена = Ложь;
	КонецЕсли;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура Проверка(Команда)
	Если ПроверитьЗаполнение() Тогда
		ПроверитьИсполнение();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Маршурт(Команда)
	Если ПроверитьЗаполнение() Тогда
		ПроверитьМаршрут();
	КонецЕсли;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура ПроверитьМаршрут()
	
	ОбъектНаСервере = РеквизитФормыВЗначение("Объект");
	ОбъектНаСервере.Маршрут = усд_УправлениеСогласованиемДокументов.НазначитьМаршрут(,ОбъектНаСервере.Документ);
	Если НЕ ЗначениеЗаполнено(ОбъектНаСервере.Маршрут) Тогда
		ЗначениеВРеквизитФормы(ОбъектНаСервере,"Объект");
		Возврат;
	КонецЕсли;
	СтруктураЭтапа = усд_ПроцедурыСогласованияДокументов.ПолучитьПервыйЭтап(ОбъектНаСервере.Маршрут,,ОбъектНаСервере.Документ);
	ОбъектНаСервере.Этап = ?(СтруктураЭтапа = Неопределено, Справочники.усд_ЭтапыМаршрутовДвиженияДокументов.ПустаяСсылка(), СтруктураЭтапа.Этап);
	ЗначениеВРеквизитФормы(ОбъектНаСервере, "Объект");
	
КонецПроцедуры

&НаСервере
Процедура УстановитьТип()
    Элементы.Документ.ОграничениеТипа = Новый ОписаниеТипов(?(НЕ ЗначениеЗаполнено(Объект.ВидДокументов),"Неопределено","ДокументСсылка."+Объект.ВидДокументов.ПрограммныйИдентификатор));
КонецПроцедуры

&НаСервере
Процедура ПроверитьИсполнение()
	ОбъектНаСервере = РеквизитФормыВЗначение("Объект");
	ТаблицаРез = ОбъектНаСервере.СоставныеЧастиУсловия.ВыгрузитьКолонки();
	ОбъектНаСервере.Результат = усд_ПроцедурыСогласованияДокументов.УсловиеВыполняется(ОбъектНаСервере.Условие,ОбъектНаСервере.Документ,ТаблицаРез,ОбъектНаСервере.Документ);
	ОбъектНаСервере.СоставныеЧастиУсловия.Очистить();
	ОбъектНаСервере.ПроверкаПроведена=Истина;
	Для Каждого Строка Из ТаблицаРез Цикл
		НоваяСтрока = ОбъектНаСервере.СоставныеЧастиУсловия.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,Строка);
	КонецЦикла;
	ЗначениеВРеквизитФормы(ОбъектНаСервере,"Объект");
КонецПроцедуры
