
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
    СхемаКомпоновкиДанных = ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	
	// ++ USRomanov@1cbit.ru 13.11.2020
	ЗаменитьВыраженияРесурсов(СхемаКомпоновкиДанных.ПоляИтога);
	// -- USRomanov@1cbit.ru 13.11.2020
	
	Настройки = КомпоновщикНастроек.ПолучитьНастройки();
	КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
	ПараметрыДанных = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы;
	
	ПараметрНачалоПериода = ПараметрыДанных.Найти("ДатаНачала").Значение;	
   
	Настройки = КомпоновщикНастроек.ПолучитьНастройки();
	ТекущГод = Год(ПараметрНачалоПериода);
	  
	Для Каждого Поле Из Настройки.Выбор.Элементы Цикл
						
		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ФактПредыдущийГод");
		Если Поле <> Неопределено Тогда
			
			Если Год(НачалоДня(Дата(ТекущГод-1,1,1))) = 2016
					ИЛИ Год(НачалоДня(Дата(ТекущГод-1,1,1))) = 2017 
					ИЛИ Год(НачалоДня(Дата(ТекущГод-1,1,1))) = 2018 Тогда
				Поле.Заголовок = "Факт "+Формат(ТекущГод-1,"ЧГ=0")+" года";
			Иначе
				Поле.Заголовок = "Факт "+Формат(ТекущГод-1,"ЧГ=0")+" года";
			КонецЕсли;

			Если ПараметрыДанных.Найти("Оценка").Значение = Истина Тогда
				Поле.Заголовок = "План " + Формат(ТекущГод-1,"ЧГ=0")+" года (корректировка, оценка)";
			КонецЕсли;
			
		КонецЕсли;

		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ФактПредшествующий");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "Факт " + Формат(ТекущГод-2,"ЧГ=0")+" года";
		КонецЕсли;
		
		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ФактТриГодаНазад");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "Факт " + Формат(ТекущГод-3,"ЧГ=0")+" года";
		КонецЕсли;
		
		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ПланПредыдущийГод");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод-1,"ЧГ=0")+" года";
			
			Если Год(НачалоДня(Дата(ТекущГод-1,1,1))) = 2019 Тогда

				Поле.Заголовок = "План " + Формат(ТекущГод-1,"ЧГ=0")+" года (корректировка, оценка)";
				
			КонецЕсли;
			
		КонецЕсли;

		Поле = СхемаКомпоновкиДанных.ВычисляемыеПоля.Найти("ПроцентОтклонение1");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод,"ЧГ=0")+ " года к факту "+ Формат(ТекущГод-1,"ЧГ=0") +" года, %";
			
			Если ПараметрыДанных.Найти("Оценка").Значение = Истина Тогда
				Поле.Заголовок = "План " + Формат(ТекущГод,"ЧГ=0")+ " года к плану "+ Формат(ТекущГод-1,"ЧГ=0") +" года (коррект), %";
			КонецЕсли;

		КонецЕсли;
		
		
		Поле = СхемаКомпоновкиДанных.ВычисляемыеПоля.Найти("ПроцентОтклонение2");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод,"ЧГ=0")+ " года к факту "+ Формат(ТекущГод-2,"ЧГ=0") +" года, %";
		КонецЕсли;
		
		Поле = СхемаКомпоновкиДанных.ВычисляемыеПоля.Найти("ПроцентОтклонение3");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод,"ЧГ=0")+ " года к факту "+ Формат(ТекущГод-3,"ЧГ=0") +" года, %";
		КонецЕсли;

		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("СуммаИтого");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод,"ЧГ=0")+" года";
		КонецЕсли;

		Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ФактКФактуПредыдущий");
		Если Поле <> Неопределено Тогда
			Поле.Заголовок = "План " + Формат(ТекущГод-1,"ЧГ=0")+ " года к факту "+ Формат(ТекущГод-2,"ЧГ=0") +" года, %";
		КонецЕсли;
		
	КонецЦикла;
	
	КомпоновщикНастроек.ЗагрузитьНастройки(Настройки);
	
             
    //Помещаем в переменную данные о расшифровке данных
    ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
     
    //Формируем макет, с помощью компоновщика макета
    КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
     
    //Передаем в макет компоновки схему, настройки и данные расшифровки
    МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
		
    //Выполним компоновку с помощью процессора компоновки
    ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
    //Передаем внешний набор данных
    ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, , ДанныеРасшифровки);
     
    //Очищаем поле табличного документа
	ДокументРезультат.Очистить();
	
	
	Макет = ПолучитьМакет("Макет");
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОбластьПодвал.Параметры.Руководитель = ОбщегоНазначения.ФамилияИнициалыФизЛица(Справочники.бит_ОтветственныеЛицаБюджет.РуководительОрганизации.Сотрудник.Физлицо);
	ОбластьПодвал.Параметры.РуководительДолжность = Справочники.бит_ОтветственныеЛицаБюджет.РуководительОрганизации.Должность;
	ОбластьПодвал.Параметры.РуководительФД = ОбщегоНазначения.ФамилияИнициалыФизЛица(Справочники.бит_ОтветственныеЛицаБюджет.РуководительФД.Сотрудник.Физлицо);
	ОбластьПодвал.Параметры.РуководительФДДолжность = Справочники.бит_ОтветственныеЛицаБюджет.РуководительФД.Должность;
	ОбластьПодвал.Параметры.Исполнитель = ОбщегоНазначения.ФамилияИнициалыФизЛица(Справочники.бит_ОтветственныеЛицаБюджет.Исполнитель.Сотрудник.Физлицо);
	ОбластьПодвал.Параметры.Телефон = Справочники.бит_ОтветственныеЛицаБюджет.Исполнитель.Комментарий;

	
	ОбластьШапка.Параметры.Год = Формат(ТекущГод, "ЧГ=0");
	ДокументРезультат.Вывести(ОбластьШапка);

    //Выводим результат в табличный документ
    ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
    ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
     
    ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);

	ДокументРезультат.Вывести(ОбластьПодвал);

КонецПроцедуры

// ++ USRomanov@1cbit.ru 13.11.2020
Процедура ЗаменитьВыраженияРесурсов(Ресурсы)
	
	Формула = "ВЫБОР КОГДА ФинансовыйПоказатель.КодСтрокиБюджета = ""1.1.3"" ТОГДА ВЫБОР КОГДА Вычислить(""Сумма(ВЫБОР КОГДА ФинансовыйПоказатель.КодСтрокиБюджета = """"1.1.1"""" ТОГДА %ПОЛЕ% ИНАЧЕ 0 КОНЕЦ)"", ""ОбщийИтог"") = 0 ТОГДА 0 ИНАЧЕ Вычислить(""Сумма(ВЫБОР КОГДА ФинансовыйПоказатель.КодСтрокиБюджета = """"1.1.2"""" ТОГДА %ПОЛЕ% ИНАЧЕ 0 КОНЕЦ)"", ""ОбщийИтог"") / Вычислить(""Сумма(ВЫБОР КОГДА ФинансовыйПоказатель.КодСтрокиБюджета = """"1.1.1"""" ТОГДА %ПОЛЕ% ИНАЧЕ 0 КОНЕЦ)"", ""ОбщийИтог"") * 100 КОНЕЦ ИНАЧЕ Сумма(%ПОЛЕ%) КОНЕЦ";
	ФормулаПроцент = "ВЫБОР КОГДА %ЗНАМЕНАТЕЛЬ% <> 0 ТОГДА %ЧИСЛИТЕЛЬ% / %ЗНАМЕНАТЕЛЬ% * 100 ИНАЧЕ 0 КОНЕЦ";
	
	РесурсыИсключения = Новый Массив;
	РесурсыИсключения.Добавить("ПроцентОтклонения1");
	РесурсыИсключения.Добавить("ПроцентОтклонения2");
	РесурсыИсключения.Добавить("ПроцентОтклонения3");
	РесурсыИсключения.Добавить("ПланКФактуПредыдущий");
	РесурсыИсключения.Добавить("ФактКФактуПредыдущий");
	
	Для Каждого Ресурс Из Ресурсы Цикл
		
		Если РесурсыИсключения.Найти(Ресурс.ПутьКДанным) = Неопределено Тогда 
			
			Ресурс.Выражение = СтрЗаменить(Формула, "%ПОЛЕ%", Ресурс.ПутьКДанным);
			
		Иначе 
			
			Если Ресурс.ПутьКДанным = "ПроцентОтклонения1" Тогда 
				
				Числитель = "СуммаИтого";
				Знаменатель = "ФактПредыдущийГод";
				
				Ресурс.Выражение = ФормулаПроцент;
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЧИСЛИТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Числитель));
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЗНАМЕНАТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Знаменатель));
				
			ИначеЕсли Ресурс.ПутьКДанным = "ПроцентОтклонения2" Тогда 
				
				Числитель = "СуммаИтого";
				Знаменатель = "ФактПредшествующий";
				
				Ресурс.Выражение = ФормулаПроцент;
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЧИСЛИТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Числитель));
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЗНАМЕНАТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Знаменатель));
				
			ИначеЕсли Ресурс.ПутьКДанным = "ПроцентОтклонения3" Тогда 
				
				Числитель = "СуммаИтого";
				Знаменатель = "ФактТриГодаНазад";
				
				Ресурс.Выражение = ФормулаПроцент;
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЧИСЛИТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Числитель));
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЗНАМЕНАТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Знаменатель));
				
			ИначеЕсли Ресурс.ПутьКДанным = "ПланКФактуПредыдущий" Тогда 
				
				Числитель = "ФактПредыдущийГод";
				Знаменатель = "ПланПредыдущийГод";
				
				Ресурс.Выражение = ФормулаПроцент;
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЧИСЛИТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Числитель));
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЗНАМЕНАТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Знаменатель));
				
			ИначеЕсли Ресурс.ПутьКДанным = "ФактКФактуПредыдущий" Тогда 
				
				Числитель = "ФактПредыдущийГод";
				Знаменатель = "ФактПредшествующий";
				
				Ресурс.Выражение = ФормулаПроцент;
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЧИСЛИТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Числитель));
				Ресурс.Выражение = СтрЗаменить(Ресурс.Выражение, "%ЗНАМЕНАТЕЛЬ%", СтрЗаменить(Формула, "%ПОЛЕ%", Знаменатель));
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры
// -- USRomanov@1cbit.ru 13.11.2020
