/////////////////////////////////////////
//
Функция ПолучитьСчетаБанка(ИсточникФинансирования) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ИсточникФинансирования", ИсточникФинансирования);
	
	Запрос.Текст=
	"ВЫБРАТЬ Различные
	|	ИФ.СчетУчета КАК СчетУчета
	|ИЗ
	|	Справочник.ИсточникиФинансирования.СчетаУчетаДС КАК ИФ
	|ГДЕ 
	|	ИФ.ссылка = &ИсточникФинансирования
	|Автоупорядочивание
	|";
	
	тз = Запрос.Выполнить().Выгрузить();
	
	Возврат тз;
КонецФункции

/////////////////////////////////////////
//

Функция ПолучитьСчетУчетаБанковскихДенежныхСредств(СчетБанк,ИсточникФинансирования) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ИсточникФинансирования", ИсточникФинансирования);
	Запрос.УстановитьПараметр("СчетБанка", СчетБанк);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""1"" КАК Приоритет,
	|	ИФ.СчетУчета КАК счетУчета
	|ИЗ
	|	Справочник.ИсточникиФинансирования.СчетаУчетаДС КАК ИФ
	|ГДЕ 
	|	ИФ.ссылка = &ИсточникФинансирования
	|	И ИФ.СчетУчета = &СчетБанка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|ВЫБРАТЬ
	|	""2"" КАК Приоритет,
	|	ИФ.ОсновнойСчетУчетаДС КАК счетУчета
	|ИЗ
	|	Справочник.ИсточникиФинансирования КАК ИФ
	|ГДЕ 
	|	ИФ.ссылка = &ИсточникФинансирования
	|Автоупорядочивание
	|";
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Результат.Следующий();
	
	Возврат Результат.СчетУчета;
КонецФункции


Функция НачалоВыборкаСпискаИсточниковФинансирования(мСписокИсточниковФинансирования, ПредставлениеСпискаИсточниковФинансирования, ЭлементФормы, СтандартнаяОбработка) Экспорт
	
	СтандартнаяОбработка = Ложь;
	
	ФормаВыбораИсточниковФинансирования = ПолучитьОбщуюФорму("ФормаВыбораИсточниковФинансирования", ЭлементФормы);
	ФормаВыбораИсточниковФинансирования.мСписокИсточниковФинансирования = мСписокИсточниковФинансирования;
	РезультатВыбора = ФормаВыбораИсточниковФинансирования.ОткрытьМодально();
	Если РезультатВыбора <> Неопределено Тогда
		мСписокИсточниковФинансирования = РезультатВыбора;
		ПредставлениеСпискаИсточниковФинансирования = работаСДиалогами.ВыгрузитьСписокВСтроку(мСписокИсточниковФинансирования);
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции // НачалоВыборкаСпискаИсточниковФинансирования

Процедура ОтборПоПлануСчетов(Элемент,ИсточникФинансирования) Экспорт
	
	Если Не ЗначениеЗаполнено(ИсточникФинансирования) Тогда
		Предупреждение("Не задан источник финансирования !!!");
		Возврат;
	КонецЕсли;
		
	ФормаВыбора = Планысчетов.Типовой.ПолучитьФормуВыбора(, Элемент, );
	
	ФормаВыбора.ПланСчетовСписок.Отбор.ТипСчета.Значение = ИсточникФинансирования.ТипСчета;
	ФормаВыбора.ПланСчетовСписок.Отбор.ТипСчета.Использование = Истина;
	
	ФормаВыбора.Открыть();

КонецПроцедуры

Процедура ОбработатьСозданиеАвизо(ЭтотОбъект,СтруктураШапкиДокумента)Экспорт
	
	Админ = Справочники.Пользователи.НайтиПоНаименованию("Администратор");
	
	Если глТекущийПользователь = СтруктураШапкиДокумента.Автор 
		ИЛИ глТекущийПользователь = Админ Тогда
		ТекОрганизация = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(?(глТекущийПользователь = Админ, Админ, СтруктураШапкиДокумента.Автор), "ОсновнаяОрганизация");
		Если ТекОрганизация = СтруктураШапкиДокумента.Организация Тогда
			Если Не ЗначениеЗаполнено(ЭтотОбъект.СвязанныйДокумент) Тогда
				
				Если Вопрос("Создать встречное Авизо?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
					Возврат;
				КонецЕсли;
								
				НовыйДокумент = Документы.АвизоПоПрочимОперациям.СоздатьДокумент();
			Иначе
				
				Если Вопрос("Изменить встречное Авизо?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
					Возврат;
				КонецЕсли;
				
				НовыйДокумент = ЭтотОбъект.СвязанныйДокумент.ПолучитьОбъект();
			КонецЕсли;
			
			НаборЗаписей = РегистрыСведений.СобственныеКонтрагенты.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Организация.Значение = СтруктураШапкиДокумента.Организация;
			НаборЗаписей.Отбор.Организация.Использование = Истина;
			НаборЗаписей.Прочитать();
			
			Если НаборЗаписей.Количество() > 0 Тогда
				КонтрагентОрганизации = НаборЗаписей[0].Контрагент;
			Иначе
				КонтрагентОрганизации = Справочники.Контрагенты.ПустаяСсылка();
			КонецЕсли;
			
			НаборЗаписей = РегистрыСведений.СобственныеКонтрагенты.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Контрагент.Значение = СтруктураШапкиДокумента.Контрагент;
			НаборЗаписей.Отбор.Контрагент.Использование = Истина;
			НаборЗаписей.Прочитать();
			
			Если НаборЗаписей.Количество() > 0 Тогда
				ОрганизацияКонтрагента = НаборЗаписей[0].Организация;
			Иначе
				ОрганизацияКонтрагента = Справочники.Организации.ПустаяСсылка();
			КонецЕсли;
			
			НовыйДокумент.Дата = ЭтотОбъект.Дата;
			НовыйДокумент.Организация = ОрганизацияКонтрагента;
			НовыйДокумент.ГоловнойКонтрагент = СтруктураШапкиДокумента.ГоловнойКонтрагент;
			НовыйДокумент.ИсточникФинансирования = СтруктураШапкиДокумента.ИсточникФинансирования;
			НовыйДокумент.СчетУчетаРасчетовСоСтруктурнымПодразделением = СтруктураШапкиДокумента.СчетУчетаРасчетовСоСтруктурнымПодразделением;
			Если ЭтотОбъект.ВидОперации = Перечисления.ВидыОперацийПоАвизо.Дебет Тогда
				Новыйдокумент.ВидОперации = Перечисления.ВидыОперацийПоАвизо.Кредит;
			ИначеЕсли ЭтотОбъект.ВидОперации = Перечисления.ВидыОперацийПоАвизо.Кредит Тогда
				Новыйдокумент.ВидОперации = Перечисления.ВидыОперацийПоАвизо.Дебет;
			КонецЕсли;
			НовыйДокумент.Контрагент = КонтрагентОрганизации;
			НовыйДокумент.ДоговорКонтрагента = СтруктураШапкиДокумента.ДоговорКонтрагента;
			НовыйДокумент.Автор = СтруктураШапкиДокумента.Автор;
			НовыйДокумент.Комментарий = СтруктураШапкиДокумента.Комментарий;
			
			НовыйДокумент.Корреспонденции.Очистить();
			
			тз = ЭтотОбъект.Корреспонденции.Выгрузить();
			НовыйДокумент.Корреспонденции.Загрузить(тз);
			НовыйДокумент.Записать();
			ЭтотОбъект.СвязанныйДокумент= НовыйДокумент.Ссылка;
			ЭтотОбъект.Записать();
			
			//Объект = НовыйДокумент.ссылка.ПолучитьОбъект();
			//Объект.Записать(РежимЗаписиДокумента.Проведение,РежимПроведенияДокумента.Неоперативный);
			Предупреждение("Сформировано встречное авизо для "+ОрганизацияКонтрагента+" Сохраните документ !!!!");
			
			Объект = НовыйДокумент.ссылка.ПолучитьФорму();
			Объект.Открыть();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Функция ПроверкаДоступностиСчета(глТекущийПользователь,Счет) Экспорт
	ВозвОтказ = ложь;
	
	Запрос = Новый запрос;
	
	Запрос.УстановитьПараметр("ТекПользователь",глТекущийПользователь);
	Запрос.УстановитьПараметр("Счет",Счет);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПраваПользователейНаДоступКБалансовымСчетам.Счет
	|ИЗ
	|	РегистрСведений.ПраваПользователейНаДоступКБалансовымСчетам КАК ПраваПользователейНаДоступКБалансовымСчетам
	|ГДЕ
	|	ПраваПользователейНаДоступКБалансовымСчетам.Пользователь = &ТекПользователь
	|	И ПраваПользователейНаДоступКБалансовымСчетам.Счет = &Счет";
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		ВозвОтказ = Истина;
	КонецЕсли;
	
	Возврат ВозвОтказ;
КонецФункции
