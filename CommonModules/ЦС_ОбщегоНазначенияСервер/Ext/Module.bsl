
Процедура ЗаполнитьРеквизитыПриСозданииНаСервере(ЭтаФорма, Объект) Экспорт
	
	Элементы = ЭтаФорма.Элементы;
	мУчетнаяПолитикаПоНалоговомуУчету = Неопределено;
    мУчетнаяПолитикаПоБухгалтерскомуУчету = Неопределено;
	
	ЭтаФорма.ОрганизацияПлательщикНалогаНаПрибыль = ПроцедурыНалоговогоУчета.ПолучитьПризнакПлательщикаНалогаНаПрибыль(Объект.Организация, Объект.Дата, мУчетнаяПолитикаПоНалоговомуУчету);
	ПроцедурыНалоговогоУчета.ПриИзмененииПризнакаОтраженияВНалоговомУчете(Объект.Организация, Объект.Дата, Объект.УчитыватьКПН,  мУчетнаяПолитикаПоНалоговомуУчету);	
	ЭтаФорма.ПоддержкаУчетаВременныхРазниц = ЭтаФорма.ОрганизацияПлательщикНалогаНаПрибыль и ПроцедурыНалоговогоУчета.ПоддержкаУчетаВременныхРазницПоНалогуНаПрибыль(Объект.Организация, Объект.Дата, мУчетнаяПолитикаПоБухгалтерскомуУчету);

КонецПроцедуры

// Функция вычисляет количество лет, месяцев и дней между двумя датами
//
// Параметры
//  ДатаПо
//  ДатаС 
//
Функция РазобратьРазностьДат(Дата1, Дата2) Экспорт
	
	Лет		= 0;
	Месяцев	= 0;
	Дней	= 0;
	Дата3 = Дата1 + 86400;
	Если Дата3 > Дата2 Тогда
		
		ВременнаяДата = Дата3;
		Если День(ВременнаяДата) < День(Дата2) Тогда
			Дней = (ВременнаяДата - ДобавитьМесяц(ВременнаяДата,-1))/86400;
			ВременнаяДата = ДобавитьМесяц(ВременнаяДата,-1);
		КонецЕсли;
		Если Месяц(ВременнаяДата) < Месяц(Дата2) Тогда
			ВременнаяДата = ДобавитьМесяц(ВременнаяДата,-12);
			Месяцев = 12;
		КонецЕсли;
		Лет		= Макс(			 Год(ВременнаяДата)		- Год(Дата2),	0);
		Месяцев	= Макс(Месяцев	+ Месяц(ВременнаяДата)	- Месяц(Дата2),	0);
		Дней	= Макс(Дней		+ День(ВременнаяДата)	- День(Дата2),	0);
		
		// скорректируем отображаемое значение, если "вмешалось" разное количество дней в месяцах
		Если Дата2 <> (ДобавитьМесяц(Дата3,-Лет*12-Месяцев)-Дней*86400) Тогда
			Дней = Дней + (День(КонецМесяца(Дата2)) - День(НачалоМесяца(Дата2))) - (День(КонецМесяца(ДобавитьМесяц(Дата3,-1))) - День(НачалоМесяца(ДобавитьМесяц(Дата3,-1))));
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Новый Структура("Лет, Месяцев, Дней", Лет, Месяцев, Дней);
	
КонецФункции   // РазобратьРазностьДат

Процедура ОтправитьПисьмоПоИзменениюЗаявок(бизнеспроцесс, Адресат, Задача) Экспорт

	Получатели = ПолучитьПолучателейПисемПоИзменениюЗаявок(Адресат);
	
	Если Получатели.количество() = 0 тогда 
		Возврат;
	КонецЕсли;
	
	ИПП						= Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP	= "10.110.1.21";
	ИПП.ПарольSMTP			= "zXC123321*";
	ИПП.Пароль				= "zXC123321*";
	ИПП.ПользовательSMTP	= "agent1c";
	ИПП.ПортSMTP 			= 25;
	ипп.АутентификацияSMTP	= СпособSMTPАутентификации.Login;
	
	Сообщение = Новый ИнтернетПочтовоеСообщение;
	Для Каждого Получатель из Получатели Цикл
		Сообщение.Получатели.Добавить(Получатель);
	КонецЦикла;
	
    Сообщение.Тема = "Новая задача по согласованию";
  	Сообщение.ИмяОтправителя = "Система оповещения 1С:Предприятия";	
	Сообщение.Тексты.Добавить(	"Поступила задача на согласование "
								+ Символы.ПС + "Этап: " + Задача.Наименование +
								+ Символы.ПС + "***************************************************************************************************"
								+ Символы.ПС + "№ " + БизнесПроцесс.номер +" от " + Формат(БизнесПроцесс.Дата, "ДФ=dd.MM.yyyy") + " автор " + БизнесПроцесс.Автор
								+ Символы.ПС + "***************************************************************************************************"
								+ Символы.ПС
								+ Символы.ПС + "Сообщение сформировано автоматически системой рассылки уведомлений из 1С:Предприятие");
								
								
	Попытка
		Почта = Новый ИнтернетПочта;
		Почта.Подключиться(ИПП);
		Почта.Послать(Сообщение);
	    Почта.Отключиться();
	Исключение
		Сообщить("У адресата " + Адресат + " не указан адрес электронной почты");
	КонецПопытки;
	
		
КонецПроцедуры

Процедура ОтправитьПисьмоПоКомандировкам(бизнеспроцесс, Адресат) Экспорт
	
	Получатели = ПолучитьПолучателейПисемПоИзменениюЗаявок(Адресат);
	
	Если Получатели.количество() = 0 тогда 
		Возврат;
	КонецЕсли;
	
	ИПП						= Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP	= "10.110.1.21";
	ИПП.ПарольSMTP			= "zXC123321*";
	ИПП.Пароль				= "zXC123321*";
	ИПП.ПользовательSMTP	= "agent1c";
	ИПП.ПортSMTP 			= 25;
	ипп.АутентификацияSMTP	= СпособSMTPАутентификации.Login;
	
	Сообщение = Новый ИнтернетПочтовоеСообщение;
	Для Каждого Получатель из Получатели Цикл
		Сообщение.Получатели.Добавить(Получатель);
	КонецЦикла;
	
    Сообщение.Тема = "Необходимо сдать расходные документы по командировке";
  	Сообщение.ИмяОтправителя = "Система оповещения 1С:Предприятия";	
	Сообщение.Тексты.Добавить(	"Необходимо сдать расходные документы по командировке "
								+ Символы.ПС + "***************************************************************************************************"
								//+ Символы.ПС + "№ " + БизнесПроцесс.номер +" от " + Формат(БизнесПроцесс.Дата, "ДФ=dd.MM.yyyy") + " автор " + БизнесПроцесс.Автор
								+ Символы.ПС + "***************************************************************************************************"
								+ Символы.ПС
								+ Символы.ПС + "Сообщение сформировано автоматически системой рассылки уведомлений из 1С:Предприятие");
	
	Почта = Новый ИнтернетПочта;
	Почта.Подключиться(ИПП);
	Почта.Послать(Сообщение);
    Почта.Отключиться();

КонецПроцедуры

Функция ПолучитьПолучателейПисемПоИзменениюЗаявок(Адресат)
	
	Массив = новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕСТЬNULL(КонтактнаяИнформация.Представление, """") КАК Мыло
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид
	|	И КонтактнаяИнформация.Объект = &Адресат
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЕСТЬNULL(КонтактнаяИнформация.Представление, """")
	|ИЗ
	|	РегистрСведений.ЦС_АдресацияБизнесПроцессов КАК ЦС_АдресацияБизнесПроцессов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|		ПО ЦС_АдресацияБизнесПроцессов.Пользователь = КонтактнаяИнформация.Объект
	|ГДЕ
	|	ЦС_АдресацияБизнесПроцессов.Подразделение = &Адресат
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = &Вид";
	
	Запрос.УстановитьПараметр("Адресат", Адресат);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	Запрос.УстановитьПараметр("Вид", справочники.ВидыКонтактнойИнформации.СлужебныйАдресЭлектроннойПочтыПользователя);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = Результат.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ВыборкаДетальныеЗаписи.Мыло = "" тогда 
			Продолжить;
		КонецЕсли;
		Массив.Добавить(ВыборкаДетальныеЗаписи.Мыло);
	КонецЦикла;
	
	Возврат Массив;	
	
КонецФункции

