
//--====== Отправка =======------- через CDO, Адрессаты через ";", СписокВложений - СписокЗначений с именами файлов
Процедура ПослатьПоПочте(ТемаСообщения, СписокУволенных) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ТекстСообщения = "";
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	АдресатыОтправкиНаEmail.Email
	|ИЗ
	|	РегистрСведений.АдресатыОтправкиНаEmail КАК АдресатыОтправкиНаEmail
	|ГДЕ
	|	АдресатыОтправкиНаEmail.РассылкаУволенных";
	Выборка = Запрос.Выполнить().Выбрать();
	
	Адрессаты = "";
			
	Пока Выборка.Следующий() Цикл
		
		Если Адрессаты = "" Тогда
			Адрессаты = Адрессаты + Выборка.Email;
		Иначе
			Адрессаты = Адрессаты +";" + Выборка.Email;
		КонецЕсли; 
				
	КонецЦикла;
	
	HTMLBody = "<html>
    |<head>
    |<meta content=""text/html; charset=Windows-1251"" http-equiv=""content-type"">
    |<title>" + ТемаСообщения + "</title>
    |</head>
    |<body>
	|<table border=""1"">
	|<caption>Информация по сотрудникам</caption>
	|<tr><th>Сотрудник</th>
	|<th>Дата увольнения</th></tr>";
	
	Для Каждого Строка Из СписокУволенных Цикл
		
		Если НЕ ПроверитьСотрудников(Строка.Физлицо) Тогда
		
			ТекстСообщения = "<td>" + Строка.Физлицо + "</td><td>" + Формат(Строка.ДатаУвольнения, "ДЛФ=DD")+"</td>"; 			
			HTMLBody = HTMLBody + "<tr>" + ТекстСообщения + "</tr>";   
			
		КонецЕсли;
		
	КонецЦикла;
		
	HTMLBody = HTMLBody +"</table><br><br>
	|<p>Сообщение сформировано автоматически системой рассылки уведомлений из 1С:Предприятие</p>
	|</body>
    |</html>";
	
	Если ТекстСообщения = "" Тогда
		Возврат;	
	КонецЕсли;
			
	Оправитель         = ""+СокрЛП(Константы.ПочтовыйЯщикРассылки.Получить());
	Пароль             = Константы.ПарольПочтовогоЯщикаРассылки.Получить();
	ТекстСообщения     = ТекстСообщения;

	loConfig         = Новый COMОбъект("CDO.Configuration");
	loCdoMessage     = Новый COMОбъект("CDO.Message");
	loCdoMessage.Configuration = loConfig;
	loCdoMessage.From    = Строка("Служба автоматической рассылки 1С <"+Оправитель+">");    
	loCdoMessage.To      = Адрессаты;                                                             
	loCdoMessage.Subject = ТемаСообщения;
	
    loCdoMessage.BodyPart.Charset = "utf-8"; // это если делать без извратов с оформлением текста письма
	loCdoMessage.HTMLBody = HTMLBody;
		
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/sendusing").Value = 2;
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/smtpserver").Value = Константы.ПочтовыйСервер.Получить();
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/smtpserverport").Value = Константы.ПортОтправкиСообщений.Получить();
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/smtpauthenticate").Value = 0; // 0 - Do not authenticate; 1 - basic (clear-text) authentication; 2 - NTLM 
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/sendusername").Value = Оправитель;
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/sendpassword").Value = Пароль;
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/smtpusessl").Value = False;
	loConfig.Fields.Item("http://schemas.microsoft.com/cdo/configuration/smtpconnectiontimeout").Value = 60;

	loConfig.Fields.Update();   
	Попытка
		loCdoMessage.Send();
		
		НаборЗаписей = РегистрыСведений.СписокУволеныхСотрудников.СоздатьНаборЗаписей();
		
		Для Каждого Строка Из СписокУволенных Цикл  			
			
			НаборЗаписей.Отбор.Сотрудник.Установить(Строка.ФизЛицо);
			НаборЗаписей.Прочитать();
			
			Для Каждого ЗаписьНабора Из НаборЗаписей Цикл
				ЗаписьНабора.УведомлениеОтправлено = Истина;	
			КонецЦикла;
			
			НаборЗаписей.Записать();
			
		КонецЦикла;
		
	Исключение
		//Сообщить(ОписаниеОшибки());         
	КонецПопытки;
	
	УстановитьПривилегированныйРежим(Ложь);

КонецПроцедуры

Функция ПроверитьСотрудников(Сотрудник)
	
	Результат = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СписокУволеныхСотрудников.Сотрудник,
	|	СписокУволеныхСотрудников.УведомлениеОтправлено
	|ИЗ
	|	РегистрСведений.СписокУволеныхСотрудников КАК СписокУволеныхСотрудников
	|ГДЕ
	|	СписокУволеныхСотрудников.Сотрудник = &Сотрудник";
	Запрос.УстановитьПараметр("Сотрудник", Сотрудник);
		
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.УведомлениеОтправлено;	
	Иначе
		
		НоваяЗапись = РегистрыСведений.СписокУволеныхСотрудников.СоздатьНаборЗаписей();
		НоваяЗапись.Отбор.Сотрудник.Установить(Сотрудник);
		СтрокаЗаписи = НоваяЗапись.Добавить();
		СтрокаЗаписи.Сотрудник = Сотрудник;
		
		НоваяЗапись.Записать();
		
	КонецЕсли;
	
	Возврат Результат;
			
КонецФункции

