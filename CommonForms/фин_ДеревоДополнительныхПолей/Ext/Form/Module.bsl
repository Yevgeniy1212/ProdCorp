
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Типы = Новый СписокЗначений;
	ОписаниеТипов = ПолучитьТипПоляГруппы(Параметры.Измерение);
    Типы.ЗагрузитьЗначения(ОписаниеТипов.Типы());
	мДерево = ДанныеФормыВЗначение(Дерево,Тип("ДеревоЗначений"));
	НС = мДерево.Строки.Добавить();
	НС.Поле = "Значение разреза";
	НС.Путь = Параметры.БазовыйПуть;
	Для Каждого ЭлементТип Из Типы Цикл
		Тип = ЭлементТип.Значение;
		ГруппаМетаданных = "";
		Если Справочники.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "Справочники";
		ИначеЕсли ПланыВидовРасчета.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "ПланыВидовРасчета";
		ИначеЕсли ПланыСчетов.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "ПланыСчетов";
		КонецЕсли;
		Если ЗначениеЗаполнено(ГруппаМетаданных) Тогда
			Для Каждого ОбъектМетаданных Из Метаданные[ГруппаМетаданных] Цикл
				Если Тип = Тип(СтрЗаменить(СтрЗаменить(ГруппаМетаданных,"Планы","План"),"Справочники","Справочник")+"Ссылка."+ОбъектМетаданных.Имя) Тогда
					Если НС.Строки.НайтиСтроки(Новый Структура("Путь","Код")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Код";
						СтрокаРеквизит.Путь = "Код";
					КонецЕсли;
					Если НС.Строки.НайтиСтроки(Новый Структура("Путь","Наименование")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Наименование";
						СтрокаРеквизит.Путь = "Наименование";
					КонецЕсли;
					Если (ГруппаМетаданных="ПланыСчетов" ИЛИ (ГруппаМетаданных="Справочники" И ОбъектМетаданных.Иерархический)) И НС.Строки.НайтиСтроки(Новый Структура("Путь","Родитель")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Родитель";
						СтрокаРеквизит.Путь = "Родитель";
					КонецЕсли;
					Для Каждого Реквизит Из ОбъектМетаданных.Реквизиты Цикл
						Если НС.Строки.НайтиСтроки(Новый Структура("Путь",Реквизит.Имя)).Количество()=0 И Найти(Реквизит.Имя,"Удалить")=0 Тогда
							СтрокаРеквизит = НС.Строки.Добавить();
							СтрокаРеквизит.Поле = Реквизит.Синоним;
							СтрокаРеквизит.Путь = Реквизит.Имя;
							ДобавитьВложенныеПоля(Реквизит,СтрокаРеквизит,Параметры.БазовыйПуть);
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	Если Параметры.Свойство("Группировки") Тогда
		Для Каждого ЭлементГруппировка Из Параметры.Группировки Цикл
			Если ЭлементГруппировка.Значение = Параметры.Измерение Тогда
				Продолжить;
			КонецЕсли;
			НовыйЭлементОформления = УсловноеОформление.Элементы.Добавить();
			НовыйЭлементОформления.Использование=Истина;
			ОтборЭлемент = НовыйЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ОтборЭлемент.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
			ОтборЭлемент.ПравоеЗначение = ЭлементГруппировка.Значение;
			ОтборЭлемент.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Список.Значение");
			ПолеОформления = НовыйЭлементОформления.Поля.Элементы.Добавить();
			ПолеОформления.Использование=Истина;
			ПолеОформления.Поле=Новый ПолеКомпоновкиДанных("СписокЗначение");
			НовыйЭлементОформления.Оформление.УстановитьЗначениеПараметра("Текст",?(ЗначениеЗаполнено(ЭлементГруппировка.Представление),ЭлементГруппировка.Представление,Строка(ЭлементГруппировка.Значение)));
			НС = мДерево.Строки.Добавить();
			НС.Поле = ?(ЗначениеЗаполнено(ЭлементГруппировка.Представление),ЭлементГруппировка.Представление,Строка(ЭлементГруппировка.Значение));
			НС.Путь = ЭлементГруппировка.Значение;
			ТипПоля = Параметры.ТипыГруппировок.Получить(ЭлементГруппировка.Значение);
			ИмяПоля = ?(ТипЗнч(ЭлементГруппировка.Значение)=Тип("СправочникСсылка.фин_ДополнительныеРазрезыОтчетовПоБюджетам"),ЭлементГруппировка.Значение.Путь,?(ТипЗнч(ЭлементГруппировка.Значение)=Тип("СправочникСсылка.фин_ПоляПользовательскихОтчетов"),ЭлементГруппировка.Значение.Владелец.ПоляОтчета.НайтиСтроки(Новый Структура("Поле",ЭлементГруппировка.Значение))[0].ИмяПоля,фин_ОбщегоНазначенияСервер.ПолучитьИмяЭлементаПеречисленияПоЗначению(ЭлементГруппировка.Значение)));
			Если ТипПоля<>Неопределено Тогда
				Для Каждого ЭлементТип Из ТипПоля.Типы() Цикл
					Тип = ЭлементТип;
					ГруппаМетаданных = "";
					Если Справочники.ТипВсеСсылки().СодержитТип(Тип) Тогда
						ГруппаМетаданных = "Справочники";
					ИначеЕсли ПланыВидовРасчета.ТипВсеСсылки().СодержитТип(Тип) Тогда
						ГруппаМетаданных = "ПланыВидовРасчета";
					ИначеЕсли ПланыСчетов.ТипВсеСсылки().СодержитТип(Тип) Тогда
						ГруппаМетаданных = "ПланыСчетов";
					КонецЕсли;
					Если ЗначениеЗаполнено(ГруппаМетаданных) Тогда
						Для Каждого ОбъектМетаданных Из Метаданные[ГруппаМетаданных] Цикл
							Если Тип = Тип(СтрЗаменить(СтрЗаменить(ГруппаМетаданных,"Планы","План"),"Справочники","Справочник")+"Ссылка."+ОбъектМетаданных.Имя) Тогда
								Если НС.Строки.НайтиСтроки(Новый Структура("Путь",ИмяПоля+".Код")).Количество()=0 Тогда
									СтрокаРеквизит = НС.Строки.Добавить();
									СтрокаРеквизит.Поле = "Код";
									СтрокаРеквизит.Путь = ИмяПоля+".Код";
								КонецЕсли;
								Если НС.Строки.НайтиСтроки(Новый Структура("Путь",ИмяПоля+".Наименование")).Количество()=0 Тогда
									СтрокаРеквизит = НС.Строки.Добавить();
									СтрокаРеквизит.Поле = "Наименование";
									СтрокаРеквизит.Путь = ИмяПоля+".Наименование";
								КонецЕсли;
								Если (ГруппаМетаданных="ПланыСчетов" ИЛИ (ГруппаМетаданных="Справочники" И ОбъектМетаданных.Иерархический)) И НС.Строки.НайтиСтроки(Новый Структура("Путь",ИмяПоля+".Родитель")).Количество()=0 Тогда
									СтрокаРеквизит = НС.Строки.Добавить();
									СтрокаРеквизит.Поле = "Родитель";
									СтрокаРеквизит.Путь = ИмяПоля+".Родитель";
								КонецЕсли;
								Для Каждого Реквизит Из ОбъектМетаданных.Реквизиты Цикл
									Если НС.Строки.НайтиСтроки(Новый Структура("Путь",ИмяПоля+"."+Реквизит.Имя)).Количество()=0 И Найти(Реквизит.Имя,"Удалить")=0 Тогда
										СтрокаРеквизит = НС.Строки.Добавить();
										СтрокаРеквизит.Путь = ИмяПоля+"."+Реквизит.Имя;
										СтрокаРеквизит.Поле = Реквизит.Синоним;
										ДобавитьВложенныеПоля(Реквизит,СтрокаРеквизит);
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						КонецЦикла;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	ЗначениеВДанныеФормы(мДерево,Дерево);
КонецПроцедуры

&НаСервере
Процедура ДобавитьВложенныеПоля(Реквизит,НС,РодительскоеПоле = Неопределено)
	Для Каждого Тип Из Реквизит.Тип.Типы() Цикл
		ГруппаМетаданных = "";
		Если Справочники.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "Справочники";
		ИначеЕсли ПланыВидовРасчета.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "ПланыВидовРасчета";
		ИначеЕсли ПланыСчетов.ТипВсеСсылки().СодержитТип(Тип) Тогда
			ГруппаМетаданных = "ПланыСчетов";
		КонецЕсли;
		Если ЗначениеЗаполнено(ГруппаМетаданных) Тогда
			Для Каждого ОбъектМетаданных Из Метаданные[ГруппаМетаданных] Цикл
				Если Тип = Тип(СтрЗаменить(СтрЗаменить(ГруппаМетаданных,"Планы","План"),"Справочники","Справочник")+"Ссылка."+ОбъектМетаданных.Имя) Тогда
					Если НС.Строки.НайтиСтроки(Новый Структура("Путь","Код")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Код";
						СтрокаРеквизит.Путь = ?(РодительскоеПоле=Неопределено,"",РодительскоеПоле+".")+НС.Путь+"."+"Код";
					КонецЕсли;
					Если НС.Строки.НайтиСтроки(Новый Структура("Путь","Наименование")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Наименование";
						СтрокаРеквизит.Путь = ?(РодительскоеПоле=Неопределено,"",РодительскоеПоле+".")+НС.Путь+"."+"Наименование";
					КонецЕсли;
					Если (ГруппаМетаданных="ПланыСчетов" ИЛИ (ГруппаМетаданных="Справочники" И ОбъектМетаданных.Иерархический)) И НС.Строки.НайтиСтроки(Новый Структура("Путь","Родитель")).Количество()=0 Тогда
						СтрокаРеквизит = НС.Строки.Добавить();
						СтрокаРеквизит.Поле = "Родитель";
						СтрокаРеквизит.Путь = ?(РодительскоеПоле=Неопределено,"",РодительскоеПоле+".")+НС.Путь+"."+"Родитель";
					КонецЕсли;
					Для Каждого Реквизит Из ОбъектМетаданных.Реквизиты Цикл
						Если НС.Строки.НайтиСтроки(Новый Структура("Путь",Реквизит.Имя)).Количество()=0 И Найти(Реквизит.Имя,"Удалить")=0 Тогда
							СтрокаРеквизит = НС.Строки.Добавить();
							СтрокаРеквизит.Поле = Реквизит.Синоним;
							СтрокаРеквизит.Путь = ?(РодительскоеПоле=Неопределено,"",РодительскоеПоле+".")+НС.Путь+"."+Реквизит.Имя;
	//						ДобавитьВложенныеПоля(Реквизит,СтрокаРеквизит);
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьТипПоляГруппы(Измерение)
	ТипПоля = фин_ОбщегоНазначенияВызовСервераПовтИсп.ТипЗначенияГруппировки(Параметры.Измерение);
	ОписаниеТипов = фин_УправлениеОтчетамиБюджетирование.ОписаниеТипаДляОтбора(ТипПоля);
	Возврат ОписаниеТипов;
КонецФункции

&НаКлиенте
Процедура Выбрать(Команда)
	Если Элементы.Дерево.ТекущиеДанные<>Неопределено Тогда
		Закрыть(Элементы.Дерево.ТекущиеДанные.Путь);
	КонецЕсли;
КонецПроцедуры
