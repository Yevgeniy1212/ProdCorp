
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПриОткрытииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПриОткрытииНаСервере()
	Если НЕ Объект.Ссылка.Пустая() Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	КоэффициентыПересчетаЕдиницИзмерения.Номенклатура,
			|	КоэффициентыПересчетаЕдиницИзмерения.РезультирующаяЕдиницаИзмерения,
			|	КоэффициентыПересчетаЕдиницИзмерения.КоэффициентПересчета
			|ИЗ
			|	РегистрСведений.узп_КоэффициентыПересчетаЕдиницИзмерения КАК КоэффициентыПересчетаЕдиницИзмерения
			|ГДЕ
			|	КоэффициентыПересчетаЕдиницИзмерения.ИсходнаяЕдиницаИзмерения = &ИсходнаяЕдиницаИзмерения";
		Запрос.УстановитьПараметр("ИсходнаяЕдиницаИзмерения", Объект.Ссылка);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			НС = ПересчетВДругие.Добавить();
			ЗаполнитьЗначенияСвойств(НС,Выборка);
		КонецЦикла;
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	КоэффициентыПересчетаЕдиницИзмерения.Номенклатура,
			|	КоэффициентыПересчетаЕдиницИзмерения.ИсходнаяЕдиницаИзмерения,
			|	КоэффициентыПересчетаЕдиницИзмерения.КоэффициентПересчета
			|ИЗ
			|	РегистрСведений.узп_КоэффициентыПересчетаЕдиницИзмерения КАК КоэффициентыПересчетаЕдиницИзмерения
			|ГДЕ
			|	КоэффициентыПересчетаЕдиницИзмерения.РезультирующаяЕдиницаИзмерения = &ИсходнаяЕдиницаИзмерения";
		Запрос.УстановитьПараметр("ИсходнаяЕдиницаИзмерения", Объект.Ссылка);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			НС = ПересчетИзДругих.Добавить();
			ЗаполнитьЗначенияСвойств(НС,Выборка);
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	Для Каждого СтрокаПересчет Из ПересчетВДругие Цикл
		Если СтрокаПересчет.РезультирующаяЕдиницаИзмерения.Пустая() Тогда
			Сообщить("В строке №"+Строка(СтрокаПересчет.НомерСтроки)+" поля ""Пересчет в другие единицы измерения"" не выбрана результирующая единица измерения!",СтатусСообщения.Важное);
			Отказ = Истина;
		ИначеЕсли СтрокаПересчет.КоэффициентПересчета=0 Тогда
			Сообщить("В строке №"+Строка(СтрокаПересчет.НомерСтроки)+" поля ""Пересчет в другие единицы измерения"" не указан коэффициент пересчета!",СтатусСообщения.Важное);
			Отказ = Истина;
		КонецЕсли;
	КонецЦикла;
	Для Каждого СтрокаПересчет Из ПересчетИзДругих Цикл
		Если СтрокаПересчет.ИсходнаяЕдиницаИзмерения.Пустая() Тогда
			Сообщить("В строке №"+Строка(СтрокаПересчет.НомерСтроки)+" поля ""Пересчет из других единицы измерения"" не выбрана исходная единица измерения!",СтатусСообщения.Важное);
			Отказ = Истина;
		ИначеЕсли СтрокаПересчет.КоэффициентПересчета=0 Тогда
			Сообщить("В строке №"+Строка(СтрокаПересчет.НомерСтроки)+" поля ""Пересчет из других единицы измерения"" не указан коэффициент пересчета!",СтатусСообщения.Важное);
			Отказ = Истина;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("Код") Тогда
		Объект.Код = Параметры.Код;
	КонецЕсли;
	Если Параметры.Свойство("Наименование") Тогда
		Объект.Наименование = Параметры.Наименование;
	КонецЕсли;
	Если Параметры.Свойство("НаименованиеПолное") Тогда
		Объект.НаименованиеПолное = Параметры.НаименованиеПолное;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	НаборЗаписей = РегистрыСведений.узп_КоэффициентыПересчетаЕдиницИзмерения.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ИсходнаяЕдиницаИзмерения.Установить(Объект.Ссылка);
	НаборЗаписей.Очистить();
	Для Каждого СтрокаПересчет Из ПересчетВДругие Цикл
		НЗ = НаборЗаписей.Добавить();
		ЗаполнитьЗначенияСвойств(НЗ,СтрокаПересчет);
		НЗ.ИсходнаяЕдиницаИзмерения = Объект.Ссылка;
	КонецЦикла;
	Попытка
		НаборЗаписей.Записать();
	Исключение
		Сообщить("Не удалось записать коэффициенты пересчета в другие единицы измерения по причине: "+ОписаниеОшибки());
		Отказ = Истина;
		Возврат;
	КонецПопытки;
	НаборЗаписей = РегистрыСведений.узп_КоэффициентыПересчетаЕдиницИзмерения.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.РезультирующаяЕдиницаИзмерения.Установить(Объект.Ссылка);
	НаборЗаписей.Очистить();
	Для Каждого СтрокаПересчет Из ПересчетИзДругих Цикл
		НЗ = НаборЗаписей.Добавить();
		ЗаполнитьЗначенияСвойств(НЗ,СтрокаПересчет);
		НЗ.РезультирующаяЕдиницаИзмерения = Объект.Ссылка;
	КонецЦикла;
	Попытка
		НаборЗаписей.Записать();
	Исключение
		Сообщить("Не уадлось записать коэффициенты пересчета из других единиц измерения по причине: "+ОписаниеОшибки());
		Отказ = Истина;
	КонецПопытки;
		

КонецПроцедуры
