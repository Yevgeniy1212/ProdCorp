////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ
//

Перем мСообщатьОбОшибках Экспорт; // определяет необходимость выдавать сообщения о ошибках пользователю

////////////////////////////////////////////////////////////////////////////////
// ОБЩИЕ ПРОЦЕДУРЫ И ФУНКЦИИ

// Процедура выводит текст сообщения о ошибке в зависимости от переменной мСообщатьОбОшибках
//
Процедура ОшибкаПриЗаписи(ТекстСообщения, Статус = Неопределено)

	Если мСообщатьОбОшибках = Истина Тогда
	
		ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения, Истина, "", Статус);
		
	КонецЕсли;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

// Процедура вызывается перед записью элемента справочника.
//
Процедура ПередЗаписью(Отказ)

	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;

	Если Не ЭтоНовый() и не ПометкаУдаления=Ссылка.ПометкаУдаления тогда
		//В случае установки или снятия пометки удаления не производить проверку
		Возврат;
	КонецЕсли;

	Если ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоРасчетнымДокументам Тогда
		ОшибкаПриЗаписи("Расчеты по договору в разрезе документов в данной версии не поддерживаются.", СтатусСообщения.Важное);
		Отказ = Истина;
	КонецЕсли; 
	
	// Проверим можно ли изменять реквизиты договора.
	// Проверка осуществляется только если записывается уже существующий договор
	Если НЕ ЭтоНовый() Тогда

		Если ЭтоГруппа Тогда

			// Для группы владельца менять нельзя
			Если Владелец <> Ссылка.Владелец Тогда
				ОшибкаПриЗаписи("Нельзя изменять контрагента для группы договоров.", СтатусСообщения.Важное);
				Отказ = Истина;
			КонецЕсли; 

		Иначе

			// Проверим Заполнение обязательных реквизитов "Организация"
			Если НЕ ЗначениеЗаполнено(Организация) Тогда
				ОшибкаПриЗаписи("Для договора """ + Наименование + """ не указана организация.
							 |Элемент не записан.", 
							 СтатусСообщения.Важное);
				Отказ = Истина;
			КонецЕсли;

			// Проверим возможность смены владельца для договора
			Если Владелец <> Ссылка.Владелец Тогда

				Если КритерииОтбора.ДокументыПоДоговоруКонтрагента.Найти(Ссылка).Количество() > 0 Тогда

					ОшибкаПриЗаписи("Существуют документы, оформленные по договору """ + Наименование + """.
							 |Контрагент договора не может быть изменен, элемент не записан.", 
							 СтатусСообщения.Важное);
					Отказ = Истина;

				КонецЕсли;

			КонецЕсли;

			// Проверим возможность смены способа ведения взаиморасчетов и валюты взаиморасчетов
			//Если ВедениеВзаиморасчетов <> Ссылка.ВедениеВзаиморасчетов
			// ИЛИ ВалютаВзаиморасчетов <> Ссылка.ВалютаВзаиморасчетов 
			// ИЛИ ВидДоговора <> Ссылка.ВидДоговора
			// ИЛИ Организация <> Ссылка.Организация Тогда
			//	МассивДокументов = КритерииОтбора.ДокументыПоДоговоруКонтрагента.Найти(Ссылка);
			//	ЕстьПроведенныеДокументы = Ложь;

			//	Для каждого Документ из МассивДокументов Цикл

			//		ЕстьПроведенныеДокументы = Документ.Проведен;

			//		Если ЕстьПроведенныеДокументы тогда
			//			Прервать;
			//		КонецЕсли;

			//	КонецЦикла;

			//	Если ЕстьПроведенныеДокументы Тогда
			//		ОшибкаПриЗаписи("Существуют документы, проведенные по договору """ + Наименование + """.
			//					 |Реквизиты ""Организация"", ""Ведение взаиморасчетов"", ""Валюта взаиморасчетов"", ""Вид договора"" не могут быть изменены.
			//					 |Элемент не записан.", 
			//					 СтатусСообщения.Важное);
			//		Отказ = Истина;

			//	КонецЕсли;

			//КонецЕсли;

		КонецЕсли; // Если ЭтоГруппа Тогда

	КонецЕсли; // Если НЕ ЭтоНовый() Тогда

	// Проверим заполнение обязательных реквизитов.
	Если Не ЭтоГруппа Тогда
		
		// Проверим Заполнение обязательных реквизитов "Организация"
		Если НЕ ЗначениеЗаполнено(Организация) Тогда
			ОшибкаПриЗаписи("Не указана организация для договора.", СтатусСообщения.Важное);
			Отказ = Истина;
		КонецЕсли; 
		
		// Проверим, заполнена ли валюта
		Если НЕ ЗначениеЗаполнено(ВалютаВзаиморасчетов) Тогда
			ОшибкаПриЗаписи("Не указана валюта договора ", СтатусСообщения.Важное);
			Отказ = Истина;
		КонецЕсли;
		
		// Проверим, заполнен ли вид договора
		Если НЕ ЗначениеЗаполнено(ВидДоговора) Тогда
			ОшибкаПриЗаписи("Не указан вид договора ", СтатусСообщения.Важное);
			Отказ = Истина;
		КонецЕсли;
		
		Если НЕ ЭтоНовый() Тогда
			// Проверим, 
			Если НЕ ЗначениеЗаполнено(ДатаДоговора) Тогда
				ОшибкаПриЗаписи("Не указана дата договора ", СтатусСообщения.Важное);
				Отказ = Истина;
			КонецЕсли;
			
			// Проверим, 
			Если НЕ ЗначениеЗаполнено(ДатаОкончанияДействияДоговора) Тогда
				ОшибкаПриЗаписи("Не указана дата окончания договора ", СтатусСообщения.Важное);
				Отказ = Истина;
			КонецЕсли;
		Иначе
			Если ВидДоговора <> Перечисления.ВидыДоговоровКонтрагентов.Займа Тогда
				// Проверим, 
				Если НЕ ЗначениеЗаполнено(ДатаДоговора) Тогда
					ОшибкаПриЗаписи("Не указана дата договора ", СтатусСообщения.Важное);
					Отказ = Истина;
				КонецЕсли;
				
				// Проверим, 
				Если НЕ ЗначениеЗаполнено(ДатаОкончанияДействияДоговора) Тогда
					ОшибкаПриЗаписи("Не указана дата окончания договора ", СтатусСообщения.Важное);
					Отказ = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры // ПередЗаписью()

//////////////////////////////////////////////////////////////////////////////// 
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ 

мСообщатьОбОшибках = Истина; // по умолчанию считаем, что сообщения выдаются всегда